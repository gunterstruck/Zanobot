{"version":3,"mappings":"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","names":["CONFIG_PATH","THEME_STORAGE_KEY","DEFAULT_THEME","AVAILABLE_THEMES","VIEW_LEVEL_STORAGE_KEY","DEFAULT_VIEW_LEVEL","AVAILABLE_VIEW_LEVELS","getStoredTheme","e","getStoredViewLevel","level","applyTheme","theme","applyViewLevel","loadConfig","response","config","appleBrandColors","error","colors","root","initTheme","viewLevel","currentTheme","nextIndex","ToastManager","__publicField","container","options","toastId","queued","id","toast","position","_","icon","titleHTML","messageHTML","closeButton","closeBtn","type","icons","text","div","message","title","duration","NotificationManager","logger","fullMessage","notify","isIOS","HardwareCheck","label","sampleRate","report","lowerLabel","foundKeyword","keyword","stream","audioInputs","device","track","tracks","deviceId","audioTracks","audioOnlyStream","errorMessage","errorName","iosStream","AUDIO_CONSTRAINTS","buildAudioConstraints","AUDIO_CONSTRAINTS_FALLBACK","DEFAULT_SMART_START_CONFIG","getRawAudioStream","fallbackConstraints","constraints","fallbackError","getSmartStartStatusMessage","state","IdentifyPhase","onMachineSelected","scanBtn","createBtn","closeScannerBtn","manualInputBtn","manualInputConfirmBtn","manualInputCancelBtn","manualInputCloseBtn","manualInputModal","changeMicBtn","errorDiv","successDiv","scannerContainer","Html5Qrcode","isErrorObject","decodedText","decodedResult","code","trimmedCode","validation","hint","errorHint","successMessage","AudioContextClass","audioContext","oscillator","gainNode","manualInput","machine","getMachine","autoName","newMachine","saveMachine","nameInput","idInput","name","idInputValue","timestamp","random","trimmedId","tempStream","bestMic","currentDevice","statusIcon","deviceLabel","statusText","devices","modal","deviceList","deviceItem","isSelected","estimatedSampleRate","tempReport","statusClass","deviceInfo","deviceIcon","deviceDetails","deviceName","deviceStatus","checkmark","trainedMachines","getAllMachines","a","b","aLatestDate","m","machines","quickSelectSection","quickSelectList","machineItem","machineInfo","machineName","machineId","chevron","polyline","VISUALIZER_SETTINGS_EVENT","STORAGE_KEY","defaultSettings","readFromStorage","raw","parsed","getVisualizerSettings","setVisualizerSettings","updates","current","next","AudioVisualizer","canvasId","canvas","ctx","event","detail","dpr","rect","bufferLength","width","height","bgColor","gridColor","i","y","marker","x","barWidth","normalizedValue","barHeight","color","points","xc","yc","lastPoint","computedStyle","fillTop","fillBottom","vizPrimary","gradient","intensity","primaryColor","accentColor","rgb","hex","maxFreq","isLogScale","formatFreq","freq","labels","minFreq","logMin","logMax","clamped","textColor","fontFamily","amplitudeLabel","audioBuffer","channelData","step","index","value","barIndex","start","end","sum","count","totalBins","maxBinIndex","binStep","ratioStart","ratioEnd","startFreq","endFreq","AudioWorkletManager","mediaStream","workletUrl","chunk","chunkSize","readPos","AudioContextConstructor","isAudioWorkletSupported","BUTTON_TEXT","MODAL_TITLE","ReferencePhase","selectedDeviceId","callback","recordBtn","cameraError","actualSampleRate","bufferSize","statusMsg","rms","mimeType","mediaRecorderOptions","recordingDuration","snapshotDelay","video","blob","videoContainer","blobOptions","arrayBuffer","warmupSamples","trainingSamples","MIN_TRAINING_DURATION","minTrainingSamples","trainingBuffer","channel","originalData","trainingData","dspConfig","DEFAULT_DSP_CONFIG","features","extractFeatures","qualityResult","assessRecordingQuality","f","extension","filename","url","statusElement","modalTitle","machineIdElement","modalBody","existingModels","existingModelsInfo","trainingDate","infoDiv","visualizerContainer","statusDiv","stopBtn","videoHint","elapsed","timerElement","totalDuration","warmupPhase","remaining","recordingElapsed","recordingTotal","minutes","seconds","audioElement","audioSource","audioUrl","imageContainer","imageElement","discardBtn","saveBtn","scoreElement","ratingElement","iconElement","issuesContainer","issuesList","issue","li","magnitude","userLabel","model","trainGMIA","numSamplesToTest","testScores","featureIndex","testFeature","diagnosis","classifyDiagnosticState","baselineScore","s","MIN_BASELINE_SCORE","updateMachineModel","n","getMachine2","machineToUpdate","__vitePreload","updatedMachine","statusContainer","parentContainer","stateList","models","dateStr","labelSpan","dateSpan","trainAnotherBtn","recordingModal","recordingContent","header","body","footer","instruction","waveformCanvas","gaugeCanvas","modalContent","HealthGauge","styles","mutations","mutation","score","status","animate","targetScore","startScore","diff","startTime","progress","eased","centerX","centerY","radius","endScore","lineWidth","startAngle","endAngle","totalAngle","DiagnosePhase","ScoreHistory","LabelHistory","diagnoseBtn","latestMachine","expectedSampleRate","uniqueRates","rateList","element","processingChunk","featureVector","extractFeaturesFromChunk","detectedState","filteredScore","filteredStatus","classifyHealthStatus","debug","enhancedMessage","v","updateElement","highlight","el","scoreValue","scoreDisplay","MIN_CONFIDENT_MATCH_SCORE","hadValidMeasurement","finalScore","finalStatus","scoreHistoryCopy","finalDetectedState","labelHistoryCopy","scoreHistory","classification","getClassificationDetails","effectiveDetectedState","randomSuffix","validStatus","saveDiagnosis","refModelInfo","liveDisplay","ghostContainer","ghostImage","imageUrl","ghostHint","machineBarcode","resultStatus","resultConfidence","analysisHint","DETECTION_MODE_KEY","getDetectionMode","stored","setDetectionMode","mode","DETECTION_MODES","DetectionModeManager","oldMode","newMode","modeManagerInstance","getDetectionModeManager","ModeSelector","containerId","currentMode","radio","card","check","infoElement","injectModeSelectorStyles","style","SettingsPhase","exportBtn","importBtn","clearBtn","statsBtn","modeManager","infoSection","badge","badgeMode","freqToggle","ampToggle","settings","data","exportData","jsonString","input","file","merge","importData","stats","clearAllData","getDBStats","machinesCount","recordingsCount","diagnosesCount","Level2ReferencePhase","Level2Detector","ref","backendInfo","info","cameraContainer","videoElement","timerValue","interval","reference","fill","ms","resolve","Level2DiagnosePhase","MelSpectrogramGenerator","result","render","dataArray","normalized","maxColumns","elapsedElement","columnWidth","numColumns","col","column","row","rowHeight","lineX","statusMap","percentage","trafficLight","redLight","yellowLight","greenLight","light","healthElement","spectrogram","similarity","time","_progress","_message","Router","level1Contents","level2Contents","sectionId","enabled","section","btn","userName","recordSection","description","latestTimestamp","latestDate","diagnoseSection","content","defaultConfig","ErrorBoundary","errorInfo","handlerError","details","errorBoundary","initErrorBoundary","VIEW_LEVEL_EVENT","defaultLevel","validLevels","setViewLevel","ZanobotApp","resolved","handler","missing","compatibility","feature","dbAvailable","initDB","headers","isAnimating","updateCompactExpandedState","hasOpenSection","target","otherHeader","otherTarget","otherContent","otherIcon","originalDisplay","themeBtns","savedTheme","quickToggleBtns","legacyToggleBtn","savedLevel","viewLevelBtns","closeModal","openModal","impressumBtn","impressumModal","closeImpressumModal","closeImpressumBtn","datenschutzBtn","datenschutzModal","closeDatenschutzModal","closeDatenschutzBtn","aboutBtn","aboutModal","closeAboutModal","closeAboutBtn"],"ignoreList":[],"sources":["../../src/theme-bootstrap.js","../../src/ui/components/Toast.ts","../../src/utils/notifications.ts","../../src/utils/platform.ts","../../src/core/audio/HardwareCheck.ts","../../src/core/audio/audioHelper.ts","../../src/ui/phases/1-Identify.ts","../../src/utils/visualizerSettings.ts","../../src/ui/components/AudioVisualizer.ts","../../src/core/audio/audioWorkletHelper.ts","../../src/ui/constants.ts","../../src/ui/phases/2-Reference.ts","../../src/ui/components/HealthGauge.ts","../../src/ui/phases/3-Diagnose.ts","../../src/core/detection-mode.ts","../../src/ui/components/ModeSelector.ts","../../src/ui/phases/4-Settings.ts","../../src/ui/phases/Level2-Reference.ts","../../src/ui/phases/Level2-Diagnose.ts","../../src/ui/router.ts","../../src/utils/errorBoundary.ts","../../src/utils/viewLevelSettings.ts","../../src/main.ts"],"sourcesContent":["/**\n * ZANOBOT THEME BOOTSTRAP\n * Loads and applies theme configuration before page render\n * This script runs synchronously in <head> to prevent FOUC (Flash of Unstyled Content)\n */\n\n(function() {\n    'use strict';\n\n    // Configuration\n    // Use relative path that works both locally and on GitHub Pages\n    const CONFIG_PATH = './config.json';\n    const THEME_STORAGE_KEY = 'zanobot-theme';\n    const DEFAULT_THEME = 'neon'; // Neon Industrial is the default (as per UX requirements)\n    const AVAILABLE_THEMES = ['neon', 'light', 'brand'];\n\n    // View Level Configuration\n    const VIEW_LEVEL_STORAGE_KEY = 'zanobot.view-level';\n    const DEFAULT_VIEW_LEVEL = 'basic';\n    const AVAILABLE_VIEW_LEVELS = ['basic', 'advanced', 'expert'];\n\n    /**\n     * Get stored theme preference or default\n     */\n    function getStoredTheme() {\n        try {\n            return localStorage.getItem(THEME_STORAGE_KEY) || DEFAULT_THEME;\n        } catch (e) {\n            console.warn('localStorage not available:', e);\n            return DEFAULT_THEME;\n        }\n    }\n\n    /**\n     * Get stored view level preference or default\n     */\n    function getStoredViewLevel() {\n        try {\n            const level = localStorage.getItem(VIEW_LEVEL_STORAGE_KEY);\n            if (level && AVAILABLE_VIEW_LEVELS.includes(level)) {\n                return level;\n            }\n            return DEFAULT_VIEW_LEVEL;\n        } catch (e) {\n            console.warn('localStorage not available:', e);\n            return DEFAULT_VIEW_LEVEL;\n        }\n    }\n\n    /**\n     * Apply theme to document\n     */\n    function applyTheme(theme) {\n        document.documentElement.setAttribute('data-theme', theme);\n    }\n\n    /**\n     * Apply view level to document\n     * CRITICAL: This must run before CSS is parsed to prevent white screen\n     */\n    function applyViewLevel(level) {\n        document.documentElement.setAttribute('data-view-level', level);\n    }\n\n    /**\n     * Load configuration and apply custom CSS variables\n     */\n    async function loadConfig() {\n        try {\n            const response = await fetch(CONFIG_PATH);\n            if (!response.ok) {\n                throw new Error(`Failed to load config: ${response.status}`);\n            }\n\n            const config = await response.json();\n\n            // Apply brand colors if in brand theme\n            const currentTheme = getStoredTheme();\n            if (currentTheme === 'brand' && config.branding && config.branding.colors) {\n                appleBrandColors(config.branding.colors);\n            }\n\n            // Store config globally for app use\n            window.ZANOBOT_CONFIG = config;\n\n        } catch (error) {\n            console.warn('Could not load config.json, using defaults:', error);\n        }\n    }\n\n    /**\n     * Apply brand colors to CSS variables\n     */\n    function appleBrandColors(colors) {\n        const root = document.documentElement;\n\n        if (colors.primary) {\n            root.style.setProperty('--primary-color', colors.primary);\n        }\n        if (colors.primaryHover) {\n            root.style.setProperty('--primary-hover', colors.primaryHover);\n        }\n        if (colors.secondary) {\n            root.style.setProperty('--secondary-color', colors.secondary);\n        }\n        if (colors.accent) {\n            root.style.setProperty('--accent-color', colors.accent);\n        }\n        if (colors.background) {\n            root.style.setProperty('--bg-primary', colors.background);\n        }\n        if (colors.backgroundSecondary) {\n            root.style.setProperty('--bg-secondary', colors.backgroundSecondary);\n        }\n    }\n\n    /**\n     * Detect system theme preference (maps to our themes)\n     */\n    function getSystemTheme() {\n        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {\n            return 'neon'; // Dark mode  Neon Industrial\n        }\n        return 'light'; // Light mode  Daylight\n    }\n\n    /**\n     * Initialize theme system\n     */\n    function initTheme() {\n        // Apply stored theme immediately (before config loads)\n        const theme = getStoredTheme();\n        applyTheme(theme);\n\n        // CRITICAL: Apply view level immediately to prevent white screen\n        // This must happen before CSS rules that depend on data-view-level\n        const viewLevel = getStoredViewLevel();\n        applyViewLevel(viewLevel);\n\n        // Load config and apply brand colors\n        if (document.readyState === 'loading') {\n            document.addEventListener('DOMContentLoaded', loadConfig);\n        } else {\n            loadConfig();\n        }\n\n        // Listen for system theme changes\n        if (window.matchMedia) {\n            const mediaQuery = window.matchMedia('(prefers-color-scheme: dark)');\n            mediaQuery.addEventListener('change', (e) => {\n                // Only auto-switch if user hasn't manually selected a theme\n                if (!localStorage.getItem(THEME_STORAGE_KEY)) {\n                    applyTheme(e.matches ? 'neon' : 'light');\n                }\n            });\n        }\n    }\n\n    /**\n     * Public API for theme management\n     */\n    window.ZanobotTheme = {\n        /**\n         * Set theme\n         * @param {string} theme - 'neon', 'light', or 'brand'\n         */\n        setTheme: function(theme) {\n            if (!AVAILABLE_THEMES.includes(theme)) {\n                console.warn('Invalid theme:', theme, '- Available:', AVAILABLE_THEMES);\n                return;\n            }\n\n            try {\n                localStorage.setItem(THEME_STORAGE_KEY, theme);\n            } catch (e) {\n                console.warn('Could not save theme preference:', e);\n            }\n\n            applyTheme(theme);\n\n            // Reapply brand colors if switching to brand theme\n            if (theme === 'brand' && window.ZANOBOT_CONFIG?.branding?.colors) {\n                appleBrandColors(window.ZANOBOT_CONFIG.branding.colors);\n            }\n\n            // Dispatch event for listeners\n            window.dispatchEvent(new CustomEvent('themechange', {\n                detail: { theme }\n            }));\n        },\n\n        /**\n         * Get current theme\n         * @returns {string}\n         */\n        getTheme: function() {\n            return getStoredTheme();\n        },\n\n        /**\n         * Toggle between themes (cycles through neon  light  brand)\n         */\n        toggleTheme: function() {\n            const currentTheme = getStoredTheme();\n            const currentIndex = AVAILABLE_THEMES.indexOf(currentTheme);\n            const nextIndex = (currentIndex + 1) % AVAILABLE_THEMES.length;\n            this.setTheme(AVAILABLE_THEMES[nextIndex]);\n            return AVAILABLE_THEMES[nextIndex];\n        },\n\n        /**\n         * Get available themes\n         * @returns {string[]}\n         */\n        getAvailableThemes: function() {\n            return [...AVAILABLE_THEMES];\n        },\n\n        /**\n         * Get theme display name\n         * @param {string} theme - Theme key\n         * @returns {string} Display name\n         */\n        getThemeDisplayName: function(theme) {\n            const names = {\n                'neon': 'Neon Industrial',\n                'light': 'Daylight',\n                'brand': 'Zanobo'\n            };\n            return names[theme] || theme;\n        },\n\n        /**\n         * Get theme description\n         * @param {string} theme - Theme key\n         * @returns {string} Description\n         */\n        getThemeDescription: function(theme) {\n            const descriptions = {\n                'neon': 'Cyberpunk-Style mit Neon Cyan & Orange. Perfekt fr dunkle Umgebungen.',\n                'light': 'Heller High-Contrast-Modus. Optimal fr Sonnenlicht & Outdoor.',\n                'brand': 'Original Zanobo Design. Ausgewogen & professionell.'\n            };\n            return descriptions[theme] || '';\n        },\n\n        /**\n         * Apply custom colors (for runtime customization)\n         * @param {Object} colors - Color object with primary, secondary, etc.\n         */\n        applyCustomColors: function(colors) {\n            appleBrandColors(colors);\n        },\n\n        /**\n         * Reset to default theme\n         */\n        reset: function() {\n            try {\n                localStorage.removeItem(THEME_STORAGE_KEY);\n            } catch (e) {\n                console.warn('Could not reset theme:', e);\n            }\n            applyTheme(DEFAULT_THEME);\n        }\n    };\n\n    // Initialize theme immediately\n    initTheme();\n})();\n","/**\n * ZANOBOT - TOAST NOTIFICATION COMPONENT\n *\n * Modern, non-intrusive toast notifications to replace alert() dialogs.\n *\n * Features:\n * - Auto-dismiss with configurable duration\n * - Multiple toast types: success, error, warning, info\n * - Stacking support (multiple toasts at once)\n * - Smooth animations (slide in/out)\n * - Accessible (ARIA attributes)\n */\n\nexport type ToastType = 'success' | 'error' | 'warning' | 'info';\n\nexport interface ToastOptions {\n  /** Toast message */\n  message: string;\n  /** Optional title */\n  title?: string;\n  /** Toast type */\n  type?: ToastType;\n  /** Duration in milliseconds (0 = permanent, requires manual close) */\n  duration?: number;\n  /** Show close button */\n  dismissible?: boolean;\n  /** Position on screen */\n  position?:\n    | 'top-right'\n    | 'top-center'\n    | 'top-left'\n    | 'bottom-right'\n    | 'bottom-center'\n    | 'bottom-left';\n}\n\n/**\n * Toast Notification Manager\n */\nexport class ToastManager {\n  private container: HTMLElement | null = null;\n  private toasts: Map<string, HTMLElement> = new Map();\n  private toastCounter = 0;\n  private pendingToasts: Array<{ id: string; options: Required<ToastOptions> }> = [];\n  private currentPosition: Required<ToastOptions>['position'] = 'top-right';\n\n  constructor() {\n    this.initContainer();\n  }\n\n  /**\n   * Initialize toast container\n   */\n  private initContainer(): void {\n    if (typeof document === 'undefined') {\n      return;\n    }\n\n    if (!document.body) {\n      document.addEventListener(\n        'DOMContentLoaded',\n        () => {\n          this.initContainer();\n        },\n        { once: true }\n      );\n      return;\n    }\n\n    // Check if container already exists\n    let container = document.getElementById('toast-container');\n\n    if (!container) {\n      container = document.createElement('div');\n      container.id = 'toast-container';\n      container.className = 'toast-container';\n      container.setAttribute('aria-live', 'polite');\n      container.setAttribute('aria-atomic', 'true');\n      document.body.appendChild(container);\n    }\n\n    this.container = container;\n    this.container.classList.add(`toast-container--${this.currentPosition}`);\n    this.flushPendingToasts();\n  }\n\n  /**\n   * Show a toast notification\n   */\n  public show(options: ToastOptions): string {\n    const defaults: Required<ToastOptions> = {\n      message: '',\n      title: '',\n      type: 'info',\n      duration: 5000,\n      dismissible: true,\n      position: 'top-right',\n    };\n\n    const config = { ...defaults, ...options };\n    const toastId = this.createToastId();\n\n    if (!this.container) {\n      this.initContainer();\n    }\n\n    if (!this.container) {\n      this.pendingToasts.push({ id: toastId, options: config });\n      return toastId;\n    }\n\n    this.renderToast(toastId, config);\n\n    return toastId;\n  }\n\n  /**\n   * Flush queued toasts once the container is ready\n   */\n  private flushPendingToasts(): void {\n    if (!this.container || this.pendingToasts.length === 0) {\n      return;\n    }\n\n    const queued = [...this.pendingToasts];\n    this.pendingToasts = [];\n    queued.forEach(({ id, options }) => {\n      this.renderToast(id, { ...options });\n    });\n  }\n\n  /**\n   * Render a toast in the DOM\n   */\n  private renderToast(toastId: string, config: Required<ToastOptions>): void {\n    if (!this.container) {\n      return;\n    }\n\n    this.applyPosition(config.position);\n\n    // Create toast element\n    const toast = this.createToastElement(toastId, config);\n\n    this.container.appendChild(toast);\n    this.toasts.set(toastId, toast);\n\n    // Trigger animation\n    setTimeout(() => toast.classList.add('toast-show'), 10);\n\n    // Auto-dismiss after duration\n    if (config.duration > 0) {\n      setTimeout(() => this.hide(toastId), config.duration);\n    }\n  }\n\n  /**\n   * Apply container position classes\n   */\n  private applyPosition(position: Required<ToastOptions>['position']): void {\n    if (!this.container || this.currentPosition === position) {\n      return;\n    }\n\n    this.container.classList.remove(`toast-container--${this.currentPosition}`);\n    this.container.classList.add(`toast-container--${position}`);\n    this.currentPosition = position;\n  }\n\n  /**\n   * Generate a unique toast ID\n   */\n  private createToastId(): string {\n    return `toast-${++this.toastCounter}`;\n  }\n\n  /**\n   * Hide a specific toast\n   */\n  public hide(toastId: string): void {\n    const toast = this.toasts.get(toastId);\n    if (!toast) return;\n\n    // Animate out\n    toast.classList.remove('toast-show');\n    toast.classList.add('toast-hide');\n\n    // Remove from DOM after animation\n    setTimeout(() => {\n      if (this.container && toast.parentNode === this.container) {\n        this.container.removeChild(toast);\n      }\n      this.toasts.delete(toastId);\n    }, 300);\n  }\n\n  /**\n   * Hide all toasts\n   */\n  public hideAll(): void {\n    this.toasts.forEach((_, toastId) => this.hide(toastId));\n  }\n\n  /**\n   * Create toast DOM element\n   */\n  private createToastElement(toastId: string, config: Required<ToastOptions>): HTMLElement {\n    const toast = document.createElement('div');\n    toast.id = toastId;\n    toast.className = `toast toast-${config.type}`;\n    toast.setAttribute('role', config.type === 'error' ? 'alert' : 'status');\n\n    // Icon\n    const icon = this.getIcon(config.type);\n\n    // Title\n    const titleHTML = config.title\n      ? `<div class=\"toast-title\">${this.escapeHTML(config.title)}</div>`\n      : '';\n\n    // Message\n    const messageHTML = `<div class=\"toast-message\">${this.escapeHTML(config.message)}</div>`;\n\n    // Close button\n    const closeButton = config.dismissible\n      ? `<button class=\"toast-close\" aria-label=\"Close notification\" data-toast-id=\"${toastId}\"></button>`\n      : '';\n\n    // Compose toast\n    toast.innerHTML = `\n      <div class=\"toast-icon\">${icon}</div>\n      <div class=\"toast-content\">\n        ${titleHTML}\n        ${messageHTML}\n      </div>\n      ${closeButton}\n    `;\n\n    // Add close button event listener\n    if (config.dismissible) {\n      const closeBtn = toast.querySelector('.toast-close');\n      if (closeBtn) {\n        closeBtn.addEventListener('click', () => this.hide(toastId));\n      }\n    }\n\n    return toast;\n  }\n\n  /**\n   * Get icon for toast type\n   */\n  private getIcon(type: ToastType): string {\n    const icons = {\n      success: '',\n      error: '',\n      warning: '',\n      info: '',\n    };\n\n    return icons[type] || icons.info;\n  }\n\n  /**\n   * Escape HTML to prevent XSS\n   */\n  private escapeHTML(text: string): string {\n    const div = document.createElement('div');\n    div.textContent = text;\n    return div.innerHTML;\n  }\n\n  /**\n   * Shorthand: Show success toast\n   */\n  public success(message: string, title?: string, duration = 5000): string {\n    return this.show({ message, title, type: 'success', duration });\n  }\n\n  /**\n   * Shorthand: Show error toast\n   */\n  public error(message: string, title?: string, duration = 0): string {\n    return this.show({ message, title, type: 'error', duration });\n  }\n\n  /**\n   * Shorthand: Show warning toast\n   */\n  public warning(message: string, title?: string, duration = 7000): string {\n    return this.show({ message, title, type: 'warning', duration });\n  }\n\n  /**\n   * Shorthand: Show info toast\n   */\n  public info(message: string, title?: string, duration = 5000): string {\n    return this.show({ message, title, type: 'info', duration });\n  }\n}\n\n/**\n * Global toast manager instance\n */\nexport const toast = new ToastManager();\n","/**\n * ZANOBOT - CENTRALIZED NOTIFICATION SYSTEM\n *\n * Provides consistent user notifications throughout the app.\n * Replaces inconsistent alert() calls with proper UI feedback.\n *\n * Usage:\n *   import { notify } from '@utils/notifications.js';\n *   notify.success('Model trained successfully!');\n *   notify.error('Failed to access microphone', error);\n *   notify.warning('No signal detected');\n */\n\nimport { logger } from './logger.js';\nimport { toast } from '@ui/components/Toast.js';\n\n/**\n * Notification types\n */\nexport type NotificationType = 'success' | 'error' | 'warning' | 'info';\n\n/**\n * Notification options\n */\nexport interface NotificationOptions {\n  /** Notification message */\n  message: string;\n  /** Optional title */\n  title?: string;\n  /** Duration in milliseconds (0 = permanent) */\n  duration?: number;\n  /** Show close button */\n  dismissible?: boolean;\n}\n\n/**\n * Notification Manager\n */\nclass NotificationManager {\n  /**\n   * Show success notification\n   */\n  public success(message: string, options?: Partial<NotificationOptions>): void {\n    this.show('success', { message, ...options });\n    logger.info(' Success:', message);\n  }\n\n  /**\n   * Show error notification\n   */\n  public error(\n    message: string,\n    error?: Error | unknown,\n    options?: Partial<NotificationOptions>\n  ): void {\n    // Include error details in notification if available\n    let fullMessage = message;\n    if (error && error instanceof Error && error.message) {\n      fullMessage = `${message}\\n\\nDetails: ${error.message}`;\n    }\n\n    this.show('error', { message: fullMessage, ...options });\n\n    if (error) {\n      logger.error(' Error:', error, message);\n    } else {\n      logger.error(' Error:', message);\n    }\n  }\n\n  /**\n   * Show warning notification\n   */\n  public warning(message: string, options?: Partial<NotificationOptions>): void {\n    this.show('warning', { message, ...options });\n    logger.warn(' Warning:', message);\n  }\n\n  /**\n   * Show info notification\n   */\n  public info(message: string, options?: Partial<NotificationOptions>): void {\n    this.show('info', { message, ...options });\n    logger.info(' Info:', message);\n  }\n\n  /**\n   * Confirm dialog (for important actions)\n   */\n  public async confirm(message: string, title = 'Besttigung erforderlich'): Promise<boolean> {\n    // Browser guard: Check if window.confirm is available\n    if (typeof window === 'undefined' || typeof window.confirm !== 'function') {\n      logger.warn(' Confirm dialog not available in non-browser context. Defaulting to false.');\n      return false;\n    }\n\n    // For now, use browser confirm (can be replaced with custom modal later)\n    return confirm(`${title}\\n\\n${message}`);\n  }\n\n  /**\n   * Internal show method\n   */\n  private show(type: NotificationType, options: NotificationOptions): void {\n    const defaults: NotificationOptions = {\n      message: '',\n      duration: type === 'error' ? 0 : 5000,\n      dismissible: true,\n    };\n\n    const config = { ...defaults, ...options };\n\n    // For now, use native browser APIs\n    // TODO: Replace with custom toast/modal system in future\n    if (typeof window !== 'undefined') {\n      this.showNativeNotification(type, config);\n    }\n  }\n\n  /**\n   * Show toast notification (modern implementation)\n   */\n  private showNativeNotification(type: NotificationType, options: NotificationOptions): void {\n    // Use toast system for all notification types\n    toast.show({\n      message: options.message,\n      title: options.title,\n      type,\n      duration: options.duration,\n      dismissible: options.dismissible,\n    });\n  }\n\n  /**\n   * Get icon for notification type\n   */\n  private getIcon(type: NotificationType): string {\n    const icons = {\n      success: '',\n      error: '',\n      warning: '',\n      info: '',\n    };\n\n    return icons[type] || '';\n  }\n}\n\n/**\n * Global notification manager instance\n */\nexport const notify = new NotificationManager();\n\n/**\n * Shorthand notification functions\n */\nexport const notification = {\n  success: (message: string, options?: Partial<NotificationOptions>) =>\n    notify.success(message, options),\n  error: (message: string, error?: Error | unknown, options?: Partial<NotificationOptions>) =>\n    notify.error(message, error, options),\n  warning: (message: string, options?: Partial<NotificationOptions>) =>\n    notify.warning(message, options),\n  info: (message: string, options?: Partial<NotificationOptions>) => notify.info(message, options),\n  confirm: (message: string, title?: string) => notify.confirm(message, title),\n};\n","export function isIOS(): boolean {\n  // Prft auf iPhone/iPad UserAgent oder Mac mit Touch (iPadOS 13+)\n  return (\n    [\n      'iPad Simulator',\n      'iPhone Simulator',\n      'iPod Simulator',\n      'iPad',\n      'iPhone',\n      'iPod',\n    ].includes(navigator.platform) ||\n    (navigator.userAgent.includes('Mac') && 'ontouchend' in document)\n  );\n}\n","/**\n * ZANOBOT - AUDIO HARDWARE INTELLIGENCE\n *\n * Detects problematic microphones (Jabra, Headsets, Bluetooth)\n * that might filter out machine sounds and cause poor training quality.\n *\n * Features:\n * - Hardware label analysis (keyword detection)\n * - Sample rate validation\n * - Real-time device enumeration\n */\n\nimport { logger } from '@utils/logger.js';\nimport { isIOS } from '@utils/platform.js';\n\n/**\n * Audio Quality Report\n * Represents the assessment of current audio hardware\n */\nexport interface AudioQualityReport {\n  status: 'good' | 'warning';\n  reason: string;\n  deviceLabel: string;\n  sampleRate: number;\n  recommendations?: string[];\n}\n\n/**\n * Device Info for selection UI\n */\nexport interface AudioDeviceInfo {\n  deviceId: string;\n  label: string;\n  kind: MediaDeviceKind;\n  groupId: string;\n}\n\n/**\n * HardwareCheck - Audio Hardware Intelligence\n *\n * Analyzes microphone quality and provides recommendations.\n */\nexport class HardwareCheck {\n  // Known problematic keywords in device labels\n  private static readonly PROBLEMATIC_KEYWORDS = [\n    'jabra',\n    'plantronics',\n    'sennheiser',\n    'hands-free',\n    'handsfree',\n    'headset',\n    'airpods',\n    'bluetooth',\n    'bt audio',\n    'wireless',\n  ];\n\n  // Minimum recommended sample rate (44.1 kHz)\n  private static readonly MIN_SAMPLE_RATE = 44100;\n\n  /**\n   * Priority-ordered keywords for identifying rear/environment microphones\n   * These mics are optimized for room recording (far-field) rather than voice (near-field)\n   *\n   * Priority:\n   * 1. back/rck/rear - iOS typical rear mic naming\n   * 2. environment - Professional/industrial hardware\n   * 3. camcorder/video - Android camera mic (optimized for video recording)\n   * 4. camera - Generic camera-associated mic\n   */\n  private static readonly PREFERRED_MIC_KEYWORDS = [\n    // Priority 1: iOS rear microphone (highest priority)\n    'back',\n    'rck',\n    'rear',\n    // Priority 2: Professional/industrial hardware\n    'environment',\n    // Priority 3: Android video/camcorder microphone\n    'camcorder',\n    'video',\n    // Priority 4: Generic camera microphone (lowest priority in preferred list)\n    'camera',\n  ];\n\n  /**\n   * Analyze current audio device\n   *\n   * @param label - Device label from MediaDeviceInfo or getUserMedia\n   * @param sampleRate - Sample rate in Hz\n   * @returns Audio quality report with status and recommendations\n   */\n  public static analyzeCurrentDevice(label: string, sampleRate: number): AudioQualityReport {\n    const report: AudioQualityReport = {\n      status: 'good',\n      reason: 'Hardware geeignet fr Maschinendiagnose',\n      deviceLabel: label,\n      sampleRate,\n      recommendations: [],\n    };\n\n    // Check 1: Device label for problematic keywords\n    const lowerLabel = label.toLowerCase();\n    const foundKeyword = this.PROBLEMATIC_KEYWORDS.find((keyword) => lowerLabel.includes(keyword));\n\n    if (foundKeyword) {\n      report.status = 'warning';\n      report.reason = 'Sprach-optimierte Hardware filtert Maschinengerusche.';\n      report.recommendations = [\n        'Verwenden Sie ein Studio-Mikrofon oder das eingebaute Gerte-Mikrofon',\n        'Headsets und Bluetooth-Gerte sind fr Sprachanrufe optimiert',\n        'Maschinengerusche knnten gefiltert oder unterdrckt werden',\n      ];\n\n      logger.warn(\n        ` Problematic audio hardware detected: \"${label}\" (keyword: \"${foundKeyword}\")`\n      );\n      return report;\n    }\n\n    // Check 2: Sample rate validation\n    if (sampleRate < this.MIN_SAMPLE_RATE) {\n      report.status = 'warning';\n      report.reason = `Sample Rate zu niedrig (${sampleRate} Hz < 44.1 kHz).`;\n      report.recommendations = [\n        `Aktuelle Sample Rate: ${sampleRate} Hz`,\n        `Empfohlen: ${this.MIN_SAMPLE_RATE} Hz oder hher`,\n        'Niedrige Sample Rates knnen hochfrequente Maschinensignale nicht erfassen',\n      ];\n\n      logger.warn(\n        ` Low sample rate detected: ${sampleRate} Hz (recommended: ${this.MIN_SAMPLE_RATE} Hz)`\n      );\n      return report;\n    }\n\n    // All checks passed\n    logger.info(` Audio hardware check passed: \"${label}\" @ ${sampleRate} Hz`);\n    return report;\n  }\n\n  /**\n   * Get all available audio input devices\n   *\n   * CRITICAL FIX: Uses finally block to ensure stream is always released,\n   * even if an error occurs after getUserMedia but before stop().\n   * This prevents microphone from being locked, which would block phone calls.\n   *\n   * @returns List of audio input devices\n   */\n  public static async getAvailableDevices(): Promise<AudioDeviceInfo[]> {\n    let stream: MediaStream | null = null;\n\n    try {\n      // Request permissions first (required for device labels)\n      stream = await navigator.mediaDevices.getUserMedia({ audio: true });\n\n      const devices = await navigator.mediaDevices.enumerateDevices();\n      const audioInputs = devices\n        .filter((device) => device.kind === 'audioinput')\n        .map((device) => ({\n          deviceId: device.deviceId,\n          label: device.label || `Mikrofon ${device.deviceId.substring(0, 8)}`,\n          kind: device.kind,\n          groupId: device.groupId,\n        }));\n\n      logger.info(`Found ${audioInputs.length} audio input devices`);\n      return audioInputs;\n    } catch (error) {\n      logger.error('Failed to enumerate audio devices:', error);\n      throw new Error('Mikrofonzugriff verweigert oder nicht verfgbar');\n    } finally {\n      // CRITICAL: Always release the microphone stream, even on error\n      // This ensures phone calls can still work if this method fails\n      if (stream) {\n        stream.getTracks().forEach((track) => track.stop());\n        logger.debug(' Permission stream released in getAvailableDevices()');\n      }\n    }\n  }\n\n  /**\n   * Get current active audio device info\n   *\n   * Requires an active MediaStream to determine the current device.\n   *\n   * @param stream - Active MediaStream\n   * @returns Device info or null if not determinable\n   */\n  public static async getCurrentDevice(stream: MediaStream): Promise<AudioDeviceInfo | null> {\n    try {\n      const tracks = stream.getAudioTracks();\n      if (tracks.length === 0) {\n        logger.warn('No audio tracks in stream');\n        return null;\n      }\n\n      const settings = tracks[0].getSettings();\n      const deviceId = settings.deviceId;\n\n      if (!deviceId) {\n        logger.warn('No deviceId in track settings');\n        return null;\n      }\n\n      const devices = await this.getAvailableDevices();\n      const currentDevice = devices.find((device) => device.deviceId === deviceId);\n\n      return currentDevice || null;\n    } catch (error) {\n      logger.error('Failed to get current device:', error);\n      return null;\n    }\n  }\n\n  /**\n   * Check if device label suggests it's a built-in microphone\n   *\n   * Built-in mics are usually good for machine diagnosis.\n   *\n   * @param label - Device label\n   * @returns True if likely built-in\n   */\n  public static isLikelyBuiltIn(label: string): boolean {\n    const lowerLabel = label.toLowerCase();\n    const builtInKeywords = [\n      'built-in',\n      'internal',\n      'integriert',\n      'eingebaut',\n      'default',\n      'array',\n      'macbook',\n      'imac',\n    ];\n\n    return builtInKeywords.some((keyword) => lowerLabel.includes(keyword));\n  }\n\n  /**\n   * Special deviceId marker for iOS rear microphone workaround\n   * When this deviceId is passed to getRawAudioStream(), it triggers the Video+Audio workaround\n   */\n  public static readonly IOS_REAR_MIC_DEVICE_ID = '__ios_rear_mic__';\n\n  /**\n   * iOS-specific: Get rear microphone stream via Video+Audio workaround\n   *\n   * CRITICAL iOS LIMITATION:\n   * - iOS Safari does NOT expose separate microphones via enumerateDevices()\n   * - It only shows \"iPhone Microphone\" or \"Internal Microphone\"\n   * - The ONLY way to access the rear microphone on iOS is through the camera API\n   *\n   * This method requests a video+audio stream with facingMode: \"environment\" (back camera),\n   * which forces iOS to use the rear microphone associated with the back camera.\n   * The video tracks are immediately stopped (we only need audio).\n   *\n   * CRITICAL FIX: Uses try-finally pattern to ensure all tracks are stopped on error,\n   * preventing microphone/camera from being locked (which would block phone calls).\n   *\n   * @returns MediaStream with rear microphone audio, or null if not available\n   */\n  public static async getiOSRearMicStream(): Promise<MediaStream | null> {\n    if (!isIOS()) {\n      logger.debug(' getiOSRearMicStream: Not iOS, skipping');\n      return null;\n    }\n\n    let stream: MediaStream | null = null;\n\n    try {\n      logger.info(' iOS detected: Attempting rear microphone via camera workaround...');\n\n      // Request video+audio with back camera (facingMode: \"environment\")\n      // This forces iOS to use the rear microphone associated with the back camera\n      stream = await navigator.mediaDevices.getUserMedia({\n        video: {\n          facingMode: { exact: 'environment' }, // Back camera\n          width: { ideal: 1 }, // Minimal resolution (we don't need video)\n          height: { ideal: 1 },\n        },\n        audio: {\n          // CRITICAL: Disable all audio processing for raw machine sounds\n          echoCancellation: false,\n          autoGainControl: false,\n          noiseSuppression: false,\n        },\n      });\n\n      // Extract audio tracks\n      const audioTracks = stream.getAudioTracks();\n\n      if (audioTracks.length === 0) {\n        logger.warn(' iOS rear mic workaround: No audio tracks received');\n        // Stream will be cleaned up in finally block\n        return null;\n      }\n\n      // IMPORTANT: Stop video tracks immediately (we only need audio)\n      // This releases the camera resource\n      stream.getVideoTracks().forEach((track) => {\n        logger.debug(` Stopping video track: ${track.label}`);\n        track.stop();\n      });\n\n      // Create audio-only stream\n      const audioOnlyStream = new MediaStream(audioTracks);\n\n      logger.info(\n        ` iOS rear mic workaround successful: \"${audioTracks[0].label}\" (via back camera)`\n      );\n\n      // Mark stream as successfully transferred to audioOnlyStream\n      // Set to null so finally block doesn't stop the audio tracks we want to return\n      stream = null;\n\n      return audioOnlyStream;\n    } catch (error) {\n      // Expected errors:\n      // - NotAllowedError: User denied camera permission\n      // - OverconstrainedError: Device has no back camera (e.g., iPad mini)\n      // - NotFoundError: No camera available\n\n      const errorMessage = error instanceof Error ? error.message : String(error);\n      const errorName = error instanceof Error ? error.name : 'Unknown';\n\n      if (errorName === 'NotAllowedError') {\n        logger.info(' iOS rear mic: Camera permission denied, falling back to default mic');\n      } else if (errorName === 'OverconstrainedError') {\n        logger.info(' iOS rear mic: No back camera available, falling back to default mic');\n      } else {\n        logger.warn(` iOS rear mic workaround failed: ${errorName} - ${errorMessage}`);\n      }\n\n      return null;\n    } finally {\n      // CRITICAL FIX: Always release the stream on failure or early return\n      // This ensures microphone/camera are released for phone calls\n      if (stream) {\n        stream.getTracks().forEach((track) => track.stop());\n        logger.debug(' iOS rear mic stream released in finally block');\n      }\n    }\n  }\n\n  /**\n   * Find the best microphone for machine diagnosis (Smart Microphone Auto-Selection)\n   *\n   * This method searches for rear/environment microphones that are optimized for\n   * room recording (far-field) rather than voice calls (near-field).\n   *\n   * Rationale:\n   * - Default smartphone mics (bottom/front) are optimized for telephony\n   * - They apply aggressive noise suppression that filters out machine sounds\n   * - Rear/camera mics are optimized for video recording (unfiltered room audio)\n   *\n   * iOS SPECIAL HANDLING:\n   * - iOS does not expose separate microphones via enumerateDevices()\n   * - We use the Video+Audio workaround with facingMode: \"environment\"\n   * - Returns a special deviceId (__ios_rear_mic__) that triggers the workaround\n   *\n   * @returns Promise<{ deviceId: string; label: string } | undefined>\n   *          Returns device info if a preferred mic is found, undefined otherwise\n   */\n  public static async findBestMicrophone(): Promise<{ deviceId: string; label: string } | undefined> {\n    try {\n      // ============================================\n      // iOS SPECIAL PATH: Video+Audio Workaround\n      // ============================================\n      if (isIOS()) {\n        logger.info(' findBestMicrophone: iOS detected, attempting rear mic workaround...');\n\n        // Try to get rear microphone via camera API\n        const iosStream = await this.getiOSRearMicStream();\n\n        if (iosStream) {\n          // Success! Stop the stream (we'll get a new one when needed)\n          const label = iosStream.getAudioTracks()[0]?.label || 'iPhone Rckseiten-Mikrofon';\n          iosStream.getTracks().forEach((track) => track.stop());\n\n          logger.info(` iOS: Rear microphone available: \"${label}\"`);\n\n          // Return special marker deviceId - getRawAudioStream() will handle this\n          return {\n            deviceId: this.IOS_REAR_MIC_DEVICE_ID,\n            label: `${label} (optimiert fr Diagnose)`,\n          };\n        }\n\n        // Fallback: iOS rear mic not available, use default\n        logger.info(' iOS: Rear mic not available, using default microphone');\n        return undefined;\n      }\n\n      // ============================================\n      // STANDARD PATH: Keyword-based device search\n      // ============================================\n      const devices = await navigator.mediaDevices.enumerateDevices();\n      const audioInputs = devices.filter((device) => device.kind === 'audioinput');\n\n      // Check if we have labels (requires permission)\n      const hasLabels = audioInputs.some((device) => device.label && device.label.length > 0);\n\n      if (!hasLabels) {\n        logger.warn(' findBestMicrophone: No device labels available (permission may be required)');\n        return undefined;\n      }\n\n      logger.info(` findBestMicrophone: Scanning ${audioInputs.length} audio inputs...`);\n\n      // Search by priority - first keyword match wins\n      for (const keyword of this.PREFERRED_MIC_KEYWORDS) {\n        for (const device of audioInputs) {\n          const lowerLabel = device.label.toLowerCase();\n\n          if (lowerLabel.includes(keyword)) {\n            logger.info(\n              ` findBestMicrophone: Found preferred mic \"${device.label}\" (keyword: \"${keyword}\")`\n            );\n            return {\n              deviceId: device.deviceId,\n              label: device.label,\n            };\n          }\n        }\n      }\n\n      // No preferred microphone found - fallback to default\n      logger.info(' findBestMicrophone: No preferred mic found, using system default');\n      return undefined;\n    } catch (error) {\n      logger.error(' findBestMicrophone: Failed to enumerate devices:', error);\n      return undefined;\n    }\n  }\n}\n","/**\n * ZANOBOT - AUDIO HELPER\n *\n * Centralized audio configuration and utilities for Phase 5.\n *\n * Features:\n * - Global audio constraints (disable AGC, echo cancellation, noise suppression)\n * - Smart Start logic (warm-up + signal trigger)\n * - Ensures identical audio parameters across Phase 2 and Phase 3\n */\n\nimport { logger } from '@utils/logger.js';\nimport { isIOS } from '@utils/platform.js';\nimport { HardwareCheck } from './HardwareCheck.js';\n\n/**\n * Standard audio constraints for raw, unprocessed audio\n *\n * CRITICAL: We use explicit boolean `false` instead of `{ exact: false }` to force\n * iOS/Android to switch from \"Voice Processing Mode\" to \"Media Recording Mode\".\n *\n * Voice Processing Mode (default for telephony):\n * - Uses front/bottom microphone\n * - Applies aggressive noise suppression (filters machine sounds as \"noise\")\n * - Echo cancellation (removes reverb/room acoustics)\n * - Auto gain control (normalizes volume, removes dynamic range)\n *\n * Media Recording Mode (what we need):\n * - Can use rear/camera microphone (far-field, room recording)\n * - Raw, unfiltered audio with full frequency response\n * - Preserves machine sound characteristics for AI diagnosis\n *\n * The explicit `false` boolean often triggers this mode switch on mobile browsers.\n */\nexport const AUDIO_CONSTRAINTS = {\n  audio: {\n    // HARDCORE: Force disable all audio processing\n    echoCancellation: false,\n    autoGainControl: false,\n    noiseSuppression: false,\n    channelCount: 1, // Mono is more robust\n    sampleRate: 48000, // High quality audio (matches config.json)\n  },\n};\n\n/**\n * Build audio constraints with optional device ID\n *\n * IMPORTANT: Uses explicit boolean `false` for all audio processing flags\n * to force \"Media Recording Mode\" instead of \"Voice Processing Mode\".\n *\n * @param deviceId - Optional specific device ID to use\n * @returns Audio constraints object\n */\nexport function buildAudioConstraints(deviceId?: string): MediaStreamConstraints {\n  // CRITICAL: Deep copy to prevent mutation of global AUDIO_CONSTRAINTS\n  // Use explicit boolean `false` to maximize compatibility and force raw audio mode\n  const baseConstraints: MediaStreamConstraints = {\n    audio: {\n      // HARDCORE: Explicit boolean false for all processing (not { exact: false })\n      echoCancellation: false,\n      autoGainControl: false,\n      noiseSuppression: false,\n      channelCount: AUDIO_CONSTRAINTS.audio.channelCount,\n      sampleRate: AUDIO_CONSTRAINTS.audio.sampleRate,\n      // Device selection (use exact for specific device targeting)\n      ...(deviceId && { deviceId: { exact: deviceId } }),\n    },\n  };\n\n  return baseConstraints;\n}\n\n/**\n * Fallback constraints if exact: false throws errors\n * Some browsers don't support the exact syntax\n */\nexport const AUDIO_CONSTRAINTS_FALLBACK = {\n  audio: {\n    echoCancellation: false,\n    autoGainControl: false,\n    noiseSuppression: false,\n    channelCount: 1,\n    sampleRate: 48000, // High quality audio (matches config.json)\n  },\n};\n\n/**\n * Smart Start configuration\n */\nexport interface SmartStartConfig {\n  /** Warm-up duration in milliseconds (discard initial audio) */\n  warmUpDuration: number;\n  /** Signal trigger threshold (RMS level, 0-1) */\n  signalThreshold: number;\n  /** Maximum wait time for signal in milliseconds */\n  maxWaitTime: number;\n  /** Enable adaptive trigger learning (default: true) */\n  adaptiveTrigger?: boolean;\n  /** Learning period for adaptive trigger in milliseconds (default: 2000ms) */\n  adaptiveLearningPeriod?: number;\n}\n\n/**\n * Default Smart Start configuration\n */\nexport const DEFAULT_SMART_START_CONFIG: SmartStartConfig = {\n  //  DO NOT CHANGE: Physical settling time for OS audio filters (AGC, noise cancellation)\n  // 5 seconds warmup is REQUIRED to discard initial unstable samples.\n  // This is not a timing bug - it's a deliberate delay for signal stabilization.\n  warmUpDuration: 5000, // 5 seconds (extended settling time for OS audio filters)\n  signalThreshold: isIOS() ? 0.002 : 0.01, // iOS gets higher sensitivity; Android/Desktop keep stable default\n  maxWaitTime: 30000, // 30 seconds max wait\n  adaptiveTrigger: true, // Enable adaptive trigger learning\n  adaptiveLearningPeriod: 2000, // Learn from first 2 seconds of warmup\n};\n\n/**\n * Smart Start state\n *\n * CRITICAL: This interface is shared between audioHelper and audioWorkletHelper.\n * All properties except 'phase' are optional to support both implementations.\n */\nexport interface SmartStartState {\n  phase: 'idle' | 'warmup' | 'waiting' | 'recording';\n  remainingWarmUp?: number;\n  signalDetected?: boolean;\n}\n\n/**\n * Get optimized audio stream with raw, unprocessed audio\n *\n * Attempts to use exact constraints first, falls back to simple booleans\n * if the browser doesn't support exact syntax.\n *\n * iOS SPECIAL HANDLING:\n * - If deviceId is IOS_REAR_MIC_DEVICE_ID, uses the Video+Audio workaround\n * - This forces iOS to use the rear microphone associated with the back camera\n *\n * @param deviceId - Optional specific device ID to use (or IOS_REAR_MIC_DEVICE_ID for iOS workaround)\n * @returns MediaStream with raw audio\n */\nexport async function getRawAudioStream(deviceId?: string): Promise<MediaStream> {\n  try {\n    // ============================================\n    // iOS SPECIAL PATH: Rear Microphone Workaround\n    // ============================================\n    if (deviceId === HardwareCheck.IOS_REAR_MIC_DEVICE_ID) {\n      logger.info(' getRawAudioStream: iOS rear mic workaround requested');\n\n      const iosStream = await HardwareCheck.getiOSRearMicStream();\n\n      if (iosStream) {\n        logger.info(' iOS rear mic stream obtained successfully');\n        return iosStream;\n      }\n\n      // Fallback to default mic if workaround fails\n      logger.warn(' iOS rear mic workaround failed, falling back to default microphone');\n      const fallbackConstraints = buildAudioConstraints(undefined);\n      return await navigator.mediaDevices.getUserMedia(fallbackConstraints);\n    }\n\n    // ============================================\n    // STANDARD PATH: Normal device selection\n    // ============================================\n    // Build constraints with optional device ID\n    const constraints = buildAudioConstraints(deviceId);\n\n    // Try exact constraints first\n    return await navigator.mediaDevices.getUserMedia(constraints);\n  } catch (error) {\n    logger.warn(' Exact constraints failed, using fallback:', error);\n\n    try {\n      // CRITICAL FIX: Deep copy to prevent mutation of global AUDIO_CONSTRAINTS_FALLBACK\n      // Shallow copy ({ ...AUDIO_CONSTRAINTS_FALLBACK }) would leave the nested 'audio' object as a reference\n      const fallbackConstraints: MediaStreamConstraints = {\n        audio: {\n          ...AUDIO_CONSTRAINTS_FALLBACK.audio, // Deep copy of nested audio object\n        },\n      };\n      return await navigator.mediaDevices.getUserMedia(fallbackConstraints);\n    } catch (fallbackError) {\n      logger.error(' Failed to get audio stream:', fallbackError);\n      throw new Error(\n        'Failed to access microphone. Please grant permission and ensure no other app is using it.'\n      );\n    }\n  }\n}\n\n/**\n * Get actual hardware sample rate from MediaStream\n *\n * @param stream - MediaStream from getUserMedia\n * @returns Actual sample rate (fallback 48000)\n */\nexport function getRealSampleRate(stream: MediaStream): number {\n  const audioTracks = stream.getAudioTracks();\n  const sampleRate = audioTracks[0]?.getSettings().sampleRate;\n\n  if (sampleRate) {\n    logger.debug(` Detected hardware sample rate: ${sampleRate}Hz`);\n    return sampleRate;\n  }\n\n  logger.debug(' Hardware sample rate unavailable, falling back to 48000Hz');\n  return 48000;\n}\n\n/**\n * Calculate RMS (Root Mean Square) level of audio samples\n *\n * This represents the \"loudness\" or \"power\" of the audio signal.\n * Used for signal trigger detection.\n *\n * @param samples - Audio samples\n * @returns RMS level (0-1), or 0 if samples array is empty\n */\nexport function calculateRMS(samples: Float32Array): number {\n  // Guard against empty samples to prevent NaN\n  if (samples.length === 0) {\n    return 0;\n  }\n\n  let sum = 0;\n  for (let i = 0; i < samples.length; i++) {\n    sum += samples[i] * samples[i];\n  }\n  return Math.sqrt(sum / samples.length);\n}\n\n/**\n * Smart Start Manager\n *\n * Handles warm-up period and signal trigger logic.\n * Ensures identical recording conditions for Phase 2 and Phase 3.\n *\n * ADAPTIVE TRIGGER:\n * - During first 2s of warmup: Collect RMS samples\n * - Calculate median RMS (baseline noise level)\n * - Set adaptive trigger = max(baseline * 3, config.signalThreshold)\n * - This adapts to environment noise while preventing false triggers\n */\nexport class SmartStartManager {\n  private config: SmartStartConfig;\n  private state: SmartStartState;\n  private warmUpStartTime: number = 0;\n  private waitStartTime: number = 0;\n  private onStateChange?: (state: SmartStartState) => void;\n  private onRecordingStart?: () => void;\n  private onTimeout?: () => void;\n\n  // Adaptive trigger learning\n  private rmsHistory: number[] = [];\n  private adaptiveTriggerThreshold: number;\n  private isLearningComplete: boolean = false;\n\n  constructor(\n    config: SmartStartConfig = DEFAULT_SMART_START_CONFIG,\n    callbacks?: {\n      onStateChange?: (state: SmartStartState) => void;\n      onRecordingStart?: () => void;\n      onTimeout?: () => void;\n    }\n  ) {\n    this.config = config;\n    this.state = {\n      phase: 'idle',\n    };\n    this.adaptiveTriggerThreshold = config.signalThreshold;\n    this.isLearningComplete = false;\n\n    if (callbacks) {\n      this.onStateChange = callbacks.onStateChange;\n      this.onRecordingStart = callbacks.onRecordingStart;\n      this.onTimeout = callbacks.onTimeout;\n    }\n  }\n\n  /**\n   * Start the Smart Start sequence\n   */\n  public start(): void {\n    logger.info(' Smart Start: Beginning warm-up period...');\n    this.warmUpStartTime = Date.now();\n    this.state = {\n      phase: 'warmup',\n      remainingWarmUp: this.config.warmUpDuration,\n      signalDetected: false,\n    };\n    this.notifyStateChange();\n  }\n\n  /**\n   * Process incoming audio samples\n   *\n   * Call this continuously with new audio data.\n   *\n   * @param samples - Audio samples from microphone\n   * @returns true if recording should proceed, false if still waiting\n   */\n  public processAudio(samples: Float32Array): boolean {\n    const now = Date.now();\n\n    if (this.state.phase === 'idle') {\n      return false;\n    }\n\n    // Phase 1: Warm-up period (discard audio)\n    if (this.state.phase === 'warmup') {\n      const elapsed = now - this.warmUpStartTime;\n      this.state.remainingWarmUp = Math.max(0, this.config.warmUpDuration - elapsed);\n\n      // Adaptive trigger learning: Collect RMS samples during learning period\n      if (\n        this.config.adaptiveTrigger &&\n        !this.isLearningComplete &&\n        elapsed <= (this.config.adaptiveLearningPeriod || 2000)\n      ) {\n        const rms = calculateRMS(samples);\n        this.rmsHistory.push(rms);\n      }\n\n      // End of learning period: Calculate adaptive trigger\n      if (\n        this.config.adaptiveTrigger &&\n        !this.isLearningComplete &&\n        elapsed > (this.config.adaptiveLearningPeriod || 2000)\n      ) {\n        this.computeAdaptiveTrigger();\n        this.isLearningComplete = true;\n      }\n\n      if (elapsed >= this.config.warmUpDuration) {\n        logger.info(' Warm-up complete. Waiting for signal...');\n        this.state.phase = 'waiting';\n        this.waitStartTime = now;\n        this.notifyStateChange();\n        return false; // Phase changed, wait for next processAudio() call\n      } else {\n        this.notifyStateChange();\n        return false; // Still warming up\n      }\n    }\n\n    // Phase 2: Wait for signal trigger\n    if (this.state.phase === 'waiting') {\n      const waitElapsed = now - this.waitStartTime;\n\n      // Check for timeout\n      if (waitElapsed >= this.config.maxWaitTime) {\n        logger.warn(' Signal timeout - no signal detected');\n        this.state = { phase: 'idle' };\n        this.notifyStateChange();\n        if (this.onTimeout) {\n          this.onTimeout();\n        }\n        return false;\n      }\n\n      // Check signal level (use adaptive threshold if available)\n      const rms = calculateRMS(samples);\n      const activeThreshold = this.adaptiveTriggerThreshold;\n\n      if (rms >= activeThreshold) {\n        logger.info(\n          ` Signal detected! RMS: ${rms.toFixed(4)} (threshold: ${activeThreshold.toFixed(4)}${this.config.adaptiveTrigger ? ' adaptive' : ''})`\n        );\n        this.state.phase = 'recording';\n        this.state.signalDetected = true;\n        this.notifyStateChange();\n\n        if (this.onRecordingStart) {\n          this.onRecordingStart();\n        }\n\n        return true; // Start recording!\n      }\n\n      this.notifyStateChange();\n      return false; // Still waiting for signal\n    }\n\n    // Phase 3: Recording in progress\n    return this.state.phase === 'recording';\n  }\n\n  /**\n   * Get current state\n   */\n  public getState(): SmartStartState {\n    return { ...this.state };\n  }\n\n  /**\n   * Reset to initial state\n   */\n  public reset(): void {\n    this.state = {\n      phase: 'idle',\n    };\n    this.warmUpStartTime = 0;\n    this.waitStartTime = 0;\n    this.rmsHistory = [];\n    this.adaptiveTriggerThreshold = this.config.signalThreshold;\n    this.isLearningComplete = false;\n  }\n\n  /**\n   * Compute adaptive trigger threshold from collected RMS samples\n   *\n   * Algorithm:\n   * 1. Calculate median RMS (baseline noise level)\n   * 2. Set trigger = max(baseline * 3, config.signalThreshold)\n   * 3. This adapts to environment noise while preventing false triggers\n   */\n  private computeAdaptiveTrigger(): void {\n    if (this.rmsHistory.length === 0) {\n      logger.warn(' No RMS samples collected - using default threshold');\n      this.adaptiveTriggerThreshold = this.config.signalThreshold;\n      return;\n    }\n\n    // Sort RMS values to find median\n    const sorted = [...this.rmsHistory].sort((a, b) => a - b);\n    const medianIndex = Math.floor(sorted.length / 2);\n    const medianRMS = sorted.length % 2 === 0\n      ? (sorted[medianIndex - 1] + sorted[medianIndex]) / 2\n      : sorted[medianIndex];\n\n    // Set trigger = baseline * 3, but not lower than config threshold\n    // Factor 3 ensures we detect signal above noise while avoiding false triggers\n    const adaptiveThreshold = Math.max(medianRMS * 3, this.config.signalThreshold);\n\n    this.adaptiveTriggerThreshold = adaptiveThreshold;\n\n    logger.info(\n      ` Adaptive trigger computed: ${adaptiveThreshold.toFixed(4)} ` +\n      `(baseline: ${medianRMS.toFixed(4)}, samples: ${this.rmsHistory.length})`\n    );\n  }\n\n  /**\n   * Notify state change to callback\n   */\n  private notifyStateChange(): void {\n    if (this.onStateChange) {\n      this.onStateChange(this.getState());\n    }\n  }\n\n  /**\n   * Skip warm-up and signal trigger (for manual start)\n   */\n  public skipToRecording(): void {\n    logger.info(' Skipping to recording phase');\n    this.state = {\n      phase: 'recording',\n      remainingWarmUp: 0,\n      signalDetected: true,\n    };\n    this.notifyStateChange();\n\n    if (this.onRecordingStart) {\n      this.onRecordingStart();\n    }\n  }\n}\n\n/**\n * Get user-friendly status message for UI\n */\nexport function getSmartStartStatusMessage(state: SmartStartState): string {\n  switch (state.phase) {\n    case 'idle':\n      return 'Bereit';\n    case 'warmup': {\n      // CRITICAL FIX: Handle optional remainingWarmUp field\n      const seconds = state.remainingWarmUp ? Math.ceil(state.remainingWarmUp / 1000) : 0;\n      return `Akustische Stabilisierung... ${seconds}s`;\n    }\n    case 'waiting':\n      return 'Warte auf Signal...';\n    case 'recording':\n      return 'Aufnahme luft';\n    default:\n      return 'Bereit';\n  }\n}\n","/**\n * ZANOBOT - PHASE 1: IDENTIFY\n *\n * Entry point of the app flow.\n * User identifies a machine via:\n * - QR/Barcode scan (with integrated camera scanner)\n * - Manual entry\n */\n\nimport { saveMachine, getMachine, getAllMachines } from '@data/db.js';\nimport { notify } from '@utils/notifications.js';\nimport type { Machine } from '@data/types.js';\nimport { Html5Qrcode } from 'html5-qrcode';\nimport { logger } from '@utils/logger.js';\nimport {\n  HardwareCheck,\n  type AudioQualityReport,\n  type AudioDeviceInfo,\n} from '@core/audio/HardwareCheck.js';\nimport { getRawAudioStream, AUDIO_CONSTRAINTS } from '@core/audio/audioHelper.js';\n\nexport class IdentifyPhase {\n  private onMachineSelected: (machine: Machine) => void;\n  private html5QrCode: Html5Qrcode | null = null;\n  private scannerModal: HTMLElement | null = null;\n  private isScanning: boolean = false;\n\n  // Hardware Intelligence\n  private currentAudioStream: MediaStream | null = null;\n  private selectedDeviceId: string | undefined = undefined;\n  private audioQualityReport: AudioQualityReport | null = null;\n\n  constructor(onMachineSelected: (machine: Machine) => void) {\n    this.onMachineSelected = onMachineSelected;\n  }\n\n  /**\n   * Initialize the identify phase UI\n   */\n  public init(): void {\n    // Scan button\n    const scanBtn = document.getElementById('scan-btn');\n    if (scanBtn) {\n      scanBtn.addEventListener('click', () => this.handleScan());\n    }\n\n    // Create machine button\n    const createBtn = document.getElementById('create-machine-btn');\n    if (createBtn) {\n      createBtn.addEventListener('click', () => this.handleCreateMachine());\n    }\n\n    // Scanner modal elements\n    this.scannerModal = document.getElementById('scanner-modal');\n    const closeScannerBtn = document.getElementById('close-scanner-modal');\n    const manualInputBtn = document.getElementById('manual-input-btn');\n    const manualInputConfirmBtn = document.getElementById('manual-input-confirm');\n    const manualInputCancelBtn = document.getElementById('manual-input-cancel');\n    const manualInputCloseBtn = document.getElementById('close-manual-input-modal');\n    const manualInputModal = document.getElementById('manual-input-modal');\n\n    if (closeScannerBtn) {\n      closeScannerBtn.addEventListener('click', () => this.closeScanner());\n    }\n\n    if (manualInputBtn) {\n      manualInputBtn.addEventListener('click', () => this.handleManualInput());\n    }\n\n    if (manualInputConfirmBtn) {\n      manualInputConfirmBtn.addEventListener('click', () => this.submitManualInput());\n    }\n\n    if (manualInputCancelBtn) {\n      manualInputCancelBtn.addEventListener('click', () => this.closeManualInputModal());\n    }\n\n    if (manualInputCloseBtn) {\n      manualInputCloseBtn.addEventListener('click', () => this.closeManualInputModal());\n    }\n\n    if (manualInputModal) {\n      manualInputModal.addEventListener('click', (e) => {\n        if (e.target === manualInputModal) {\n          this.closeManualInputModal();\n        }\n      });\n    }\n\n    // Close modal when clicking outside\n    if (this.scannerModal) {\n      this.scannerModal.addEventListener('click', (e) => {\n        if (e.target === this.scannerModal) {\n          this.closeScanner();\n        }\n      });\n    }\n\n    // Hardware Intelligence: Change Microphone Button\n    const changeMicBtn = document.getElementById('change-microphone-btn');\n    if (changeMicBtn) {\n      changeMicBtn.addEventListener('click', () => this.showMicrophoneSelection());\n    }\n\n    // Initialize hardware check\n    this.initializeHardwareCheck();\n\n    // Load and render machine history for quick select\n    this.loadMachineHistory();\n  }\n\n  /**\n   * Handle QR/Barcode scan\n   */\n  private async handleScan(): Promise<void> {\n    try {\n      this.openScannerModal();\n      await this.startScanner();\n    } catch (error) {\n      logger.error('Scan error:', error);\n      this.showScannerError('Fehler beim Starten des Scanners');\n    }\n  }\n\n  /**\n   * Open scanner modal\n   */\n  private openScannerModal(): void {\n    if (this.scannerModal) {\n      this.scannerModal.style.display = 'flex';\n\n      // Hide error and success messages\n      const errorDiv = document.getElementById('scanner-error');\n      const successDiv = document.getElementById('scanner-success');\n      const scannerContainer = document.getElementById('scanner-container');\n\n      if (errorDiv) errorDiv.style.display = 'none';\n      if (successDiv) successDiv.style.display = 'none';\n      if (scannerContainer) scannerContainer.style.display = 'block';\n    }\n  }\n\n  /**\n   * Start the QR/Barcode scanner\n   */\n  private async startScanner(): Promise<void> {\n    if (this.isScanning) return;\n\n    try {\n      this.isScanning = true;\n      this.html5QrCode = new Html5Qrcode('qr-reader');\n\n      // Configuration for scanning QR codes and barcodes\n      const config = {\n        fps: 10,\n        qrbox: { width: 250, height: 250 },\n        formatsToSupport: [\n          0, // QR_CODE\n          8, // CODE_128\n          13, // EAN_13\n          14, // EAN_8\n        ],\n      };\n\n      await this.html5QrCode.start(\n        { facingMode: 'environment' }, // Use back camera\n        config,\n        this.onScanSuccess.bind(this),\n        this.onScanFailure.bind(this)\n      );\n    } catch (error) {\n      logger.error('Failed to start scanner:', error);\n      this.isScanning = false;\n      // Clean up scanner instance on error to prevent stale state\n      this.html5QrCode = null;\n\n      // OPTIMIZATION: Type-safe error handling with single type guard check\n      // Avoid redundant instanceof checks by storing the result\n      const isErrorObject = error instanceof Error;\n      const errorName = isErrorObject ? error.name : '';\n      const errorMessage = isErrorObject ? error.message : String(error);\n\n      // Check if it's a permission error\n      if (errorName === 'NotAllowedError' || errorMessage.includes('Permission')) {\n        this.showScannerError(\n          'Kamerazugriff wurde verweigert',\n          'Bitte erlauben Sie den Kamerazugriff in Ihren Browser-Einstellungen'\n        );\n      } else if (errorName === 'NotFoundError') {\n        this.showScannerError(\n          'Keine Kamera gefunden',\n          'Bitte stellen Sie sicher, dass Ihr Gert eine Kamera hat'\n        );\n      } else {\n        this.showScannerError(\n          'Scanner konnte nicht gestartet werden',\n          'Bitte versuchen Sie die manuelle Eingabe'\n        );\n      }\n    }\n  }\n\n  /**\n   * Handle successful scan\n   */\n  private async onScanSuccess(decodedText: string, decodedResult: unknown): Promise<void> {\n    logger.info('Code detected:', decodedText);\n\n    // Stop scanner immediately\n    await this.stopScanner();\n\n    // Play success beep\n    this.playSuccessBeep();\n\n    // Show success message\n    this.showScannerSuccess(decodedText);\n\n    // Wait a moment before proceeding\n    setTimeout(async () => {\n      try {\n        await this.processScannedCode(decodedText);\n      } catch (error) {\n        logger.error('Failed to process scanned code:', error);\n        notify.error('Fehler beim Verarbeiten des QR-Codes', error as Error, {\n          title: 'Scanfehler',\n          duration: 0,\n        });\n      } finally {\n        this.closeScanner();\n      }\n    }, 800);\n  }\n\n  /**\n   * Handle scan failure (this is called continuously, so we don't show errors here)\n   */\n  private onScanFailure(error: string): void {\n    // Don't log every failure - it's called very frequently while scanning\n    // Only log if it's not the typical \"No MultiFormat Readers\" message\n    if (!error.includes('No MultiFormat Readers')) {\n      logger.debug('Scan attempt:', error);\n    }\n  }\n\n  /**\n   * Process the scanned code\n   */\n  private async processScannedCode(code: string): Promise<void> {\n    try {\n      // Trim and validate the scanned code\n      const trimmedCode = code.trim();\n      const validation = this.validateMachineId(trimmedCode);\n\n      if (!validation.valid) {\n        this.showError(validation.error || 'Ungltiger Code gescannt');\n        return;\n      }\n\n      await this.handleMachineId(trimmedCode);\n    } catch (error) {\n      logger.error('Error processing scanned code:', error);\n      this.showError('Fehler beim Verarbeiten des Codes');\n    }\n  }\n\n  /**\n   * Stop the scanner\n   */\n  private async stopScanner(): Promise<void> {\n    if (this.html5QrCode && this.isScanning) {\n      try {\n        await this.html5QrCode.stop();\n        this.html5QrCode.clear();\n      } catch (error) {\n        logger.error('Error stopping scanner:', error);\n      } finally {\n        this.isScanning = false;\n      }\n    }\n  }\n\n  /**\n   * Close scanner modal\n   */\n  private async closeScanner(): Promise<void> {\n    await this.stopScanner();\n\n    if (this.scannerModal) {\n      this.scannerModal.style.display = 'none';\n    }\n  }\n\n  /**\n   * Show scanner error\n   */\n  private showScannerError(message: string, hint?: string): void {\n    const errorDiv = document.getElementById('scanner-error');\n    const successDiv = document.getElementById('scanner-success');\n    const scannerContainer = document.getElementById('scanner-container');\n    const errorMessage = document.getElementById('scanner-error-message');\n    const errorHint = document.querySelector('.scanner-error-hint');\n\n    if (errorDiv) {\n      errorDiv.style.display = 'flex';\n    }\n    if (successDiv) {\n      successDiv.style.display = 'none';\n    }\n    if (scannerContainer) {\n      scannerContainer.style.display = 'none';\n    }\n    if (errorMessage) {\n      errorMessage.textContent = message;\n    }\n    // CRITICAL FIX: Always reset hint text (even when empty) to prevent stale hints\n    // This ensures old hints don't remain visible when new errors occur without hints\n    if (errorHint) {\n      errorHint.textContent = hint || '';\n    }\n  }\n\n  /**\n   * Show scanner success\n   */\n  private showScannerSuccess(code: string): void {\n    const errorDiv = document.getElementById('scanner-error');\n    const successDiv = document.getElementById('scanner-success');\n    const scannerContainer = document.getElementById('scanner-container');\n    const successMessage = document.getElementById('scanner-success-message');\n\n    if (errorDiv) {\n      errorDiv.style.display = 'none';\n    }\n    if (successDiv) {\n      successDiv.style.display = 'flex';\n    }\n    if (scannerContainer) {\n      scannerContainer.style.display = 'none';\n    }\n    if (successMessage) {\n      successMessage.textContent = `Code erkannt: ${code}`;\n    }\n  }\n\n  /**\n   * Play success beep sound\n   */\n  private playSuccessBeep(): void {\n    try {\n      // Create a simple beep using Web Audio API\n      const AudioContextClass = window.AudioContext || (window as typeof window & { webkitAudioContext?: typeof AudioContext }).webkitAudioContext;\n      if (!AudioContextClass) {\n        logger.warn('AudioContext not supported in this browser');\n        return;\n      }\n      const audioContext = new AudioContextClass();\n      const oscillator = audioContext.createOscillator();\n      const gainNode = audioContext.createGain();\n\n      oscillator.connect(gainNode);\n      gainNode.connect(audioContext.destination);\n\n      oscillator.frequency.value = 800; // Frequency in Hz\n      oscillator.type = 'sine';\n\n      gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);\n      gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);\n\n      oscillator.start(audioContext.currentTime);\n      oscillator.stop(audioContext.currentTime + 0.2);\n\n      // CRITICAL FIX: Close AudioContext after beep finishes to prevent resource leak\n      // Wait for sound duration (200ms) + small buffer before closing context\n      setTimeout(() => {\n        if (audioContext && audioContext.state !== 'closed') {\n          try {\n            audioContext.close();\n          } catch (error) {\n            logger.warn(' Error closing AudioContext:', error);\n          }\n        }\n      }, 250); // 200ms sound + 50ms buffer\n    } catch (error) {\n      logger.warn('Could not play beep sound:', error);\n    }\n  }\n\n  /**\n   * Handle manual input from scanner modal\n   */\n  private async handleManualInput(): Promise<void> {\n    await this.closeScanner();\n    this.openManualInputModal();\n  }\n\n  /**\n   * Handle manual machine ID submission\n   */\n  private async submitManualInput(): Promise<void> {\n    const manualInput = document.getElementById(\n      'manual-machine-id-input'\n    ) as HTMLInputElement | null;\n\n    if (!manualInput) {\n      this.showError('Manuelle Eingabe konnte nicht geladen werden');\n      return;\n    }\n\n    const trimmedCode = manualInput.value.trim();\n    const validation = this.validateMachineId(trimmedCode);\n\n    if (!validation.valid) {\n      this.showError(validation.error || 'Ungltige Maschinen-ID');\n      return;\n    }\n\n    this.closeManualInputModal();\n    await this.handleMachineId(trimmedCode);\n  }\n\n  /**\n   * Open manual input modal\n   */\n  private openManualInputModal(): void {\n    const manualInputModal = document.getElementById('manual-input-modal');\n    const manualInput = document.getElementById(\n      'manual-machine-id-input'\n    ) as HTMLInputElement | null;\n\n    if (manualInputModal) {\n      manualInputModal.style.display = 'flex';\n    }\n\n    if (manualInput) {\n      manualInput.value = '';\n      manualInput.focus();\n    }\n  }\n\n  /**\n   * Close manual input modal\n   */\n  private closeManualInputModal(): void {\n    const manualInputModal = document.getElementById('manual-input-modal');\n    if (manualInputModal) {\n      manualInputModal.style.display = 'none';\n    }\n  }\n\n  /**\n   * Handle machine selection or auto-create if missing\n   */\n  private async handleMachineId(id: string): Promise<void> {\n    try {\n      const machine = await getMachine(id);\n\n      if (machine) {\n        notify.success(`Maschine \"${machine.name}\" geladen`);\n        this.onMachineSelected(machine);\n        return;\n      }\n\n      const autoName = `Maschine ${id}`;\n      const newMachine: Machine = {\n        id,\n        name: autoName,\n        createdAt: Date.now(),\n        referenceModels: [],\n      };\n\n      await saveMachine(newMachine);\n      notify.success(`Neue Maschine \"${autoName}\" automatisch angelegt.`);\n      this.onMachineSelected(newMachine);\n    } catch (error) {\n      logger.error('Error handling machine ID:', error);\n      notify.error('Fehler beim Laden der Maschine', error as Error);\n    }\n  }\n\n  /**\n   * Handle manual machine creation\n   */\n  private async handleCreateMachine(): Promise<void> {\n    try {\n      const nameInput = document.getElementById('machine-name-input') as HTMLInputElement;\n      const idInput = document.getElementById('machine-id-input') as HTMLInputElement;\n\n      if (!nameInput || !idInput) {\n        throw new Error('Input elements not found');\n      }\n\n      const name = nameInput.value.trim();\n      const idInputValue = idInput.value.trim();\n\n      // Validate name\n      if (!name) {\n        this.showError('Bitte geben Sie einen Maschinennamen ein');\n        return;\n      }\n\n      // Validate name is not just whitespace and has reasonable length\n      if (!/\\S/.test(name)) {\n        this.showError('Maschinenname darf nicht nur aus Leerzeichen bestehen');\n        return;\n      }\n\n      if (name.length > 100) {\n        this.showError('Maschinenname ist zu lang (maximal 100 Zeichen)');\n        return;\n      }\n\n      // Generate or validate ID\n      let id: string;\n      if (idInputValue) {\n        // Validate provided ID\n        const validation = this.validateMachineId(idInputValue);\n        if (!validation.valid) {\n          this.showError(validation.error || 'Ungltige Maschinen-ID');\n          return;\n        }\n        id = idInputValue;\n      } else {\n        // Generate new ID\n        id = this.generateMachineId();\n      }\n\n      // Check if ID already exists\n      const existing = await getMachine(id);\n      if (existing) {\n        this.showError('Eine Maschine mit dieser ID existiert bereits');\n        return;\n      }\n\n      // Create new machine\n      const machine: Machine = {\n        id,\n        name,\n        createdAt: Date.now(),\n        referenceModels: [], // MULTICLASS: Initialize empty model array\n      };\n\n      await saveMachine(machine);\n\n      // DEBUG LOGGING: Show created machine\n      logger.debug(' Machine Created:', {\n        id: machine.id,\n        name: machine.name,\n        createdAt: new Date(machine.createdAt).toLocaleString(),\n      });\n      logger.debug(' Calling onMachineSelected() with new machine...');\n\n      // Clear inputs\n      nameInput.value = '';\n      idInput.value = '';\n\n      this.showNotification(`Maschine erstellt: ${name}`);\n      this.onMachineSelected(machine);\n    } catch (error) {\n      logger.error('Create machine error:', error);\n      this.showError('Fehler beim Erstellen der Maschine');\n    }\n  }\n\n  /**\n   * Generate random machine ID\n   */\n  private generateMachineId(): string {\n    const timestamp = Date.now().toString(36);\n    const random = Math.random().toString(36).substring(2, 7);\n    return `${timestamp}-${random}`.toUpperCase();\n  }\n\n  /**\n   * Validate machine ID format\n   * Ensures ID is not empty, not just whitespace, and has reasonable length\n   */\n  private validateMachineId(id: string): { valid: boolean; error?: string } {\n    // Trim whitespace\n    const trimmedId = id.trim();\n\n    // Check if empty after trimming\n    if (!trimmedId) {\n      return { valid: false, error: 'Maschinen-ID darf nicht leer sein' };\n    }\n\n    // Check minimum length (at least 1 character)\n    if (trimmedId.length < 1) {\n      return { valid: false, error: 'Maschinen-ID ist zu kurz' };\n    }\n\n    // Check maximum length (prevent excessive IDs)\n    if (trimmedId.length > 100) {\n      return { valid: false, error: 'Maschinen-ID ist zu lang (maximal 100 Zeichen)' };\n    }\n\n    // Check for only whitespace characters (extra safety)\n    if (!/\\S/.test(trimmedId)) {\n      return { valid: false, error: 'Maschinen-ID darf nicht nur aus Leerzeichen bestehen' };\n    }\n\n    return { valid: true };\n  }\n\n  /**\n   * Show notification message\n   */\n  private showNotification(message: string): void {\n    notify.success(message);\n  }\n\n  /**\n   * Show error message\n   */\n  private showError(message: string): void {\n    notify.error(message);\n  }\n\n  /**\n   * ========================================\n   * HARDWARE INTELLIGENCE\n   * ========================================\n   */\n\n  /**\n   * Initialize hardware check on page load\n   *\n   * SMART MICROPHONE AUTO-SELECTION:\n   * 1. Request initial audio permission (gets device labels)\n   * 2. Search for optimal rear/environment microphone\n   * 3. Automatically switch to best mic if found\n   * 4. Notify user of optimization\n   */\n  private async initializeHardwareCheck(): Promise<void> {\n    let tempStream: MediaStream | null = null;\n    try {\n      // Step 1: Request initial audio permission to get device labels\n      tempStream = await getRawAudioStream(this.selectedDeviceId);\n\n      // Step 2: SMART MICROPHONE AUTO-SELECTION\n      // Now that we have permission, device labels are available\n      const bestMic = await HardwareCheck.findBestMicrophone();\n\n      if (bestMic && bestMic.deviceId !== this.selectedDeviceId) {\n        logger.info(` Smart Auto-Selection: Switching to \"${bestMic.label}\"`);\n\n        // Stop the initial stream before switching\n        tempStream.getTracks().forEach((track) => track.stop());\n        tempStream = null;\n\n        // Set the optimal microphone\n        this.selectedDeviceId = bestMic.deviceId;\n\n        // Get new stream with the optimal microphone\n        tempStream = await getRawAudioStream(this.selectedDeviceId);\n\n        // Notify user of automatic optimization\n        notify.success(`Mikrofon automatisch auf \"${bestMic.label}\" optimiert fr beste Diagnose`);\n      }\n\n      // Step 3: Analyze the (potentially new) hardware\n      const currentDevice = await HardwareCheck.getCurrentDevice(tempStream);\n\n      if (currentDevice) {\n        // Get audio track settings for sample rate\n        const audioTracks = tempStream.getAudioTracks();\n        if (audioTracks.length === 0) {\n          logger.warn('No audio tracks found on device');\n          return;\n        }\n        const audioTrack = audioTracks[0];\n        const settings = audioTrack.getSettings();\n        const sampleRate = settings.sampleRate || 44100;\n\n        // Analyze hardware\n        this.audioQualityReport = HardwareCheck.analyzeCurrentDevice(\n          currentDevice.label,\n          sampleRate\n        );\n\n        // Update UI\n        this.updateHardwareInfoCard();\n      }\n    } catch (error) {\n      logger.error('Failed to initialize hardware check:', error);\n      // Don't block user flow - just log the error\n    } finally {\n      // CRITICAL FIX: Stop temporary stream after hardware check (success or failure)\n      // This prevents resource leak and keeps microphone available for actual recordings\n      if (tempStream) {\n        tempStream.getTracks().forEach((track) => track.stop());\n        tempStream = null;\n      }\n    }\n  }\n\n  /**\n   * Update hardware info card in UI\n   */\n  private updateHardwareInfoCard(): void {\n    if (!this.audioQualityReport) {\n      return;\n    }\n\n    const statusIcon = document.getElementById('hardware-status-icon');\n    const deviceLabel = document.getElementById('hardware-device-label');\n    const statusText = document.getElementById('hardware-status-text');\n\n    if (!statusIcon || !deviceLabel || !statusText) {\n      return;\n    }\n\n    // Update device label\n    deviceLabel.textContent = this.audioQualityReport.deviceLabel;\n\n    // Update status icon and text\n    if (this.audioQualityReport.status === 'good') {\n      statusIcon.innerHTML = `\n        <svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"var(--status-healthy)\" stroke-width=\"2\">\n          <path d=\"M22 11.08V12a10 10 0 1 1-5.93-9.14\"/>\n          <polyline points=\"22 4 12 14.01 9 11.01\"/>\n        </svg>\n      `;\n      statusText.textContent = this.audioQualityReport.reason;\n      statusText.style.color = 'var(--status-healthy)';\n    } else {\n      statusIcon.innerHTML = `\n        <svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"var(--status-warning)\" stroke-width=\"2\">\n          <path d=\"M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z\"/>\n          <line x1=\"12\" y1=\"9\" x2=\"12\" y2=\"13\"/>\n          <line x1=\"12\" y1=\"17\" x2=\"12.01\" y2=\"17\"/>\n        </svg>\n      `;\n      statusText.textContent = this.audioQualityReport.reason;\n      statusText.style.color = 'var(--status-warning)';\n    }\n  }\n\n  /**\n   * Show microphone selection modal\n   */\n  private async showMicrophoneSelection(): Promise<void> {\n    try {\n      const devices = await HardwareCheck.getAvailableDevices();\n\n      // Get or create modal\n      const modal = document.getElementById('microphone-selection-modal');\n      if (!modal) {\n        logger.error('Microphone selection modal not found in DOM');\n        return;\n      }\n\n      // Populate device list\n      const deviceList = document.getElementById('microphone-device-list');\n      if (!deviceList) {\n        logger.error('Device list container not found');\n        return;\n      }\n\n      deviceList.innerHTML = '';\n\n      devices.forEach((device) => {\n        const deviceItem = document.createElement('div');\n        deviceItem.className = 'microphone-device-item';\n        deviceItem.dataset.deviceId = device.deviceId;\n\n        // Check if this is the currently selected device\n        const isSelected =\n          this.selectedDeviceId === device.deviceId ||\n          (!this.selectedDeviceId && device.deviceId === 'default');\n\n        if (isSelected) {\n          deviceItem.classList.add('selected');\n        }\n\n        // Analyze this device\n        // CRITICAL FIX: Use sample rate from AUDIO_CONSTRAINTS instead of hardcoded value\n        // Note: This is the requested rate - actual rate will be determined when stream is created\n        const estimatedSampleRate = AUDIO_CONSTRAINTS.audio.sampleRate;\n        const tempReport = HardwareCheck.analyzeCurrentDevice(device.label, estimatedSampleRate);\n        const statusClass = tempReport.status === 'good' ? 'status-good' : 'status-warning';\n\n        // CRITICAL FIX: Use safe DOM manipulation instead of innerHTML to prevent XSS\n        // Create device info container\n        const deviceInfo = document.createElement('div');\n        deviceInfo.className = 'device-info';\n\n        // Create device icon with status\n        const deviceIcon = document.createElement('div');\n        deviceIcon.className = `device-icon ${statusClass}`;\n\n        // Add appropriate SVG based on status (safe static content)\n        if (tempReport.status === 'good') {\n          deviceIcon.innerHTML = `<svg width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\">\n                      <path d=\"M22 11.08V12a10 10 0 1 1-5.93-9.14\"/>\n                      <polyline points=\"22 4 12 14.01 9 11.01\"/>\n                    </svg>`;\n        } else {\n          deviceIcon.innerHTML = `<svg width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\">\n                      <path d=\"M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z\"/>\n                      <line x1=\"12\" y1=\"9\" x2=\"12\" y2=\"13\"/>\n                      <line x1=\"12\" y1=\"17\" x2=\"12.01\" y2=\"17\"/>\n                    </svg>`;\n        }\n\n        // Create device details container\n        const deviceDetails = document.createElement('div');\n        deviceDetails.className = 'device-details';\n\n        // Use textContent instead of innerHTML to prevent XSS attacks\n        const deviceName = document.createElement('div');\n        deviceName.className = 'device-name';\n        deviceName.textContent = device.label; // SAFE - textContent escapes HTML\n\n        const deviceStatus = document.createElement('div');\n        deviceStatus.className = 'device-status';\n        deviceStatus.textContent = tempReport.reason; // SAFE - textContent escapes HTML\n\n        // Assemble the structure\n        deviceDetails.appendChild(deviceName);\n        deviceDetails.appendChild(deviceStatus);\n        deviceInfo.appendChild(deviceIcon);\n        deviceInfo.appendChild(deviceDetails);\n        deviceItem.appendChild(deviceInfo);\n\n        // Add checkmark for selected device\n        if (isSelected) {\n          const checkmark = document.createElement('div');\n          checkmark.className = 'device-checkmark';\n          checkmark.innerHTML = `<svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"var(--primary-color)\" stroke-width=\"3\"><polyline points=\"20 6 9 17 4 12\"/></svg>`;\n          deviceItem.appendChild(checkmark);\n        }\n\n        deviceItem.addEventListener('click', () => this.selectMicrophone(device));\n        deviceList.appendChild(deviceItem);\n      });\n\n      // Show modal\n      modal.style.display = 'flex';\n\n      // Setup close handlers\n      const closeBtn = document.getElementById('close-microphone-modal');\n      if (closeBtn) {\n        closeBtn.onclick = () => this.closeMicrophoneModal();\n      }\n\n      modal.onclick = (e) => {\n        if (e.target === modal) {\n          this.closeMicrophoneModal();\n        }\n      };\n    } catch (error) {\n      logger.error('Failed to show microphone selection:', error);\n      this.showError('Fehler beim Laden der Mikrofone');\n    }\n  }\n\n  /**\n   * Select a microphone\n   */\n  private async selectMicrophone(device: AudioDeviceInfo): Promise<void> {\n    try {\n      logger.info(`Selecting microphone: ${device.label}`);\n\n      // Stop current stream\n      if (this.currentAudioStream) {\n        this.currentAudioStream.getTracks().forEach((track) => track.stop());\n      }\n\n      // Update selected device\n      this.selectedDeviceId = device.deviceId;\n\n      // Get new stream with selected device\n      this.currentAudioStream = await getRawAudioStream(device.deviceId);\n\n      // Re-analyze hardware\n      const audioTracks = this.currentAudioStream.getAudioTracks();\n      if (audioTracks.length === 0) {\n        throw new Error('No audio tracks available on selected device');\n      }\n      const audioTrack = audioTracks[0];\n      const settings = audioTrack.getSettings();\n      const sampleRate = settings.sampleRate || 44100;\n\n      this.audioQualityReport = HardwareCheck.analyzeCurrentDevice(device.label, sampleRate);\n\n      // Update UI\n      this.updateHardwareInfoCard();\n\n      // Close modal\n      this.closeMicrophoneModal();\n\n      // Notify user\n      notify.success(`Mikrofon gewechselt: ${device.label}`);\n    } catch (error) {\n      logger.error('Failed to select microphone:', error);\n      this.showError('Fehler beim Wechseln des Mikrofons');\n    }\n  }\n\n  /**\n   * Close microphone selection modal\n   */\n  private closeMicrophoneModal(): void {\n    const modal = document.getElementById('microphone-selection-modal');\n    if (modal) {\n      modal.style.display = 'none';\n    }\n  }\n\n  /**\n   * Get selected device ID for recording\n   * Called by other phases that need to record audio\n   */\n  public getSelectedDeviceId(): string | undefined {\n    return this.selectedDeviceId;\n  }\n\n  /**\n   * ========================================\n   * MACHINE HISTORY / QUICK SELECT\n   * ========================================\n   */\n\n  /**\n   * Load machine history and render quick select list\n   */\n  private async loadMachineHistory(): Promise<void> {\n    try {\n      // Get all machines from database\n      const machines = await getAllMachines();\n\n      // Filter machines that have at least one trained model\n      const trainedMachines = machines.filter(\n        (machine) => machine.referenceModels && machine.referenceModels.length > 0\n      );\n\n      // Sort by most recent training date (newest first)\n      trainedMachines.sort((a, b) => {\n        // Get latest training date for each machine (defensive: handle edge cases)\n        const aLatestDate =\n          a.referenceModels.length > 0\n            ? Math.max(...a.referenceModels.map((m) => m.trainingDate || 0))\n            : 0;\n        const bLatestDate =\n          b.referenceModels.length > 0\n            ? Math.max(...b.referenceModels.map((m) => m.trainingDate || 0))\n            : 0;\n        return bLatestDate - aLatestDate;\n      });\n\n      // Render the quick select list (max 10 machines)\n      this.renderQuickSelectList(trainedMachines.slice(0, 10));\n    } catch (error) {\n      logger.error('Failed to load machine history:', error);\n      // Don't show error to user - just hide the quick select section\n      this.hideQuickSelectSection();\n    }\n  }\n\n  /**\n   * Render quick select list with recent machines\n   */\n  private renderQuickSelectList(machines: Machine[]): void {\n    const quickSelectSection = document.getElementById('quick-select-section');\n    const quickSelectList = document.getElementById('quick-select-list');\n\n    if (!quickSelectSection || !quickSelectList) {\n      logger.warn('Quick select elements not found in DOM');\n      return;\n    }\n\n    // Hide section if no machines available\n    if (machines.length === 0) {\n      quickSelectSection.style.display = 'none';\n      return;\n    }\n\n    // Show section\n    quickSelectSection.style.display = 'block';\n\n    // Clear existing list\n    quickSelectList.innerHTML = '';\n\n    // Render each machine\n    machines.forEach((machine) => {\n      const machineItem = document.createElement('div');\n      machineItem.className = 'quick-select-item';\n      machineItem.dataset.machineId = machine.id;\n\n      // Create machine info\n      const machineInfo = document.createElement('div');\n      machineInfo.className = 'quick-select-item-info';\n\n      const machineName = document.createElement('div');\n      machineName.className = 'quick-select-machine-name';\n      machineName.textContent = machine.name;\n\n      const machineId = document.createElement('div');\n      machineId.className = 'quick-select-machine-id';\n      machineId.textContent = machine.id;\n\n      machineInfo.appendChild(machineName);\n      machineInfo.appendChild(machineId);\n\n      // Create chevron icon\n      const chevron = document.createElementNS('http://www.w3.org/2000/svg', 'svg');\n      chevron.setAttribute('width', '20');\n      chevron.setAttribute('height', '20');\n      chevron.setAttribute('viewBox', '0 0 24 24');\n      chevron.setAttribute('fill', 'none');\n      chevron.setAttribute('stroke', 'currentColor');\n      chevron.setAttribute('stroke-width', '2');\n      chevron.style.color = 'var(--text-muted)';\n      chevron.style.flexShrink = '0';\n\n      const polyline = document.createElementNS('http://www.w3.org/2000/svg', 'polyline');\n      polyline.setAttribute('points', '9 18 15 12 9 6');\n      chevron.appendChild(polyline);\n\n      // Assemble item\n      machineItem.appendChild(machineInfo);\n      machineItem.appendChild(chevron);\n\n      // Add click handler\n      machineItem.addEventListener('click', () => this.handleQuickSelect(machine));\n\n      // Add to list\n      quickSelectList.appendChild(machineItem);\n    });\n  }\n\n  /**\n   * Handle quick select machine click\n   */\n  private async handleQuickSelect(machine: Machine): Promise<void> {\n    try {\n      logger.info(`Quick select: ${machine.name} (${machine.id})`);\n\n      // DEBUG LOGGING: Show quick-selected machine\n      logger.debug(' Quick-Select Clicked:', {\n        id: machine.id,\n        name: machine.name,\n        numModels: machine.referenceModels?.length || 0,\n      });\n      logger.debug(' Calling onMachineSelected() with quick-selected machine...');\n\n      this.showNotification(`Maschine geladen: ${machine.name}`);\n      this.onMachineSelected(machine);\n    } catch (error) {\n      logger.error('Failed to quick select machine:', error);\n      this.showError('Fehler beim Laden der Maschine');\n    }\n  }\n\n  /**\n   * Hide quick select section\n   */\n  private hideQuickSelectSection(): void {\n    const quickSelectSection = document.getElementById('quick-select-section');\n    if (quickSelectSection) {\n      quickSelectSection.style.display = 'none';\n    }\n  }\n\n  /**\n   * Cleanup on phase exit\n   */\n  public cleanup(): void {\n    if (this.currentAudioStream) {\n      this.currentAudioStream.getTracks().forEach((track) => track.stop());\n      this.currentAudioStream = null;\n    }\n  }\n}\n","export type VisualizerScale = 'linear' | 'log';\n\nexport type VisualizerSettings = {\n  frequencyScale: VisualizerScale;\n  amplitudeScale: VisualizerScale;\n};\n\nexport const VISUALIZER_SETTINGS_EVENT = 'zanobot:visualizer-settings-change';\n\nconst STORAGE_KEY = 'zanobot.visualizer.settings';\n\nconst defaultSettings: VisualizerSettings = {\n  frequencyScale: 'linear',\n  amplitudeScale: 'linear',\n};\n\nconst readFromStorage = (): VisualizerSettings => {\n  try {\n    const raw = localStorage.getItem(STORAGE_KEY);\n    if (!raw) {\n      return { ...defaultSettings };\n    }\n    const parsed = JSON.parse(raw) as Partial<VisualizerSettings>;\n    return {\n      frequencyScale: parsed.frequencyScale === 'log' ? 'log' : 'linear',\n      amplitudeScale: parsed.amplitudeScale === 'log' ? 'log' : 'linear',\n    };\n  } catch {\n    return { ...defaultSettings };\n  }\n};\n\nexport const getVisualizerSettings = (): VisualizerSettings => readFromStorage();\n\nexport const setVisualizerSettings = (\n  updates: Partial<VisualizerSettings>\n): VisualizerSettings => {\n  const current = readFromStorage();\n  const next: VisualizerSettings = {\n    frequencyScale: updates.frequencyScale ?? current.frequencyScale,\n    amplitudeScale: updates.amplitudeScale ?? current.amplitudeScale,\n  };\n\n  try {\n    localStorage.setItem(STORAGE_KEY, JSON.stringify(next));\n  } catch {\n    // Ignore storage errors (e.g., private mode) and still broadcast.\n  }\n\n  window.dispatchEvent(\n    new CustomEvent<VisualizerSettings>(VISUALIZER_SETTINGS_EVENT, { detail: next })\n  );\n\n  return next;\n};\n","/**\n * ZANOBOT - AUDIO VISUALIZER COMPONENT\n *\n * Professional real-time FFT frequency spectrum visualization.\n *\n * Features:\n * - Frequency domain analysis (0-22kHz)\n * - Smooth gradient (Green  Yellow  Red for intensity)\n * - 60 FPS rendering\n * - High resolution (fftSize = 2048)\n * - Shows machine acoustic signatures (peaks, resonances)\n */\n\nimport { logger } from '@utils/logger.js';\nimport { isIOS } from '@utils/platform.js';\nimport {\n  getVisualizerSettings,\n  VISUALIZER_SETTINGS_EVENT,\n  type VisualizerSettings,\n} from '@utils/visualizerSettings.js';\n\nexport class AudioVisualizer {\n  private canvas: HTMLCanvasElement;\n  private ctx: CanvasRenderingContext2D;\n  private analyser: AnalyserNode | null = null;\n  private animationFrame: number | null = null;\n  private dataArray: Uint8Array | null = null;\n  private visualizerSettings: VisualizerSettings;\n  private settingsListener: ((event: Event) => void) | null = null;\n\n  // CRITICAL FIX: Store audio source reference to properly disconnect in stop()\n  // Without this, the audio graph continues running and causes resource leaks\n  private source: MediaStreamAudioSourceNode | null = null;\n  // CRITICAL FIX: Add gain node for signal amplification\n  private gainNode: GainNode | null = null;\n\n  // Visualization settings\n  private fftSize: number = 2048; // High resolution for bass/mid analysis\n  private smoothing: number = 0.75; // Smooth transitions (0-1)\n  private barCount: number = 128; // Number of frequency bars\n\n  // CRITICAL FIX: Store actual sample rate from AudioContext for correct frequency labels\n  private sampleRate: number = 48000; // Default to 48 kHz, updated in start()\n\n  constructor(canvasId: string) {\n    const canvas = document.getElementById(canvasId) as HTMLCanvasElement;\n    if (!canvas) {\n      throw new Error(`Canvas element not found: ${canvasId}`);\n    }\n\n    this.canvas = canvas;\n    const ctx = canvas.getContext('2d');\n    if (!ctx) {\n      throw new Error('Could not get 2D context');\n    }\n\n    this.ctx = ctx;\n    this.setCanvasSize();\n\n    this.visualizerSettings = getVisualizerSettings();\n    this.settingsListener = (event: Event) => {\n      const detail = (event as CustomEvent<VisualizerSettings>).detail;\n      if (detail) {\n        this.visualizerSettings = detail;\n      }\n    };\n    window.addEventListener(VISUALIZER_SETTINGS_EVENT, this.settingsListener);\n  }\n\n  private setCanvasSize(): void {\n    const dpr = window.devicePixelRatio || 1;\n    const rect = this.canvas.getBoundingClientRect();\n\n    this.canvas.width = rect.width * dpr;\n    this.canvas.height = rect.height * dpr;\n\n    this.ctx.setTransform(1, 0, 0, 1, 0, 0);\n    this.ctx.scale(dpr, dpr);\n  }\n\n  /**\n   * Start visualization from audio stream\n   *\n   * @param audioContext - Web Audio API context\n   * @param stream - MediaStream from microphone\n   */\n  public start(audioContext: AudioContext, stream: MediaStream): void {\n    // CRITICAL FIX: Stop previous render loop to prevent parallel loops\n    this.stop();\n\n    // CRITICAL FIX: Store actual sample rate from AudioContext for correct frequency labels\n    this.sampleRate = audioContext.sampleRate;\n\n    // Create analyser node with high resolution\n    this.analyser = audioContext.createAnalyser();\n    this.analyser.fftSize = this.fftSize;\n    this.analyser.smoothingTimeConstant = this.smoothing;\n    this.analyser.minDecibels = -90;\n    this.analyser.maxDecibels = -10;\n\n    // CRITICAL FIX: Add GainNode for signal amplification to improve visualization\n    // Amplify the microphone signal by 3x to make weak signals more visible in the spectrogram\n    this.gainNode = audioContext.createGain();\n    this.gainNode.gain.value = isIOS() ? 3.0 : 1.0; // iOS boost only; keep Android/Desktop unchanged\n\n    // CRITICAL FIX: Store source reference for proper cleanup in stop()\n    // Without storing the reference, we cannot disconnect it later,\n    // causing the audio graph to continue running (resource leak)\n    this.source = audioContext.createMediaStreamSource(stream);\n    this.source.connect(this.gainNode);\n    this.gainNode.connect(this.analyser);\n\n    // Create data array for frequency data\n    const bufferLength = this.analyser.frequencyBinCount; // fftSize / 2\n    this.dataArray = new Uint8Array(bufferLength);\n\n    logger.debug(\n      ` FFT Visualizer started: ${this.fftSize} samples, ${bufferLength} bins, sampleRate=${this.sampleRate}Hz`\n    );\n\n    // Start rendering at 60 FPS\n    this.render();\n  }\n\n  /**\n   * Stop visualization\n   *\n   * CRITICAL FIX: Disconnect audio source to prevent resource leaks.\n   * Without disconnecting, the audio graph continues running even after\n   * visualization stops, consuming CPU and memory resources.\n   */\n  public stop(): void {\n    if (this.animationFrame) {\n      cancelAnimationFrame(this.animationFrame);\n      this.animationFrame = null;\n    }\n\n    // CRITICAL FIX: Disconnect audio source from audio graph\n    // This prevents resource leaks by properly cleaning up the audio connection\n    if (this.source) {\n      this.source.disconnect();\n      this.source = null;\n    }\n\n    // CRITICAL FIX: Disconnect and clean up gain node\n    if (this.gainNode) {\n      this.gainNode.disconnect();\n      this.gainNode = null;\n    }\n\n    this.analyser = null;\n    this.dataArray = null;\n\n    // Clear canvas\n    const width = this.canvas.width / (window.devicePixelRatio || 1);\n    const height = this.canvas.height / (window.devicePixelRatio || 1);\n    this.ctx.clearRect(0, 0, width, height);\n  }\n\n  /**\n   * Render frequency spectrum (60 FPS)\n   *\n   * Visual strategy:\n   * - X-axis: Frequency (0 Hz  ~22 kHz)\n   * - Y-axis: Amplitude (dB)\n   * - Color: Intensity gradient (Green  Yellow  Red)\n   */\n  private render(): void {\n    if (!this.analyser || !this.dataArray) {\n      return;\n    }\n\n    const width = this.canvas.width / (window.devicePixelRatio || 1);\n    const height = this.canvas.height / (window.devicePixelRatio || 1);\n\n    // Get frequency data (0-255 values)\n    // @ts-expect-error - Type mismatch between browser types\n    this.analyser.getByteFrequencyData(this.dataArray);\n\n    // Clear canvas with theme-aware background\n    const bgColor = getComputedStyle(document.documentElement).getPropertyValue('--viz-bg').trim();\n    this.ctx.fillStyle = bgColor || '#0a0a0a';\n    this.ctx.fillRect(0, 0, width, height);\n\n    // Draw grid lines (optional, for professional look)\n    this.drawGrid(width, height);\n\n    // Draw frequency spectrum\n    this.drawSpectrum(width, height);\n\n    // Draw frequency labels\n    this.drawFrequencyLabels(width, height);\n\n    // Continue animation at 60 FPS\n    this.animationFrame = requestAnimationFrame(() => this.render());\n  }\n\n  /**\n   * Draw background grid\n   */\n  private drawGrid(width: number, height: number): void {\n    // Use theme-aware grid color\n    const gridColor = getComputedStyle(document.documentElement)\n      .getPropertyValue('--viz-grid')\n      .trim();\n    this.ctx.strokeStyle = gridColor || 'rgba(255, 255, 255, 0.05)';\n    this.ctx.lineWidth = 1;\n\n    // Horizontal lines (amplitude)\n    for (let i = 0; i <= 4; i++) {\n      const y = (height / 4) * i;\n      this.ctx.beginPath();\n      this.ctx.moveTo(0, y);\n      this.ctx.lineTo(width, y);\n      this.ctx.stroke();\n    }\n\n    // Vertical lines (frequency markers)\n    const markers = [0, 0.25, 0.5, 0.75, 1]; // 0%, 25%, 50%, 75%, 100%\n    markers.forEach((marker) => {\n      const x = width * marker;\n      this.ctx.beginPath();\n      this.ctx.moveTo(x, 0);\n      this.ctx.lineTo(x, height);\n      this.ctx.stroke();\n    });\n  }\n\n  /**\n   * Draw frequency spectrum as filled bars\n   *\n   * Strategy: Linear frequency distribution (could be log scale for pro audio)\n   */\n  private drawSpectrum(width: number, height: number): void {\n    if (!this.dataArray) return;\n\n    const barWidth = width / this.barCount;\n\n    for (let i = 0; i < this.barCount; i++) {\n      const normalizedValue = this.getNormalizedValueForBar(i);\n\n      // Calculate bar height\n      const barHeight = normalizedValue * height;\n\n      // Get color based on INTENSITY (not frequency)\n      const color = this.getIntensityColor(normalizedValue);\n\n      // Draw bar\n      const x = i * barWidth;\n      const y = height - barHeight;\n\n      // Fill bar with gradient\n      this.ctx.fillStyle = color;\n      this.ctx.fillRect(x, y, barWidth - 1, barHeight);\n\n      // Add subtle glow effect for high values\n      if (normalizedValue > 0.7) {\n        this.ctx.shadowBlur = 10;\n        this.ctx.shadowColor = color;\n        this.ctx.fillRect(x, y, barWidth - 1, barHeight);\n        this.ctx.shadowBlur = 0;\n      }\n    }\n\n    // Optional: Draw filled spectrum (polygon)\n    this.drawFilledSpectrum(width, height);\n  }\n\n  /**\n   * Draw filled spectrum line (alternative style)\n   */\n  private drawFilledSpectrum(width: number, height: number): void {\n    if (!this.dataArray) return;\n\n    const points: { x: number; y: number }[] = [];\n    const barWidth = width / this.barCount;\n\n    // Collect points\n    for (let i = 0; i < this.barCount; i++) {\n      const normalizedValue = this.getNormalizedValueForBar(i);\n      const barHeight = normalizedValue * height;\n\n      points.push({\n        x: i * barWidth + barWidth / 2,\n        y: height - barHeight,\n      });\n    }\n\n    // Draw smooth line\n    if (points.length > 1) {\n      this.ctx.beginPath();\n      this.ctx.moveTo(0, height);\n\n      // Draw to first point\n      this.ctx.lineTo(points[0].x, points[0].y);\n\n      // Draw smooth curve through points\n      for (let i = 0; i < points.length - 1; i++) {\n        const xc = (points[i].x + points[i + 1].x) / 2;\n        const yc = (points[i].y + points[i + 1].y) / 2;\n        this.ctx.quadraticCurveTo(points[i].x, points[i].y, xc, yc);\n      }\n\n      // Last point\n      const lastPoint = points[points.length - 1];\n      this.ctx.lineTo(lastPoint.x, lastPoint.y);\n      this.ctx.lineTo(width, height);\n      this.ctx.closePath();\n\n      // Fill with subtle gradient (theme-aware)\n      const computedStyle = getComputedStyle(document.documentElement);\n      const fillTop = computedStyle.getPropertyValue('--viz-fill-top').trim();\n      const fillBottom = computedStyle.getPropertyValue('--viz-fill-bottom').trim();\n      const vizPrimary = computedStyle.getPropertyValue('--viz-primary').trim();\n\n      const gradient = this.ctx.createLinearGradient(0, 0, 0, height);\n      gradient.addColorStop(0, fillTop || 'rgba(59, 130, 246, 0.3)');\n      gradient.addColorStop(1, fillBottom || 'rgba(59, 130, 246, 0.05)');\n\n      this.ctx.fillStyle = gradient;\n      this.ctx.fill();\n\n      // Stroke line (theme-aware)\n      this.ctx.strokeStyle = vizPrimary || 'rgba(59, 130, 246, 0.8)';\n      this.ctx.lineWidth = 2;\n      this.ctx.stroke();\n    }\n  }\n\n  /**\n   * Get color based on intensity (Theme-aware gradient)\n   *\n   * @param intensity - Normalized value (0-1)\n   * @returns CSS color string\n   */\n  private getIntensityColor(intensity: number): string {\n    // Get theme colors from CSS variables\n    const computedStyle = getComputedStyle(document.documentElement);\n    const primaryColor = computedStyle.getPropertyValue('--primary-color').trim();\n    const accentColor = computedStyle.getPropertyValue('--accent-color').trim();\n\n    // For low intensity, use primary color\n    if (intensity < 0.5) {\n      // Extract RGB from hex or use fallback\n      const rgb = this.hexToRgb(primaryColor) || { r: 0, g: 243, b: 255 };\n      return `rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, ${0.3 + intensity})`;\n    }\n    // For high intensity, blend to accent color (orange in neon theme)\n    else {\n      const rgb = this.hexToRgb(accentColor) || { r: 255, g: 136, b: 0 };\n      return `rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, ${0.6 + intensity * 0.4})`;\n    }\n  }\n\n  /**\n   * Convert hex color to RGB\n   * @param hex - Hex color string (e.g., \"#00f3ff\")\n   * @returns RGB object or null\n   */\n  private hexToRgb(hex: string): { r: number; g: number; b: number } | null {\n    // Remove # if present\n    hex = hex.replace('#', '');\n\n    // Parse hex\n    if (hex.length === 6) {\n      return {\n        r: parseInt(hex.substring(0, 2), 16),\n        g: parseInt(hex.substring(2, 4), 16),\n        b: parseInt(hex.substring(4, 6), 16),\n      };\n    }\n    return null;\n  }\n\n  /**\n   * Draw frequency labels (Hz)\n   *\n   * CRITICAL FIX: Use actual sample rate from AudioContext instead of hardcoded 44.1kHz\n   * This ensures labels are correct for 48kHz (or any other sample rate)\n   */\n  private drawFrequencyLabels(width: number, height: number): void {\n    // CRITICAL FIX: Use actual sample rate from AudioContext (e.g., 48000 Hz)\n    const maxFreq = this.sampleRate / 2; // Nyquist frequency\n    const isLogScale = this.visualizerSettings.frequencyScale === 'log';\n\n    // Calculate frequency labels dynamically based on actual sample rate\n    // Format: 0 Hz, 25%, 50%, 75%, 100% of Nyquist frequency\n    const formatFreq = (freq: number): string => {\n      if (freq === 0) return '0';\n      if (freq >= 1000) return `${Math.round(freq / 1000)}k`;\n      return freq.toString();\n    };\n\n    const labels = isLogScale\n      ? [\n          { pos: 0, freq: 0 },\n          { freq: 20 },\n          { freq: 50 },\n          { freq: 100 },\n          { freq: 500 },\n          { freq: 1000 },\n          { freq: 5000 },\n          { freq: 10000 },\n          { freq: maxFreq },\n        ].map((label) => {\n          if (label.freq === 0) {\n            return { pos: 0, freq: 0 };\n          }\n          const minFreq = Math.min(20, maxFreq);\n          const logMin = Math.log10(minFreq);\n          const logMax = Math.log10(maxFreq);\n          const clamped = Math.min(Math.max(label.freq, minFreq), maxFreq);\n          const pos = (Math.log10(clamped) - logMin) / (logMax - logMin);\n          return { pos, freq: clamped };\n        })\n      : [\n          { pos: 0, freq: 0 },\n          { pos: 0.25, freq: maxFreq * 0.25 },\n          { pos: 0.5, freq: maxFreq * 0.5 },\n          { pos: 0.75, freq: maxFreq * 0.75 },\n          { pos: 1, freq: maxFreq },\n        ];\n\n    // Use theme-aware text color\n    const textColor = getComputedStyle(document.documentElement)\n      .getPropertyValue('--viz-text')\n      .trim();\n\n    // Use theme-aware font family from CSS variables\n    const fontFamily = getComputedStyle(document.documentElement)\n      .getPropertyValue('--font-primary')\n      .trim() || 'system-ui, sans-serif';\n    this.ctx.font = `10px ${fontFamily}`;\n    this.ctx.fillStyle = textColor || 'rgba(255, 255, 255, 0.4)';\n    this.ctx.textAlign = 'center';\n\n    labels.forEach((label) => {\n      const x = width * label.pos;\n      const y = height - 5;\n      this.ctx.fillText(formatFreq(label.freq) + ' Hz', x, y);\n    });\n\n    // Draw amplitude label\n    this.ctx.textAlign = 'left';\n    const amplitudeLabel =\n      this.visualizerSettings.amplitudeScale === 'log' ? 'Amplitude (dB, log)' : 'Amplitude (dB)';\n    this.ctx.fillText(amplitudeLabel, 5, 15);\n  }\n\n  /**\n   * Draw static waveform from audio buffer (legacy, for reference recording)\n   *\n   * @param audioBuffer - Recorded audio buffer\n   */\n  public drawWaveform(audioBuffer: AudioBuffer): void {\n    const width = this.canvas.width / (window.devicePixelRatio || 1);\n    const height = this.canvas.height / (window.devicePixelRatio || 1);\n\n    // Clear canvas with theme-aware background\n    const bgColor = getComputedStyle(document.documentElement).getPropertyValue('--viz-bg').trim();\n    this.ctx.fillStyle = bgColor || '#0a0a0a';\n    this.ctx.fillRect(0, 0, width, height);\n\n    // CRITICAL FIX: Guard against zero width (would cause step=Infinity and NaN coordinates)\n    if (width <= 0) {\n      return;\n    }\n\n    // Get channel data\n    const channelData = audioBuffer.getChannelData(0);\n    const step = Math.ceil(channelData.length / width);\n\n    // Draw waveform (theme-aware)\n    const vizPrimary = getComputedStyle(document.documentElement)\n      .getPropertyValue('--viz-primary')\n      .trim();\n    this.ctx.strokeStyle = vizPrimary || '#3b82f6';\n    this.ctx.lineWidth = 2;\n    this.ctx.beginPath();\n\n    for (let i = 0; i < width; i++) {\n      const index = i * step;\n      const value = channelData[index];\n\n      const x = i;\n      const y = ((1 + value) * height) / 2; // Normalize to canvas height\n\n      if (i === 0) {\n        this.ctx.moveTo(x, y);\n      } else {\n        this.ctx.lineTo(x, y);\n      }\n    }\n\n    this.ctx.stroke();\n\n    // Draw center line (theme-aware)\n    const gridColor = getComputedStyle(document.documentElement)\n      .getPropertyValue('--viz-grid')\n      .trim();\n    this.ctx.strokeStyle = gridColor || '#333333';\n    this.ctx.lineWidth = 1;\n    this.ctx.beginPath();\n    this.ctx.moveTo(0, height / 2);\n    this.ctx.lineTo(width, height / 2);\n    this.ctx.stroke();\n  }\n\n  /**\n   * Destroy the component and clean up\n   */\n  public destroy(): void {\n    this.stop();\n    if (this.settingsListener) {\n      window.removeEventListener(VISUALIZER_SETTINGS_EVENT, this.settingsListener);\n    }\n  }\n\n  private getNormalizedValueForBar(barIndex: number): number {\n    if (!this.dataArray) return 0;\n\n    const { start, end } = this.getFrequencyBinRange(barIndex);\n    let sum = 0;\n    let count = 0;\n\n    for (let i = start; i < end; i++) {\n      if (i >= 0 && i < this.dataArray.length) {\n        sum += this.dataArray[i];\n        count++;\n      }\n    }\n\n    const value = count > 0 ? sum / count : 0;\n    let normalizedValue = value / 255;\n\n    if (this.visualizerSettings.amplitudeScale === 'log') {\n      normalizedValue = Math.log10(1 + normalizedValue * 9);\n    }\n\n    return normalizedValue;\n  }\n\n  private getFrequencyBinRange(barIndex: number): { start: number; end: number } {\n    if (!this.dataArray) {\n      return { start: 0, end: 0 };\n    }\n\n    const totalBins = this.dataArray.length;\n    const maxBinIndex = totalBins - 1;\n\n    if (this.visualizerSettings.frequencyScale !== 'log' || this.sampleRate <= 0) {\n      const binStep = Math.max(1, Math.floor(totalBins / this.barCount));\n      const start = Math.min(barIndex * binStep, totalBins - 1);\n      const end = Math.min(start + binStep, totalBins);\n      return { start, end };\n    }\n\n    const maxFreq = this.sampleRate / 2;\n    const minFreq = Math.min(20, maxFreq);\n\n    if (maxFreq <= minFreq) {\n      const binStep = Math.max(1, Math.floor(totalBins / this.barCount));\n      const start = Math.min(barIndex * binStep, totalBins - 1);\n      const end = Math.min(start + binStep, totalBins);\n      return { start, end };\n    }\n\n    const logMin = Math.log10(minFreq);\n    const logMax = Math.log10(maxFreq);\n    const ratioStart = barIndex / this.barCount;\n    const ratioEnd = (barIndex + 1) / this.barCount;\n\n    const startFreq =\n      barIndex === 0 ? 0 : Math.pow(10, logMin + (logMax - logMin) * ratioStart);\n    const endFreq = Math.pow(10, logMin + (logMax - logMin) * ratioEnd);\n\n    const start = Math.floor((startFreq / maxFreq) * maxBinIndex);\n    const end = Math.min(\n      maxBinIndex + 1,\n      Math.max(start + 1, Math.ceil((endFreq / maxFreq) * maxBinIndex))\n    );\n\n    return { start, end };\n  }\n}\n","/**\n * ZANOBOT - AUDIO WORKLET HELPER\n *\n * Modern audio processing using AudioWorklet instead of deprecated ScriptProcessorNode.\n *\n * Benefits:\n * - Runs on separate audio thread (no main thread blocking)\n * - Lower latency\n * - Better performance\n * - Future-proof (ScriptProcessorNode is deprecated)\n */\n\nimport { logger } from '@utils/logger.js';\nimport type { SmartStartState } from './audioHelper.js';\n\nexport interface AudioWorkletConfig {\n  bufferSize: number;\n  warmUpDuration?: number; // Optional warmup duration in ms (defaults to DEFAULT_SMART_START_CONFIG)\n  onAudioData?: (writePos: number) => void;\n  onAudioChunk?: (chunk: Float32Array) => void;\n  onSmartStartStateChange?: (state: SmartStartState) => void;\n  onSmartStartComplete?: (rms: number) => void;\n  onSmartStartTimeout?: () => void;\n}\n\n/**\n * AudioWorklet Manager\n *\n * Manages AudioWorklet-based audio processing.\n */\nexport class AudioWorkletManager {\n  private audioContext: AudioContext | null = null;\n  private workletNode: AudioWorkletNode | null = null;\n  private sourceNode: MediaStreamAudioSourceNode | null = null;\n  private config: AudioWorkletConfig;\n\n  // Ring buffer for reading audio data (synced with worklet)\n  private ringBuffer: Float32Array;\n  private currentWritePos: number = 0;\n\n  constructor(config: AudioWorkletConfig) {\n    this.config = config;\n    this.ringBuffer = new Float32Array(config.bufferSize);\n  }\n\n  /**\n   * Initialize AudioWorklet\n   */\n  async init(audioContext: AudioContext, mediaStream: MediaStream): Promise<void> {\n    this.audioContext = audioContext;\n\n    try {\n      // Load AudioWorklet processor using document location for correct path resolution\n      // CRITICAL FIX: Use window.location.href as base (not origin) to handle subpath deployments correctly\n      // This ensures the worklet is loaded from the same directory as the HTML document\n      const workletUrl = new URL('audio-processor.worklet.js', window.location.href);\n\n      logger.info(`Loading AudioWorklet from: ${workletUrl.href}`);\n      await audioContext.audioWorklet.addModule(workletUrl.href);\n\n      // Create AudioWorkletNode\n      this.workletNode = new AudioWorkletNode(audioContext, 'zanobot-audio-processor');\n\n      // Setup message handler\n      this.workletNode.port.onmessage = (event) => {\n        this.handleWorkletMessage(event.data);\n      };\n\n      // CRITICAL: Do NOT use GainNode in AudioWorklet signal chain!\n      // Reason: Training (Phase 2) uses MediaRecorder which captures UNAMPLIFIED signal\n      // If we amplify here, diagnosis features (Phase 3) won't match training features\n      // Result: False positive/negative diagnoses due to incompatible feature magnitudes\n      //\n      // GainNode is ONLY used in AudioVisualizer for better visualization,\n      // NOT in the feature extraction pipeline!\n\n      // Connect audio source WITHOUT gain amplification\n      this.sourceNode = audioContext.createMediaStreamSource(mediaStream);\n      this.sourceNode.connect(this.workletNode);\n      // NOTE: Do not connect to destination by default to avoid feedback/echo loops.\n\n      // CRITICAL FIX: Send actual sample rate and warmup duration to worklet\n      // This ensures Single Source of Truth from config (no hardcoded values in worklet)\n      this.workletNode.port.postMessage({\n        type: 'init',\n        sampleRate: audioContext.sampleRate,\n        warmUpDuration: this.config.warmUpDuration || 5000, // Default to 5s if not specified\n      });\n\n      logger.info(' AudioWorklet initialized');\n    } catch (error) {\n      logger.error(' AudioWorklet initialization failed:', error);\n      throw new Error('Failed to initialize AudioWorklet. Browser may not support it.');\n    }\n  }\n\n  /**\n   * Handle messages from AudioWorklet\n   */\n  private handleWorkletMessage(message:\n    | { type: 'init-complete'; sampleRate: number; chunkSize: number; bufferSize: number }\n    | { type: 'audio-data-ready'; writePos: number }\n    | { type: 'audio-chunk'; chunk: Float32Array; chunkIndex: number; writePos: number }\n    | { type: 'smart-start-state'; state: string; phase: 'idle' | 'warmup' | 'waiting' | 'recording'; remainingWarmUp: number }\n    | { type: 'smart-start-complete'; rms: number }\n    | { type: 'smart-start-timeout' }\n    | { type: 'debug-rms'; rms: number; threshold: number }\n  ): void {\n    switch (message.type) {\n      case 'init-complete':\n        // Worklet initialization confirmed with actual sample rate, chunk size, and buffer size\n        logger.info(\n          ` Worklet initialized: sampleRate=${message.sampleRate}Hz, chunkSize=${message.chunkSize} samples, bufferSize=${message.bufferSize} samples`\n        );\n\n        // CRITICAL FIX: Resize local ring buffer if worklet reports larger buffer size\n        // This ensures consistency between worklet and manager buffers\n        if (message.bufferSize && message.bufferSize > this.ringBuffer.length) {\n          logger.info(\n            ` Resizing local ring buffer from ${this.ringBuffer.length} to ${message.bufferSize} samples`\n          );\n          this.ringBuffer = new Float32Array(message.bufferSize);\n          this.currentWritePos = 0;\n        }\n        break;\n\n      case 'audio-data-ready':\n        this.currentWritePos = message.writePos;\n        if (this.config.onAudioData) {\n          this.config.onAudioData(message.writePos);\n        }\n        break;\n\n      case 'audio-chunk':\n        // Receive audio chunk from worklet (zero-copy transfer)\n        if (message.chunk) {\n          const chunk = new Float32Array(message.chunk);\n\n          // CRITICAL FIX: Sync currentWritePos from worklet's writePos\n          // This ensures readLatestChunk() works correctly if ever used\n          if (typeof message.writePos === 'number') {\n            // Don't overwrite before fillRingBuffer - fillRingBuffer manages its own position\n            // Instead, we'll use this for validation/debugging\n            // The local ringBuffer is independent from worklet's ringBuffer\n          }\n\n          // Fill ring buffer for readLatestChunk() usage\n          this.fillRingBuffer(chunk);\n\n          // Also call callback if provided\n          if (this.config.onAudioChunk) {\n            this.config.onAudioChunk(chunk);\n          }\n        }\n        break;\n\n      case 'smart-start-state':\n        if (this.config.onSmartStartStateChange) {\n          this.config.onSmartStartStateChange({\n            phase: message.phase,\n            remainingWarmUp: message.remainingWarmUp,\n          });\n        }\n        break;\n\n      case 'smart-start-complete':\n        if (this.config.onSmartStartComplete) {\n          this.config.onSmartStartComplete(message.rms);\n        }\n        break;\n\n      case 'smart-start-timeout':\n        if (this.config.onSmartStartTimeout) {\n          this.config.onSmartStartTimeout();\n        }\n        break;\n\n      case 'debug-rms':\n        // DEBUG: Log RMS values to help diagnose signal issues\n        logger.debug(\n          ` Signal RMS: ${message.rms.toFixed(4)} (threshold: ${message.threshold.toFixed(4)})`\n        );\n        break;\n    }\n  }\n\n  /**\n   * Fill ring buffer with audio chunk\n   */\n  private fillRingBuffer(chunk: Float32Array): void {\n    for (let i = 0; i < chunk.length; i++) {\n      this.ringBuffer[this.currentWritePos] = chunk[i];\n      this.currentWritePos = (this.currentWritePos + 1) % this.ringBuffer.length;\n    }\n  }\n\n  /**\n   * Start Smart Start sequence\n   */\n  startSmartStart(): void {\n    if (!this.workletNode) {\n      logger.error('AudioWorklet not initialized');\n      return;\n    }\n\n    this.workletNode.port.postMessage({ type: 'start-smart-start' });\n  }\n\n  /**\n   * Skip Smart Start and go directly to recording\n   */\n  skipToRecording(): void {\n    if (!this.workletNode) {\n      logger.error('AudioWorklet not initialized');\n      return;\n    }\n\n    this.workletNode.port.postMessage({ type: 'skip-to-recording' });\n  }\n\n  /**\n   * Stop recording\n   */\n  stop(): void {\n    if (!this.workletNode) {\n      return;\n    }\n\n    this.workletNode.port.postMessage({ type: 'stop' });\n  }\n\n  /**\n   * Reset ring buffer\n   */\n  resetBuffer(): void {\n    if (!this.workletNode) {\n      return;\n    }\n\n    this.ringBuffer.fill(0);\n    this.currentWritePos = 0;\n    this.workletNode.port.postMessage({ type: 'reset-buffer' });\n  }\n\n  /**\n   * Read latest chunk from ring buffer\n   *\n   * Note: The ring buffer is managed by the AudioWorklet,\n   * so we need to read from a shared buffer or implement\n   * a message-based transfer.\n   *\n   * For simplicity, we'll use SharedArrayBuffer in the future.\n   * For now, we'll keep a local buffer synced via messages.\n   */\n  readLatestChunk(chunkSize: number): Float32Array {\n    // This is a simplified version.\n    // In production, you'd use SharedArrayBuffer or transfer via messages.\n\n    const chunk = new Float32Array(chunkSize);\n\n    // Read backwards from current write position\n    let readPos = this.currentWritePos - chunkSize;\n    if (readPos < 0) {\n      readPos += this.ringBuffer.length;\n    }\n\n    for (let i = 0; i < chunkSize; i++) {\n      chunk[i] = this.ringBuffer[readPos];\n      readPos = (readPos + 1) % this.ringBuffer.length;\n    }\n\n    return chunk;\n  }\n\n  /**\n   * Cleanup\n   */\n  cleanup(): void {\n    if (this.workletNode) {\n      // Clear message handler to prevent memory leaks\n      this.workletNode.port.onmessage = null;\n      this.workletNode.disconnect();\n      this.workletNode = null;\n    }\n\n    if (this.sourceNode) {\n      this.sourceNode.disconnect();\n      this.sourceNode = null;\n    }\n\n    this.audioContext = null;\n    this.ringBuffer.fill(0);\n    this.currentWritePos = 0;\n  }\n\n  /**\n   * Check if AudioWorklet is supported\n   */\n  static isSupported(): boolean {\n    // CRITICAL FIX: Use unknown cast for webkitAudioContext (legacy Safari support)\n    const AudioContextConstructor =\n      typeof AudioContext !== 'undefined'\n        ? AudioContext\n        : typeof (globalThis as unknown as { webkitAudioContext?: typeof AudioContext })\n              .webkitAudioContext !== 'undefined'\n          ? (globalThis as unknown as { webkitAudioContext: typeof AudioContext })\n              .webkitAudioContext\n          : undefined;\n\n    if (!AudioContextConstructor) {\n      return false;\n    }\n\n    return 'audioWorklet' in AudioContextConstructor.prototype;\n  }\n}\n\n/**\n * Check if browser supports AudioWorklet\n */\nexport function isAudioWorkletSupported(): boolean {\n  return AudioWorkletManager.isSupported();\n}\n","/**\n * ZANOBOT - UI CONSTANTS\n *\n * Centralized UI text constants to avoid magic strings and improve maintainability.\n */\n\n/**\n * Button text constants\n * Used across different phases to ensure consistency\n */\nexport const BUTTON_TEXT = {\n  // Recording modal buttons\n  STOP_REFERENCE: 'Stop',\n  STOP_DIAGNOSE: 'Stop & Save',\n\n  // Phase buttons\n  SCAN: 'Scannen',\n  CREATE_MACHINE: 'Erstellen',\n  RECORD: 'Aufnehmen',\n  DIAGNOSE: 'Diagnose starten',\n\n  // Modal actions\n  CLOSE: 'Schlieen',\n  CANCEL: 'Abbrechen',\n  SAVE: 'Speichern',\n  DISCARD: 'Verwerfen',\n} as const;\n\n/**\n * Status text constants\n */\nexport const STATUS_TEXT = {\n  HEALTHY: 'Unauffllig',\n  UNCERTAIN: 'Abweichung',\n  FAULTY: 'Auffllig',\n  UNKNOWN: 'UNKNOWN',\n} as const;\n\n/**\n * Modal title constants\n */\nexport const MODAL_TITLE = {\n  RECORDING_REFERENCE: 'Referenzaufnahme',\n  RECORDING_DIAGNOSE: 'Live Diagnosis - Find Sweet Spot',\n  SCANNER: 'QR/Barcode Scanner',\n} as const;\n","/**\n * ZANOBOT - PHASE 2: REFERENCE\n *\n * Training mode - Record healthy machine state.\n * Steps:\n * 1. Record audio (default 10s)\n * 2. Extract features\n * 3. Train GMIA model\n * 4. Save model to machine\n */\n\nimport { extractFeatures, DEFAULT_DSP_CONFIG } from '@core/dsp/features.js';\nimport { trainGMIA } from '@core/ml/gmia.js';\nimport { assessRecordingQuality } from '@core/ml/qualityCheck.js';\nimport { updateMachineModel } from '@data/db.js';\nimport { AudioVisualizer } from '@ui/components/AudioVisualizer.js';\nimport { getRawAudioStream, getSmartStartStatusMessage } from '@core/audio/audioHelper.js';\nimport { AudioWorkletManager, isAudioWorkletSupported } from '@core/audio/audioWorkletHelper.js';\nimport { notify } from '@utils/notifications.js';\nimport type { Machine, TrainingData, FeatureVector, QualityResult } from '@data/types.js';\nimport { logger } from '@utils/logger.js';\nimport { BUTTON_TEXT } from '@ui/constants.js';\nimport { classifyDiagnosticState } from '@core/ml/scoring.js';\n\nexport class ReferencePhase {\n  private machine: Machine;\n  private selectedDeviceId: string | undefined; // Selected microphone device ID\n  private onMachineUpdated: ((machine: Machine) => void) | null = null; // Callback when machine is updated\n  private audioContext: AudioContext | null = null;\n  private mediaStream: MediaStream | null = null;\n  private cameraStream: MediaStream | null = null; // VISUAL POSITIONING: Camera stream for reference image\n  private mediaRecorder: MediaRecorder | null = null;\n  private audioChunks: Blob[] = [];\n  private visualizer: AudioVisualizer | null = null;\n  private recordingDuration: number = 15; // seconds (5s warmup + 10s actual recording)\n  private warmUpDuration: number = 5; // seconds (settling time for OS audio filters)\n  private audioWorkletManager: AudioWorkletManager | null = null;\n  private isRecordingActive: boolean = false;\n  private recordedBlob: Blob | null = null; // For reference audio export\n  private useAudioWorklet: boolean = true;\n  private recordingStartTime: number = 0; // Track when actual recording started\n  private timerInterval: ReturnType<typeof setInterval> | null = null; // Track timer interval for cleanup\n  private isRecordingStarting: boolean = false;\n  private autoStopTimer: ReturnType<typeof setTimeout> | null = null;\n  private smartStartWasUsed: boolean = false; // Track if Smart Start completed successfully\n\n  // Phase 2: Review Modal State\n  private currentAudioBuffer: AudioBuffer | null = null;\n  private currentFeatures: FeatureVector[] = [];\n  private currentQualityResult: QualityResult | null = null;\n  private currentTrainingData: TrainingData | null = null;\n\n  // CRITICAL FIX: Store event listener reference for proper cleanup\n  private recordButtonClickHandler: (() => void) | null = null;\n\n  // VISUAL POSITIONING: Reference image captured during recording\n  private capturedReferenceImage: Blob | null = null;\n  private reviewImageUrl: string | null = null;\n\n  constructor(machine: Machine, selectedDeviceId?: string) {\n    this.machine = machine;\n    this.selectedDeviceId = selectedDeviceId;\n\n    // DEBUG LOGGING: Show which machine is being used for reference recording\n    logger.debug(' ReferencePhase Constructor:', {\n      machineId: machine.id,\n      machineName: machine.name,\n      numExistingModels: machine.referenceModels?.length || 0,\n    });\n  }\n\n  /**\n   * Set callback to be notified when machine is updated (new model saved)\n   */\n  public setOnMachineUpdated(callback: (machine: Machine) => void): void {\n    this.onMachineUpdated = callback;\n  }\n\n  /**\n   * Initialize the reference phase UI\n   */\n  public init(): void {\n    this.applyAppShellLayout();\n    const recordBtn = document.getElementById('record-btn');\n    if (recordBtn) {\n      // CRITICAL FIX: Store handler reference to enable cleanup in destroy()\n      this.recordButtonClickHandler = () => this.startRecording();\n      recordBtn.addEventListener('click', this.recordButtonClickHandler);\n    }\n  }\n\n  /**\n   * Start recording reference audio with Smart Start\n   */\n  private async startRecording(): Promise<void> {\n    if (this.isRecordingStarting || this.isRecordingActive || this.mediaStream) {\n      notify.warning('Eine Aufnahme luft bereits.');\n      return;\n    }\n\n    this.isRecordingStarting = true;\n\n    try {\n      logger.info(' Phase 2: Starting reference recording with Smart Start...');\n\n      // Check AudioWorklet support\n      this.useAudioWorklet = isAudioWorkletSupported();\n      if (!this.useAudioWorklet) {\n        logger.warn(' AudioWorklet not supported, Smart Start disabled');\n      }\n\n      // Request microphone access using central helper with selected device\n      this.mediaStream = await getRawAudioStream(this.selectedDeviceId);\n\n      // VISUAL POSITIONING: Request camera access for reference image\n      // Non-blocking: If camera access fails, continue with audio only\n      try {\n        this.cameraStream = await navigator.mediaDevices.getUserMedia({\n          video: { facingMode: 'environment' }, // Prefer back camera on mobile\n          audio: false,\n        });\n        logger.info(' Camera access granted for reference image');\n      } catch (cameraError) {\n        logger.warn(\n          ' Camera access denied or not available - continuing without reference image',\n          cameraError\n        );\n        notify.info('Kamera nicht verfgbar. Aufnahme wird ohne Positionsbild fortgesetzt.', {\n          title: 'Kamera optional',\n        });\n        this.cameraStream = null;\n      }\n\n      if (typeof MediaRecorder === 'undefined') {\n        notify.error(\n          'Ihr Browser untersttzt keine Audioaufnahme. Bitte verwenden Sie einen aktuellen Browser.',\n          new Error('MediaRecorder not supported'),\n          { title: 'Browser nicht kompatibel', duration: 0 }\n        );\n        this.cleanup();\n        return;\n      }\n\n      // Create audio context\n      // CRITICAL FIX: Use 48000 Hz to match AUDIO_CONSTRAINTS.sampleRate\n      // This prevents unnecessary browser resampling (48k hardware  44.1k context)\n      this.audioContext = new AudioContext({ sampleRate: 48000 });\n\n      // CRITICAL FIX: Validate sample rate and adapt DSP config to actual rate\n      // This ensures training and diagnosis use consistent feature extraction parameters\n      const actualSampleRate = this.audioContext.sampleRate;\n      if (actualSampleRate !== 48000) {\n        logger.warn(\n          ` AudioContext sample rate is ${actualSampleRate}Hz instead of requested 48000Hz`\n        );\n        logger.info(` Feature extraction will use actual sample rate: ${actualSampleRate}Hz`);\n      }\n\n      // Show recording modal\n      this.showRecordingModal();\n\n      // Start visualizer\n      const canvas = document.getElementById('waveform-canvas');\n      if (canvas) {\n        this.visualizer = new AudioVisualizer('waveform-canvas');\n        this.visualizer.start(this.audioContext, this.mediaStream);\n      }\n\n      if (this.useAudioWorklet) {\n        // CRITICAL FIX: Calculate proper buffer size based on actual sample rate\n        // At 96kHz: chunkSize = 31680, so we need bufferSize >= 63360\n        const chunkSize = Math.floor(0.33 * actualSampleRate);\n        const bufferSize = Math.max(32768, chunkSize * 2);\n\n        // Initialize AudioWorklet Manager\n        this.audioWorkletManager = new AudioWorkletManager({\n          bufferSize: bufferSize,\n          warmUpDuration: this.warmUpDuration * 1000, // Convert seconds to milliseconds\n          onSmartStartStateChange: (state) => {\n            const statusMsg = getSmartStartStatusMessage(state);\n            this.updateStatusMessage(statusMsg);\n          },\n          onSmartStartComplete: (rms) => {\n            logger.info(` Smart Start: Signal detected! RMS: ${rms.toFixed(4)}`);\n            this.smartStartWasUsed = true; // Mark that Smart Start completed successfully\n            this.updateStatusMessage('Aufnahme luft');\n            this.actuallyStartRecording();\n          },\n          onSmartStartTimeout: () => {\n            logger.warn(' Smart Start timeout - cleaning up resources');\n            this.smartStartWasUsed = false; // Ensure flag is false since Smart Start failed\n            notify.warning('Bitte nher an die Maschine gehen und erneut versuchen.', {\n              title: 'Kein Signal erkannt',\n            });\n            // CRITICAL FIX: Call cleanup() to properly release all resources\n            // (AudioWorklet, MediaStream, Modal, Timer, etc.)\n            this.cleanup();\n            this.hideRecordingModal();\n          },\n        });\n\n        // Initialize AudioWorklet\n        await this.audioWorkletManager.init(this.audioContext, this.mediaStream);\n\n        // Start Smart Start sequence\n        this.audioWorkletManager.startSmartStart();\n      } else {\n        // Fallback: Start recording immediately without Smart Start\n        logger.info(' Skipping Smart Start (AudioWorklet not supported)');\n        this.updateStatusMessage('Aufnahme luft');\n        setTimeout(() => this.actuallyStartRecording(), 500);\n      }\n    } catch (error) {\n      logger.error('Recording error:', error);\n      notify.error('Mikrofonzugriff fehlgeschlagen', error as Error, {\n        title: 'Zugriff verweigert',\n        duration: 0,\n      });\n\n      // Cleanup on error\n      this.cleanup();\n      this.hideRecordingModal();\n    }\n  }\n\n  /**\n   * Cleanup resources (AudioContext, MediaStream, etc.)\n   */\n  private cleanup(): void {\n    // Reset state flags to prevent memory leaks\n    this.isRecordingActive = false;\n    this.isRecordingStarting = false;\n    this.smartStartWasUsed = false; // Reset Smart Start flag for next recording\n\n    // Clear timer interval to prevent memory leaks\n    if (this.timerInterval !== null) {\n      clearInterval(this.timerInterval);\n      this.timerInterval = null;\n    }\n    if (this.autoStopTimer !== null) {\n      clearTimeout(this.autoStopTimer);\n      this.autoStopTimer = null;\n    }\n\n    // Stop media recorder if active\n    if (this.mediaRecorder && this.mediaRecorder.state !== 'inactive') {\n      this.mediaRecorder.ondataavailable = null;\n      this.mediaRecorder.onstop = null;\n      this.mediaRecorder.stop();\n      this.mediaRecorder = null;\n    }\n\n    // Stop visualizer\n    if (this.visualizer) {\n      this.visualizer.stop();\n    }\n\n    // Cleanup AudioWorklet\n    if (this.audioWorkletManager) {\n      this.audioWorkletManager.cleanup();\n      this.audioWorkletManager = null;\n    }\n\n    // Stop media stream tracks\n    if (this.mediaStream) {\n      this.mediaStream.getTracks().forEach((track) => track.stop());\n      this.mediaStream = null;\n    }\n\n    // VISUAL POSITIONING: Stop camera stream\n    if (this.cameraStream) {\n      this.cameraStream.getTracks().forEach((track) => track.stop());\n      this.cameraStream = null;\n    }\n\n    // Close audio context with error handling to prevent leaks\n    if (this.audioContext && this.audioContext.state !== 'closed') {\n      try {\n        this.audioContext.close();\n      } catch (error) {\n        logger.warn(' Error closing AudioContext:', error);\n      } finally {\n        // Always null the reference to prevent leaks\n        this.audioContext = null;\n      }\n    }\n\n    logger.debug(' Reference phase cleanup complete');\n  }\n\n  /**\n   * Actually start recording after Smart Start completes\n   *\n   * Important: We record the FULL 15 seconds (including warmup) for debugging,\n   * but only use the last 10 seconds (after warmup) for training.\n   */\n  private actuallyStartRecording(): void {\n    if (!this.mediaStream) {\n      return;\n    }\n\n    // Stop AudioWorklet Smart Start\n    if (this.audioWorkletManager) {\n      this.audioWorkletManager.stop();\n    }\n\n    // Setup media recorder with explicit mimeType\n    // CRITICAL FIX: Detect supported MIME type to ensure Blob matches actual format\n    let mimeType: string | undefined;\n    if (MediaRecorder.isTypeSupported('audio/webm;codecs=opus')) {\n      mimeType = 'audio/webm;codecs=opus';\n    } else if (MediaRecorder.isTypeSupported('audio/ogg;codecs=opus')) {\n      mimeType = 'audio/ogg;codecs=opus';\n    } else if (MediaRecorder.isTypeSupported('audio/mp4')) {\n      mimeType = 'audio/mp4';\n    }\n    logger.info(` Using MediaRecorder MIME type: ${mimeType ?? 'browser default'}`);\n\n    this.audioChunks = [];\n    const mediaRecorderOptions = mimeType ? { mimeType } : undefined;\n    this.mediaRecorder = mediaRecorderOptions\n      ? new MediaRecorder(this.mediaStream, mediaRecorderOptions)\n      : new MediaRecorder(this.mediaStream);\n    this.isRecordingActive = true;\n    this.isRecordingStarting = false;\n\n    this.mediaRecorder.ondataavailable = (event) => {\n      if (event.data.size > 0) {\n        this.audioChunks.push(event.data);\n      }\n    };\n\n    this.mediaRecorder.onstop = () => this.processRecording();\n\n    // Set up onstart handler to ensure precise timing\n    this.mediaRecorder.onstart = () => {\n      // Record actual start time when recording actually begins\n      this.recordingStartTime = Date.now();\n\n      // Update timer (shows dual-phase UI)\n      this.startTimer();\n\n      // Auto-stop after full duration\n      // CRITICAL FIX: If Smart Start was used, we only need 10s of recording (no warmup needed)\n      // If Smart Start was NOT used, record 15s (first 5s = warmup, last 10s = training)\n      const recordingDuration = this.smartStartWasUsed ? 10 : this.recordingDuration;\n      this.autoStopTimer = setTimeout(() => {\n        this.stopRecording();\n      }, recordingDuration * 1000);\n\n      // VISUAL POSITIONING: Capture reference image at midpoint of recording\n      // Calculate snapshot time: halfway through the actual recording (after warmup)\n      const snapshotDelay = this.smartStartWasUsed\n        ? 5000 // 5 seconds into 10-second recording (Smart Start)\n        : 10000; // 10 seconds into 15-second recording (5s warmup + 5s into training)\n\n      setTimeout(() => {\n        this.captureReferenceSnapshot();\n      }, snapshotDelay);\n    };\n\n    // Start recording (will trigger onstart event)\n    this.mediaRecorder.start();\n  }\n\n  /**\n   * VISUAL POSITIONING: Capture reference snapshot from camera stream\n   *\n   * Creates a snapshot of the current video frame and stores it as Blob.\n   * This image will be saved to the machine for later use in diagnosis.\n   */\n  private captureReferenceSnapshot(): void {\n    // Check if camera stream is available\n    if (!this.cameraStream) {\n      logger.info(' No camera stream available - skipping reference snapshot');\n      return;\n    }\n\n    try {\n      // Get video element\n      const video = document.getElementById('reference-video') as HTMLVideoElement | null;\n      if (!video || video.videoWidth === 0) {\n        logger.warn(' Video element not ready - skipping snapshot');\n        return;\n      }\n\n      // Create canvas for snapshot\n      const canvas = document.createElement('canvas');\n      canvas.width = video.videoWidth;\n      canvas.height = video.videoHeight;\n\n      // Draw current video frame to canvas\n      const ctx = canvas.getContext('2d');\n      if (!ctx) {\n        logger.error(' Failed to get canvas context');\n        return;\n      }\n      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);\n\n      // Convert canvas to Blob\n      canvas.toBlob(\n        (blob) => {\n          if (blob) {\n            this.capturedReferenceImage = blob;\n            logger.info(\n              ` Reference snapshot captured: ${blob.size} bytes (${canvas.width}x${canvas.height})`\n            );\n\n            // Visual feedback: Flash border on video\n            const videoContainer = document.getElementById('reference-video-container');\n            if (videoContainer) {\n              videoContainer.style.borderColor = 'var(--status-healthy)';\n              setTimeout(() => {\n                videoContainer.style.borderColor = 'var(--primary-color)';\n              }, 300);\n            }\n          } else {\n            logger.error(' Failed to create blob from canvas');\n          }\n        },\n        'image/jpeg',\n        0.8 // 80% quality for reasonable file size\n      );\n    } catch (error) {\n      logger.error('Snapshot capture error:', error);\n    }\n  }\n\n  /**\n   * Stop recording\n   *\n   * IMPORTANT: Only stops the MediaRecorder here. Cleanup is called later\n   * in processRecording() after the audio has been decoded and processed.\n   * This prevents closing the AudioContext before processRecording() needs it.\n   */\n  private stopRecording(): void {\n    // Stop media recorder if active\n    if (this.mediaRecorder && this.mediaRecorder.state !== 'inactive') {\n      this.mediaRecorder.stop(); // This triggers onstop -> processRecording()\n      return;\n    }\n\n    // Handle Smart Start / waiting phase where MediaRecorder is inactive\n    if (this.audioWorkletManager || this.isRecordingActive || this.isRecordingStarting) {\n      if (this.audioWorkletManager) {\n        this.audioWorkletManager.cleanup();\n      }\n      this.cleanup();\n      this.hideRecordingModal();\n    }\n  }\n\n  /**\n   * Process recorded audio and show review modal\n   *\n   * PHASE 2 WORKFLOW:\n   * 1. Extract features from post-warmup audio (seconds 5-15)\n   * 2. Assess recording quality\n   * 3. Show review modal with audio player and quality assessment\n   * 4. Wait for user decision (Save or Discard)\n   *\n   * CRITICAL IMPLEMENTATION:\n   * - File blob: Full 15 seconds (for playback and debugging)\n   * - Feature extraction: Only seconds 5-15 (after OS audio filters have settled)\n   * - Cleanup is called at the end to release AudioContext after processing\n   */\n  private async processRecording(): Promise<void> {\n    try {\n      if (!this.audioContext) {\n        throw new Error('Audio context not initialized');\n      }\n\n      // Create blob from chunks (FULL 15 seconds for download)\n      // CRITICAL FIX: Use actual MIME type from MediaRecorder to ensure correct format\n      const mimeType = this.mediaRecorder?.mimeType || '';\n      const blobOptions = mimeType ? { type: mimeType } : undefined;\n      const blob = blobOptions\n        ? new Blob(this.audioChunks, blobOptions)\n        : new Blob(this.audioChunks);\n      this.recordedBlob = blob; // Save for export\n      logger.info(` Created audio blob with MIME type: ${mimeType}`);\n\n      // Convert to AudioBuffer\n      const arrayBuffer = await blob.arrayBuffer();\n      const audioBuffer = await this.audioContext.decodeAudioData(arrayBuffer);\n\n      logger.info(` Recording complete: ${audioBuffer.duration.toFixed(2)}s`);\n\n      // CRITICAL FIX: Only slice audio buffer if Smart Start was NOT used\n      // Smart Start already handled the 5-second warmup period, so we don't need to slice again\n      const sampleRate = audioBuffer.sampleRate;\n      const warmupSamples = this.smartStartWasUsed\n        ? 0\n        : Math.floor(this.warmUpDuration * sampleRate);\n      const totalSamples = audioBuffer.length;\n      const trainingSamples = totalSamples - warmupSamples;\n\n      if (this.smartStartWasUsed) {\n        logger.info(` Using full recording (Smart Start handled warmup):`);\n        logger.info(\n          `   Total duration: ${audioBuffer.duration.toFixed(2)}s - ALL USED FOR TRAINING`\n        );\n      } else {\n        logger.info(` Slicing audio buffer (fallback mode without Smart Start):`);\n        logger.info(`   Total duration: ${audioBuffer.duration.toFixed(2)}s`);\n        logger.info(\n          `   Warmup period: ${this.warmUpDuration}s (${warmupSamples} samples) - DISCARDED`\n        );\n        logger.info(\n          `   Training period: ${(trainingSamples / sampleRate).toFixed(2)}s (${trainingSamples} samples) - USED`\n        );\n      }\n\n      // CRITICAL FIX: Validate that we have enough samples for training\n      // UPDATED: Increased from 2.0s to 5.0s for stable GMIA models\n      // With 330ms windows + 66ms hop: 5s = ~70-80 chunks (sufficient for statistical stability)\n      // 2s was too short (~26 chunks), leading to high variance and unreliable models\n      const MIN_TRAINING_DURATION = 5.0; // Minimum 5 seconds of training data\n      const minTrainingSamples = Math.floor(MIN_TRAINING_DURATION * sampleRate);\n\n      if (trainingSamples <= 0) {\n        throw new Error(\n          `Aufnahme zu kurz: ${audioBuffer.duration.toFixed(2)}s Gesamtdauer ist krzer als die ${this.warmUpDuration}s Warmup-Phase. ` +\n            `Mindestdauer: ${(this.warmUpDuration + MIN_TRAINING_DURATION).toFixed(1)}s`\n        );\n      }\n\n      if (trainingSamples < minTrainingSamples) {\n        throw new Error(\n          `Trainings-Daten zu kurz: ${(trainingSamples / sampleRate).toFixed(2)}s (nach Warmup-Phase). ` +\n            `Minimum erforderlich: ${MIN_TRAINING_DURATION}s. ` +\n            `Bitte mindestens ${(this.warmUpDuration + MIN_TRAINING_DURATION).toFixed(1)}s aufnehmen.`\n        );\n      }\n\n      // Create new AudioBuffer with only the training portion\n      const trainingBuffer = this.audioContext.createBuffer(\n        audioBuffer.numberOfChannels,\n        trainingSamples,\n        sampleRate\n      );\n\n      // Copy data from original buffer (starting at warmupSamples offset)\n      for (let channel = 0; channel < audioBuffer.numberOfChannels; channel++) {\n        const originalData = audioBuffer.getChannelData(channel);\n        const trainingData = trainingBuffer.getChannelData(channel);\n\n        // Copy samples from offset to end\n        for (let i = 0; i < trainingSamples; i++) {\n          trainingData[i] = originalData[warmupSamples + i];\n        }\n      }\n\n      // CRITICAL FIX: Create DSP config with actual sample rate from AudioContext\n      // This ensures training features match diagnosis features even if browser uses different sample rate\n      const actualSampleRate = this.audioContext.sampleRate;\n      const dspConfig = {\n        ...DEFAULT_DSP_CONFIG,\n        sampleRate: actualSampleRate,\n        frequencyRange: [0, actualSampleRate / 2] as [number, number], // Update Nyquist frequency\n      };\n\n      logger.debug(\n        ` DSP Config: sampleRate=${dspConfig.sampleRate}Hz, frequencyRange=[${dspConfig.frequencyRange[0]}, ${dspConfig.frequencyRange[1]}]Hz`\n      );\n\n      // Extract features from the SLICED buffer (only stable signal)\n      logger.info(' Extracting features from stable signal...');\n      const features = extractFeatures(trainingBuffer, dspConfig);\n      logger.info(`   Extracted ${features.length} feature vectors`);\n\n      // PHASE 2: Assess recording quality\n      const qualityResult = assessRecordingQuality(features);\n\n      // Prepare training data (but don't train yet - wait for user approval)\n      // CRITICAL FIX: Store actual DSP config used for feature extraction\n      const trainingData: TrainingData = {\n        featureVectors: features.map((f) => f.features),\n        machineId: this.machine.id,\n        recordingId: `ref-${Date.now()}`,\n        numSamples: features.length,\n        config: dspConfig, // Use actual config with correct sample rate\n      };\n\n      // Store for later use\n      this.currentAudioBuffer = audioBuffer;\n      this.currentFeatures = features;\n      this.currentQualityResult = qualityResult;\n      this.currentTrainingData = trainingData;\n\n      // Cleanup resources now that processing is complete\n      // This releases AudioContext, MediaStream, timer, etc.\n      this.cleanup();\n\n      // Hide recording modal\n      this.hideRecordingModal();\n\n      // PHASE 2: Show review modal instead of saving directly\n      this.showReviewModal();\n    } catch (error) {\n      logger.error('Processing error:', error);\n      notify.error('Aufnahme konnte nicht verarbeitet werden', error as Error, {\n        title: 'Verarbeitungsfehler',\n        duration: 0,\n      });\n\n      // Cleanup on error\n      this.cleanup();\n\n      this.hideRecordingModal();\n    }\n  }\n\n  /**\n   * Show success message with reference audio export option\n   */\n  private showSuccessWithExport(): void {\n    const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, -5);\n\n    // CRITICAL FIX: Determine file extension based on actual MIME type\n    let extension = 'webm';\n    if (this.recordedBlob) {\n      if (this.recordedBlob.type.includes('ogg')) {\n        extension = 'ogg';\n      } else if (this.recordedBlob.type.includes('mp4')) {\n        extension = 'm4a';\n      }\n    }\n    const filename = `${this.machine.id}_REF_${timestamp}.${extension}`;\n\n    const shouldDownload = confirm(\n      ` Referenzmodell erfolgreich trainiert!\\n\\n` +\n        `Maschine: ${this.machine.name}\\n\\n` +\n        `Mchten Sie die Referenz-Audiodatei herunterladen?\\n` +\n        `(Empfohlen fr Backup)`\n    );\n\n    if (shouldDownload && this.recordedBlob) {\n      this.exportReferenceAudio(filename);\n    }\n  }\n\n  /**\n   * Export reference audio as downloadable file\n   */\n  private exportReferenceAudio(filename: string): void {\n    if (!this.recordedBlob) {\n      notify.warning('Bitte zuerst eine Referenzaufnahme erstellen.', {\n        title: 'Keine Audiodatei verfgbar',\n      });\n      return;\n    }\n\n    try {\n      const url = URL.createObjectURL(this.recordedBlob);\n      const a = document.createElement('a');\n      a.href = url;\n      a.download = filename;\n      document.body.appendChild(a);\n      a.click();\n      document.body.removeChild(a);\n      URL.revokeObjectURL(url);\n\n      logger.info(` Reference audio exported: ${filename}`);\n    } catch (error) {\n      logger.error('Export error:', error);\n      notify.error('Export fehlgeschlagen', error as Error, {\n        title: 'Exportfehler',\n      });\n    }\n  }\n\n  /**\n   * Update status message in UI\n   */\n  private updateStatusMessage(message: string): void {\n    const statusElement = document.getElementById('recording-status');\n    if (statusElement) {\n      statusElement.textContent = message;\n    }\n\n    // Also update modal title if needed\n    const modalTitle = document.querySelector('#recording-modal .modal-header h3');\n    if (modalTitle && message.includes('Kalibrierung')) {\n      modalTitle.textContent = 'Referenzaufnahme - Kalibrierung';\n    } else if (modalTitle && message.includes('Warte')) {\n      modalTitle.textContent = 'Referenzaufnahme - Warte auf Signal';\n    } else if (modalTitle && message.includes('Aufnahme')) {\n      modalTitle.textContent = 'Referenzaufnahme - Luft';\n    }\n  }\n\n  /**\n   * Show recording modal\n   */\n  private showRecordingModal(): void {\n    const modal = document.getElementById('recording-modal');\n    if (modal) {\n      modal.style.display = 'flex';\n    }\n\n    // CRITICAL FIX: Update machine name in modal subtitle\n    // This was showing hardcoded \"MACHINE 002\" from index.html instead of selected machine\n    const machineIdElement = document.getElementById('machine-id');\n    if (machineIdElement) {\n      machineIdElement.textContent = `${this.machine.name} (${this.machine.id})`;\n      logger.debug(' Modal machine name updated:', this.machine.name);\n    }\n\n    // Add existing models info and status message\n    const modalBody = document.querySelector('#recording-modal .modal-body');\n    if (modalBody && !document.getElementById('recording-status')) {\n      // Show existing models info\n      const existingModels = this.machine.referenceModels || [];\n      const existingModelsInfo =\n        existingModels.length > 0\n          ? existingModels\n              .map((m) => {\n                const trainingDate = new Date(m.trainingDate).toLocaleString('de-DE', {\n                  day: '2-digit',\n                  month: '2-digit',\n                  year: 'numeric',\n                  hour: '2-digit',\n                  minute: '2-digit',\n                });\n                return `${m.label} (${trainingDate})`;\n              })\n              .join(', ')\n          : 'Noch keine Referenzmodelle vorhanden';\n\n      const infoDiv = document.createElement('div');\n      infoDiv.className = 'existing-models-info';\n      infoDiv.style.cssText =\n        'background: rgba(0, 212, 255, 0.1); border-left: 3px solid var(--primary-color); padding: 8px 12px; margin-bottom: 12px; border-radius: 4px;';\n      infoDiv.innerHTML = `\n        <div style=\"font-size: 0.75rem; color: var(--text-muted); margin-bottom: 4px;\">VORHANDENE MODELLE:</div>\n        <div style=\"font-size: 0.85rem; color: var(--text-primary); font-weight: 500;\">${existingModelsInfo}</div>\n        <div style=\"font-size: 0.7rem; color: var(--text-muted); margin-top: 4px;\">${existingModels.length} Zustand(e) bereits trainiert</div>\n      `;\n      const visualizerContainer = modalBody.querySelector('#visualizer-container');\n      if (visualizerContainer) {\n        visualizerContainer.insertAdjacentElement('afterend', infoDiv);\n      } else {\n        modalBody.insertBefore(infoDiv, modalBody.firstChild);\n      }\n\n      const statusDiv = document.createElement('div');\n      statusDiv.id = 'recording-status';\n      statusDiv.className = 'recording-status';\n      statusDiv.textContent = 'Initialisierung...';\n      infoDiv.insertAdjacentElement('afterend', statusDiv);\n    }\n\n    // Setup stop button\n    const stopBtn = document.getElementById('stop-recording-btn');\n    if (stopBtn) {\n      // CRITICAL FIX: Reset button text using constant (Diagnose phase sets it to 'Stop & Save')\n      // This prevents UI confusion when switching between phases\n      stopBtn.textContent = BUTTON_TEXT.STOP_REFERENCE;\n      stopBtn.onclick = () => this.stopRecording();\n    }\n\n    // VISUAL POSITIONING: Add video preview if camera is available\n    if (this.cameraStream && modalBody) {\n      // Create video container\n      const videoContainer = document.createElement('div');\n      videoContainer.id = 'reference-video-container';\n      videoContainer.className = 'reference-video-container';\n      videoContainer.style.cssText = `\n        position: relative;\n        width: 100%;\n        max-width: 300px;\n        margin: 12px auto;\n        border-radius: 8px;\n        overflow: hidden;\n        border: 2px solid var(--primary-color);\n      `;\n\n      // Create video element\n      const video = document.createElement('video');\n      video.id = 'reference-video';\n      video.autoplay = true;\n      video.playsInline = true;\n      video.muted = true;\n      video.style.cssText = `\n        width: 100%;\n        height: auto;\n        display: block;\n      `;\n\n      // Attach camera stream to video\n      video.srcObject = this.cameraStream;\n\n      // Add hint text\n      const hint = document.createElement('p');\n      hint.className = 'video-hint';\n      hint.style.cssText = `\n        font-size: 0.75rem;\n        color: var(--text-muted);\n        text-align: center;\n        margin-top: 8px;\n      `;\n      hint.textContent = ' Positionsbild wird automatisch aufgenommen';\n\n      videoContainer.appendChild(video);\n      modalBody.insertBefore(videoContainer, modalBody.firstChild);\n      modalBody.insertBefore(hint, videoContainer.nextSibling);\n\n      logger.info(' Reference video preview added to modal');\n    }\n  }\n\n  /**\n   * Hide recording modal\n   */\n  private hideRecordingModal(): void {\n    const modal = document.getElementById('recording-modal');\n    if (modal) {\n      modal.style.display = 'none';\n    }\n\n    const statusElement = document.getElementById('recording-status');\n    if (statusElement) {\n      statusElement.remove();\n    }\n\n    // Clean up existing models info\n    const existingModelsInfo = modal?.querySelector('.existing-models-info');\n    if (existingModelsInfo) {\n      existingModelsInfo.remove();\n    }\n\n    // VISUAL POSITIONING: Clean up video elements\n    const videoContainer = document.getElementById('reference-video-container');\n    if (videoContainer) {\n      videoContainer.remove();\n    }\n    const videoHint = modal?.querySelector('.video-hint');\n    if (videoHint) {\n      videoHint.remove();\n    }\n  }\n\n  /**\n   * Start recording timer with dual-phase UI\n   *\n   * CRITICAL FIX: Timer behavior depends on whether Smart Start was used:\n   * - Smart Start used: Show only recording phase (10s total)\n   * - Smart Start NOT used: Show warmup + recording phases (5s + 10s = 15s total)\n   *\n   * Phase 1 (0-5s): \"Stabilisierung...\" (only if Smart Start NOT used)\n   * Phase 2 (0-10s or 5-15s): \"Aufnahme...\" (actual recording used for training)\n   */\n  private startTimer(): void {\n    // CRITICAL FIX: Clear any existing timer first to prevent memory leaks\n    // This handles the case where startTimer() is called multiple times\n    if (this.timerInterval !== null) {\n      clearInterval(this.timerInterval);\n      this.timerInterval = null;\n    }\n\n    let elapsed = 0;\n    const timerElement = document.getElementById('recording-timer');\n    const statusElement = document.getElementById('recording-status');\n\n    // CRITICAL FIX: Determine total duration and warmup phase based on Smart Start usage\n    const totalDuration = this.smartStartWasUsed ? 10 : this.recordingDuration;\n    const warmupPhase = this.smartStartWasUsed ? 0 : this.warmUpDuration;\n\n    // Store interval reference for cleanup\n    this.timerInterval = setInterval(() => {\n      // CRITICAL FIX: Check if recording is still active (defensive programming)\n      // If recording was stopped prematurely, clear the timer\n      if (!this.isRecordingActive) {\n        if (this.timerInterval !== null) {\n          clearInterval(this.timerInterval);\n          this.timerInterval = null;\n        }\n        return;\n      }\n\n      elapsed++;\n\n      // Update phase-specific UI\n      if (!this.smartStartWasUsed && elapsed <= warmupPhase) {\n        // Phase 1: Stabilisierung (0-5s) - only shown when Smart Start was NOT used\n        if (statusElement) {\n          const remaining = warmupPhase - elapsed + 1;\n          statusElement.textContent = `Stabilisierung... ${remaining}s`;\n        }\n        if (timerElement) {\n          timerElement.textContent = '--:--';\n        }\n      } else {\n        // Phase 2: Aufnahme (0-10s if Smart Start, 5-15s if not)\n        const recordingElapsed = this.smartStartWasUsed ? elapsed : elapsed - warmupPhase;\n        const recordingTotal = this.smartStartWasUsed ? 10 : this.recordingDuration - warmupPhase;\n\n        if (statusElement) {\n          statusElement.textContent = `Aufnahme luft...`;\n        }\n        if (timerElement) {\n          const minutes = Math.floor(recordingElapsed / 60);\n          const seconds = recordingElapsed % 60;\n          timerElement.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')} / ${Math.floor(\n            recordingTotal / 60\n          )\n            .toString()\n            .padStart(2, '0')}:${(recordingTotal % 60).toString().padStart(2, '0')}`;\n        }\n      }\n\n      if (elapsed >= totalDuration) {\n        if (this.timerInterval !== null) {\n          clearInterval(this.timerInterval);\n          this.timerInterval = null;\n        }\n      }\n    }, 1000);\n  }\n\n  /**\n   * PHASE 2: Show review modal with audio player and quality assessment\n   */\n  private showReviewModal(): void {\n    if (!this.recordedBlob || !this.currentQualityResult) {\n      logger.error('Cannot show review modal: missing data');\n      return;\n    }\n\n    const modal = document.getElementById('review-modal');\n    if (!modal) {\n      logger.error('Review modal element not found');\n      return;\n    }\n\n    // Setup audio player with proper null checks\n    const audioElement = document.getElementById('review-audio') as HTMLAudioElement | null;\n    const audioSource = document.getElementById('review-audio-source') as HTMLSourceElement | null;\n\n    if (!audioElement || !audioSource) {\n      logger.error('Audio player elements not found');\n      return;\n    }\n\n    const audioUrl = URL.createObjectURL(this.recordedBlob);\n    audioSource.src = audioUrl;\n    audioSource.type = this.recordedBlob.type || 'audio/webm';\n    audioElement.load();\n\n    const imageContainer = document.getElementById('review-reference-image-container');\n    const imageElement = document.getElementById('review-reference-image') as HTMLImageElement | null;\n\n    if (imageContainer && imageElement) {\n      if (this.capturedReferenceImage) {\n        if (this.reviewImageUrl) {\n          URL.revokeObjectURL(this.reviewImageUrl);\n        }\n        this.reviewImageUrl = URL.createObjectURL(this.capturedReferenceImage);\n        imageElement.src = this.reviewImageUrl;\n        imageContainer.style.display = 'block';\n      } else {\n        imageElement.removeAttribute('src');\n        imageContainer.style.display = 'none';\n      }\n    }\n\n    // Update quality indicator\n    this.updateQualityIndicator(this.currentQualityResult);\n\n    // Setup event listeners for buttons\n    const discardBtn = document.getElementById('review-discard-btn');\n    const saveBtn = document.getElementById('review-save-btn');\n\n    if (discardBtn) {\n      discardBtn.onclick = () => this.handleReviewDiscard();\n    }\n\n    if (saveBtn) {\n      saveBtn.onclick = () => this.handleReviewSave();\n    }\n\n    // Show modal\n    modal.style.display = 'flex';\n\n    logger.info(' Review modal displayed');\n  }\n\n  /**\n   * Hide review modal\n   */\n  private hideReviewModal(): void {\n    const modal = document.getElementById('review-modal');\n    if (modal) {\n      modal.style.display = 'none';\n    }\n\n    // Clean up audio URL\n    const audioElement = document.getElementById('review-audio') as HTMLAudioElement;\n    if (audioElement) {\n      audioElement.pause();\n      const audioSource = document.getElementById('review-audio-source') as HTMLSourceElement;\n      if (audioSource && audioSource.src) {\n        URL.revokeObjectURL(audioSource.src);\n        audioSource.src = '';\n      }\n    }\n\n    if (this.reviewImageUrl) {\n      URL.revokeObjectURL(this.reviewImageUrl);\n      this.reviewImageUrl = null;\n    }\n    const imageContainer = document.getElementById('review-reference-image-container');\n    const imageElement = document.getElementById('review-reference-image') as HTMLImageElement | null;\n    if (imageContainer && imageElement) {\n      imageElement.removeAttribute('src');\n      imageContainer.style.display = 'none';\n    }\n  }\n\n  /**\n   * Update quality indicator UI based on assessment result\n   */\n  private updateQualityIndicator(qualityResult: QualityResult): void {\n    // Update score\n    const scoreElement = document.getElementById('quality-score');\n    if (scoreElement) {\n      scoreElement.textContent = qualityResult.score.toString();\n    }\n\n    // Update rating text and icon\n    const ratingElement = document.getElementById('quality-rating-text');\n    const iconElement = document.getElementById('quality-icon');\n\n    if (ratingElement && iconElement) {\n      // Clear existing classes and content\n      ratingElement.className = 'quality-rating';\n      iconElement.className = 'quality-icon';\n      iconElement.innerHTML = '';\n\n      switch (qualityResult.rating) {\n        case 'GOOD':\n          ratingElement.classList.add('good');\n          ratingElement.textContent = ' Signal stabil';\n          iconElement.classList.add('good');\n          iconElement.innerHTML = '';\n          break;\n\n        case 'OK':\n          ratingElement.classList.add('ok');\n          ratingElement.textContent = ' Leichte Unruhe';\n          iconElement.classList.add('ok');\n          iconElement.innerHTML = '';\n          break;\n\n        case 'BAD':\n          ratingElement.classList.add('bad');\n          ratingElement.textContent = ' Warnung: Signal instabil!';\n          iconElement.classList.add('bad');\n          iconElement.innerHTML = '';\n          break;\n      }\n    }\n\n    // Show/hide issues\n    const issuesContainer = document.getElementById('quality-issues');\n    const issuesList = document.getElementById('quality-issues-list');\n\n    if (issuesContainer && issuesList) {\n      if (qualityResult.issues.length > 0) {\n        // Clear existing issues\n        issuesList.innerHTML = '';\n\n        // Add each issue\n        qualityResult.issues.forEach((issue) => {\n          const li = document.createElement('li');\n          li.textContent = issue;\n          issuesList.appendChild(li);\n        });\n\n        issuesContainer.style.display = 'block';\n      } else {\n        issuesContainer.style.display = 'none';\n      }\n    }\n  }\n\n  /**\n   * Handle \"Discard\" button click - discard recording and start over\n   */\n  private handleReviewDiscard(): void {\n    logger.info(' User discarded recording');\n\n    // Hide review modal\n    this.hideReviewModal();\n\n    // Clear stored data\n    this.currentAudioBuffer = null;\n    this.currentFeatures = [];\n    this.currentQualityResult = null;\n    this.currentTrainingData = null;\n    this.recordedBlob = null;\n    this.capturedReferenceImage = null; // VISUAL POSITIONING: Clear reference image\n\n    // Show info message\n    notify.info('Sie knnen eine neue Referenzaufnahme starten.', { title: 'Aufnahme verworfen' });\n  }\n\n  /**\n   * Handle \"Save\" button click - train model and save to database\n   *\n   * MULTICLASS WORKFLOW:\n   * 1. First recording: Always labeled \"Baseline\" (healthy state)\n   * 2. Additional recordings: User provides custom label (e.g., \"Unwucht\", \"Lagerschaden\")\n   * 3. After save: Show list of trained states + \"Train Another State\" button\n   *\n   * IMPORTANT: If quality is BAD, show additional confirmation warning\n   */\n  private async handleReviewSave(): Promise<void> {\n    // Validate machine data\n    if (!this.machine || !this.machine.id) {\n      logger.error('Cannot save: machine data is invalid or missing');\n      notify.error('Maschinendaten fehlen', new Error('Machine ID missing'), {\n        title: 'Fehler',\n        duration: 0,\n      });\n      return;\n    }\n\n    if (!this.currentTrainingData || !this.currentQualityResult) {\n      logger.error('Cannot save: missing training data or quality result');\n      return;\n    }\n\n    // PHASE 2 REQUIREMENT: Block BAD quality recordings with very low scores\n    if (this.currentQualityResult.rating === 'BAD' && this.currentQualityResult.score < 30) {\n      logger.error('Recording quality too low for training - blocking save');\n      notify.error(\n        'Aufnahme zu schlecht fr Training. Bitte in ruhiger Umgebung mit ' +\n          'deutlichem Maschinensignal erneut aufnehmen.\\n\\n' +\n          'Probleme:\\n' +\n          this.currentQualityResult.issues.map((issue) => ` ${issue}`).join('\\n'),\n        new Error('Quality too low'),\n        { duration: 0 }\n      );\n      return;\n    }\n\n    // INTELLIGENT MAGNITUDE + QUALITY CHECK: Brown Noise Protection\n    // Block if BOTH quality AND signal magnitude are insufficient\n    // UPDATED: Magnitude now uses RMS amplitude (pre-standardization), typical: 0.01-0.5\n    const magnitude = this.currentQualityResult.metadata?.signalMagnitude ?? 0.5; // Default to OK if not available\n    const isNoiseDetected =\n      (magnitude < 0.01 && this.currentQualityResult.score < 60) || // Very low magnitude + poor quality = pure noise\n      (magnitude < 0.03 && this.currentQualityResult.score < 50); // Low magnitude + bad quality = too risky\n\n    if (isNoiseDetected) {\n      logger.error('Brown noise or weak signal detected - blocking save');\n      notify.error(\n        'Signal zu schwach oder diffus (mglicherweise nur Rauschen).\\n\\n' +\n          `Signal-Strke (RMS): ${magnitude.toFixed(4)} (Minimum: 0.03)\\n` +\n          `Qualitt: ${this.currentQualityResult.score}%\\n\\n` +\n          'Bitte sicherstellen:\\n' +\n          ' Mikrofon ist nah genug an der Maschine (10-30cm)\\n' +\n          ' Maschine luft mit ausreichend Lautstrke\\n' +\n          ' Kein reines Hintergrundrauschen wird aufgenommen\\n\\n' +\n          'Probleme:\\n' +\n          this.currentQualityResult.issues.map((issue) => ` ${issue}`).join('\\n'),\n        new Error('Signal too weak or noisy'),\n        { duration: 0, title: 'Ungeeignetes Signal' }\n      );\n      return;\n    }\n\n    // PHASE 2 REQUIREMENT: Show extra confirmation for BAD quality (score >= 30%)\n    // This runs ONLY if not blocked by magnitude check above\n    if (this.currentQualityResult.rating === 'BAD') {\n      const confirmed = confirm(\n        ' WARNUNG: Schlechte Aufnahmequalitt\\n\\n' +\n          'Die Qualitt dieser Aufnahme ist schlecht. Das Training knnte unzuverlssig sein.\\n\\n' +\n          'Probleme:\\n' +\n          this.currentQualityResult.issues.map((issue) => ` ${issue}`).join('\\n') +\n          '\\n\\n' +\n          'Mchten Sie trotzdem speichern?'\n      );\n\n      if (!confirmed) {\n        logger.info('User cancelled save due to bad quality warning');\n        return;\n      }\n    }\n\n    try {\n      // MULTICLASS: Determine label and type based on number of existing models\n      let label: string;\n      let type: 'healthy' | 'faulty';\n\n      // CRITICAL FIX: Store local reference to prevent race conditions\n      // If this.machine.referenceModels changes between checks, we maintain consistency\n      const existingModels = this.machine.referenceModels;\n\n      // CRITICAL FIX: Check if referenceModels exists before accessing length\n      if (!existingModels || existingModels.length === 0) {\n        // First recording: Always \"Baseline\" (healthy state)\n        label = 'Baseline';\n        type = 'healthy';\n        logger.info('First recording - using label: \"Baseline\", type: \"healthy\"');\n      } else {\n        // Additional recordings: Ask user for label and type\n        const userLabel = prompt(\n          'Geben Sie einen Namen fr diesen Maschinenzustand ein:\\n\\n' +\n            'Beispiele:\\n' +\n            ' Normale Betriebszustnde: \"Leerlauf\", \"Volllast\", \"Teillast\"\\n' +\n            ' Fehler: \"Unwucht simuliert\", \"Lagerschaden\", \"Lfterfehler\"',\n          ''\n        );\n\n        if (!userLabel || userLabel.trim() === '') {\n          logger.info('User cancelled - no label provided');\n          notify.warning('Bitte einen Namen eingeben', { title: 'Abgebrochen' });\n          return;\n        }\n\n        label = userLabel.trim();\n\n        // Ask user for type: Is this a normal state or a fault?\n        const isHealthy = confirm(\n          `Zustand: \"${label}\"\\n\\n` +\n            'Ist dies ein NORMALER Betriebszustand?\\n\\n' +\n            ' OK (Ja)  Normaler Zustand (z.B. \"Leerlauf\", \"Volllast\")\\n' +\n            ' Abbrechen (Nein)  Bekannter Fehler (z.B. \"Unwucht\", \"Lagerschaden\")\\n\\n' +\n            'Hinweis: Diese Wahl bestimmt, ob eine Diagnose als \"gesund\" oder \"fehlerhaft\" angezeigt wird.'\n        );\n\n        type = isHealthy ? 'healthy' : 'faulty';\n        logger.info(`Additional recording - using label: \"${label}\", type: \"${type}\"`);\n      }\n\n      logger.info(' Saving reference model...');\n\n      // DEBUG LOGGING: Show which machine we're saving to\n      logger.debug(' Reference Save Debug:', {\n        machineId: this.machine.id,\n        machineName: this.machine.name,\n        label: label,\n        type: type,\n        existingModels: this.machine.referenceModels?.length || 0,\n      });\n\n      // Train GMIA model\n      const model = trainGMIA(this.currentTrainingData, this.machine.id);\n\n      // REMOVED: Weight magnitude validation check\n      // This check was too strict and caused false negatives (rejecting good recordings like hair dryer)\n      // Reason: Weight vectors from standardized features are naturally small (0.001-0.01 range)\n      // We now rely on the RMS amplitude check above, which is much more reliable\n      // The RMS check validates BEFORE standardization, preserving true signal strength\n\n      logger.info(\n        ` Model trained successfully (scaling constant: ${model.scalingConstant.toFixed(3)})`\n      );\n\n      // ============================================================================\n      // SCORE CALIBRATION: Self-Test for Baseline Score\n      // ============================================================================\n      // After training, we test the model against its own training data to determine\n      // the \"baseline score\" - how well the model recognizes itself.\n      //\n      // This baseline score is used to normalize diagnosis scores:\n      // DisplayedScore = (RawScore / BaselineScore) * 100\n      //\n      // This ensures that a perfect match (reference vs. same signal) shows 100%,\n      // even if the mathematical raw score is only 85-95% due to GMIA algorithm characteristics.\n      //\n      // Quality Gate: If baseline score < 75%, the recording is too noisy/unstable\n      // and should be rejected to prevent unreliable diagnoses.\n      // ============================================================================\n      logger.info(' Performing self-test for baseline score calibration...');\n\n      // Test model against multiple samples from its own training data\n      const numSamplesToTest = Math.min(20, this.currentFeatures.length);\n      const step = Math.max(1, Math.floor(this.currentFeatures.length / numSamplesToTest));\n      const testScores: number[] = [];\n\n      for (let i = 0; i < numSamplesToTest; i++) {\n        const featureIndex = Math.min(i * step, this.currentFeatures.length - 1);\n        const testFeature = this.currentFeatures[featureIndex];\n\n        try {\n          const diagnosis = classifyDiagnosticState(\n            [model],\n            testFeature,\n            this.currentTrainingData.config.sampleRate\n          );\n          testScores.push(diagnosis.healthScore);\n        } catch (error) {\n          logger.warn(` Self-test sample ${i} failed:`, error);\n          // Continue with remaining samples\n        }\n      }\n\n      // Calculate average baseline score\n      if (testScores.length === 0) {\n        throw new Error('Self-test failed: No valid scores could be calculated');\n      }\n\n      const baselineScore = testScores.reduce((sum, s) => sum + s, 0) / testScores.length;\n      logger.info(\n        ` Baseline Score: ${baselineScore.toFixed(1)}% (averaged from ${testScores.length} samples)`\n      );\n      logger.info(\n        `   Score range: ${Math.min(...testScores).toFixed(1)}% - ${Math.max(...testScores).toFixed(1)}%`\n      );\n\n      // QUALITY GATE: Reject reference if baseline score is too low\n      const MIN_BASELINE_SCORE = 75;\n      if (baselineScore < MIN_BASELINE_SCORE) {\n        logger.error(\n          ` Baseline score too low: ${baselineScore.toFixed(1)}% (minimum: ${MIN_BASELINE_SCORE}%)`\n        );\n        notify.error(\n          `Referenzaufnahme zu undeutlich oder verrauscht.\\n\\n` +\n            `Selbsterkennungs-Score: ${baselineScore.toFixed(1)}%\\n` +\n            `Minimum erforderlich: ${MIN_BASELINE_SCORE}%\\n\\n` +\n            `Mgliche Ursachen:\\n` +\n            ` Signal zu schwach oder instabil\\n` +\n            ` Zu viel Hintergrundgerusch\\n` +\n            ` Maschine luft nicht konstant\\n\\n` +\n            `Bitte Aufnahme unter besseren Bedingungen wiederholen:\\n` +\n            ` Mikrofon nher an der Maschine (10-30cm)\\n` +\n            ` Ruhige Umgebung\\n` +\n            ` Maschine luft stabil whrend gesamter Aufnahme`,\n          new Error('Baseline score too low'),\n          { title: 'Referenzaufnahme ungeeignet', duration: 0 }\n        );\n        return;\n      }\n\n      logger.info(\n        ` Quality Gate passed: Baseline score ${baselineScore.toFixed(1)}%  ${MIN_BASELINE_SCORE}%`\n      );\n\n      // Add baseline score, label and type to model\n      model.baselineScore = baselineScore;\n      model.label = label;\n      model.type = type;\n\n      // Save model to database\n      await updateMachineModel(this.machine.id, model);\n\n      logger.info(` Reference model \"${label}\" trained and saved!`);\n\n      // VISUAL POSITIONING: Save reference image to machine (if captured)\n      if (this.capturedReferenceImage) {\n        const { getMachine, saveMachine } = await import('@data/db.js');\n        const machineToUpdate = await getMachine(this.machine.id);\n        if (machineToUpdate) {\n          machineToUpdate.referenceImage = this.capturedReferenceImage;\n          await saveMachine(machineToUpdate);\n          logger.info(\n            ` Reference image saved to machine (${this.capturedReferenceImage.size} bytes)`\n          );\n        }\n      }\n\n      // Reload machine to get updated referenceModels array\n      const { getMachine } = await import('@data/db.js');\n      const updatedMachine = await getMachine(this.machine.id);\n      if (updatedMachine) {\n        this.machine = updatedMachine;\n\n        // CRITICAL FIX: Notify other phases (especially DiagnosePhase) about the updated machine\n        // This ensures the UI updates and diagnosis can use the new model immediately\n        if (this.onMachineUpdated) {\n          this.onMachineUpdated(updatedMachine);\n        }\n      }\n\n      // Hide review modal\n      this.hideReviewModal();\n\n      // Show success with option to download reference audio\n      this.showSuccessWithExport();\n\n      // Show multiclass status (list of trained states + \"Train Another\" button)\n      this.showMulticlassStatus();\n\n      // Clear stored data\n      this.currentAudioBuffer = null;\n      this.currentFeatures = [];\n      this.currentQualityResult = null;\n      this.currentTrainingData = null;\n    } catch (error) {\n      logger.error('Save error:', error);\n      notify.error('Speichern fehlgeschlagen', error as Error, {\n        title: 'Fehler beim Speichern',\n        duration: 0,\n      });\n    }\n  }\n\n  /**\n   * Show multiclass training status\n   *\n   * Displays:\n   * - List of all trained states (with labels and dates)\n   * - \"Train Another State\" button\n   */\n  private showMulticlassStatus(): void {\n    // Find or create status container\n    let statusContainer = document.getElementById('multiclass-status');\n    if (!statusContainer) {\n      // Create container if it doesn't exist\n      // CRITICAL FIX: Use correct class selector from HTML (container-content, not phase-content)\n      const parentContainer = document.querySelector(\n        '#record-reference-content .container-content'\n      );\n      if (!parentContainer) return;\n\n      statusContainer = document.createElement('div');\n      statusContainer.id = 'multiclass-status';\n      statusContainer.className = 'multiclass-status';\n      parentContainer.appendChild(statusContainer);\n    }\n\n    // Clear existing content\n    statusContainer.innerHTML = '';\n\n    // Title\n    const title = document.createElement('h3');\n    title.textContent = 'Trainierte Zustnde';\n    statusContainer.appendChild(title);\n\n    // List of trained states\n    const stateList = document.createElement('ul');\n    stateList.className = 'state-list';\n\n    // CRITICAL FIX: Store local reference to prevent race conditions\n    // This ensures we iterate over the same snapshot even if this.machine.referenceModels changes\n    const models = this.machine.referenceModels;\n\n    // CRITICAL FIX: Check if referenceModels exists before iterating\n    if (models && models.length > 0) {\n      models.forEach((model) => {\n        const li = document.createElement('li');\n        li.className = 'state-item';\n\n        const dateStr = model.trainingDate\n          ? new Date(model.trainingDate).toLocaleString('de-DE', {\n              day: '2-digit',\n              month: '2-digit',\n              year: 'numeric',\n              hour: '2-digit',\n              minute: '2-digit',\n            })\n          : 'unbekannt';\n\n        // Use textContent instead of innerHTML to prevent XSS attacks\n        const labelSpan = document.createElement('span');\n        labelSpan.className = 'state-label';\n        labelSpan.textContent = model.label;\n\n        const dateSpan = document.createElement('span');\n        dateSpan.className = 'state-date';\n        dateSpan.textContent = dateStr;\n\n        li.appendChild(labelSpan);\n        li.appendChild(dateSpan);\n\n        stateList.appendChild(li);\n      });\n    }\n\n    statusContainer.appendChild(stateList);\n\n    // \"Train Another State\" button\n    const trainAnotherBtn = document.createElement('button');\n    trainAnotherBtn.id = 'train-another-btn';\n    trainAnotherBtn.className = 'btn btn-secondary';\n    trainAnotherBtn.textContent = 'Weiteren Zustand trainieren';\n    trainAnotherBtn.onclick = () => this.startRecording();\n    statusContainer.appendChild(trainAnotherBtn);\n\n    // Show container\n    statusContainer.style.display = 'block';\n  }\n\n  private applyAppShellLayout(): void {\n    const recordingModal = document.getElementById('recording-modal');\n    if (recordingModal) {\n      const recordingContent = recordingModal.querySelector('.modal-content');\n      if (recordingContent) {\n        recordingContent.classList.add('app-shell-container');\n        const header = recordingContent.querySelector('.modal-header');\n        const body = recordingContent.querySelector('.modal-body');\n        const footer = recordingContent.querySelector('.modal-actions');\n\n        header?.classList.add('shell-header');\n        body?.classList.add('shell-content');\n        footer?.classList.add('shell-footer');\n\n        if (header && !header.querySelector('#reference-instruction')) {\n          const instruction = document.createElement('p');\n          instruction.id = 'reference-instruction';\n          instruction.className = 'modal-instruction';\n          instruction.textContent = 'Halten Sie das Mikrofon 1030 cm vor die Maschine.';\n          header.appendChild(instruction);\n        }\n\n        if (body) {\n          let visualizerContainer = body.querySelector<HTMLDivElement>('#visualizer-container');\n          if (!visualizerContainer) {\n            visualizerContainer = document.createElement('div');\n            visualizerContainer.id = 'visualizer-container';\n            visualizerContainer.className = 'visualizer-container';\n          }\n\n          const waveformCanvas = body.querySelector('#waveform-canvas');\n          const gaugeCanvas = body.querySelector('#health-gauge-canvas');\n\n          if (waveformCanvas && waveformCanvas.parentElement !== visualizerContainer) {\n            visualizerContainer.appendChild(waveformCanvas);\n          }\n          if (gaugeCanvas && gaugeCanvas.parentElement !== visualizerContainer) {\n            visualizerContainer.appendChild(gaugeCanvas);\n          }\n\n          if (!visualizerContainer.parentElement) {\n            body.insertBefore(visualizerContainer, body.firstChild);\n          } else if (body.firstChild !== visualizerContainer) {\n            body.insertBefore(visualizerContainer, body.firstChild);\n          }\n        }\n      }\n    }\n\n    const modal = document.getElementById('review-modal');\n    if (!modal) return;\n\n    const modalContent = modal.querySelector('.modal-content');\n    if (!modalContent) return;\n\n    modalContent.classList.add('app-shell-container');\n    modalContent.querySelector('.modal-header')?.classList.add('shell-header');\n    modalContent.querySelector('.modal-body')?.classList.add('shell-content');\n    modalContent.querySelector('.modal-actions')?.classList.add('shell-footer');\n  }\n\n  /**\n   * Destroy phase and cleanup all resources\n   */\n  public destroy(): void {\n    this.cleanup();\n\n    // CRITICAL FIX: Remove event listener to prevent stacking on re-init\n    if (this.recordButtonClickHandler) {\n      const recordBtn = document.getElementById('record-btn');\n      if (recordBtn) {\n        recordBtn.removeEventListener('click', this.recordButtonClickHandler);\n      }\n      this.recordButtonClickHandler = null;\n    }\n\n    // Destroy visualizer\n    if (this.visualizer) {\n      this.visualizer.destroy();\n      this.visualizer = null;\n    }\n\n    // Clear audio chunks\n    this.audioChunks = [];\n    this.recordedBlob = null;\n  }\n}\n","/**\n * ZANOBOT - HEALTH GAUGE COMPONENT\n *\n * Visual gauge/dial that displays health score (0-100%).\n * Color-coded: Green (healthy), Yellow (uncertain), Red (faulty).\n */\n\nimport { logger } from '@utils/logger.js';\n\nexport class HealthGauge {\n  private canvas: HTMLCanvasElement;\n  private ctx: CanvasRenderingContext2D;\n  private score: number = 0;\n  private customStatus: string | undefined = undefined;\n  private animationFrame: number | null = null;\n\n  // Theme-aware colors (read from CSS variables)\n  private colors = {\n    healthy: '#00E676',\n    warning: '#FFB74D',\n    error: '#FF5252',\n    text: '#FFFFFF',\n    textMuted: '#888888',\n    background: '#2a2a2a'\n  };\n\n  constructor(canvasId: string) {\n    const canvas = document.getElementById(canvasId) as HTMLCanvasElement;\n    if (!canvas) {\n      throw new Error(`Canvas element not found: ${canvasId}`);\n    }\n\n    this.canvas = canvas;\n    const ctx = canvas.getContext('2d');\n    if (!ctx) {\n      throw new Error('Could not get 2D context');\n    }\n\n    this.ctx = ctx;\n    this.setCanvasSize();\n    this.updateThemeColors();\n\n    // Listen for theme changes\n    this.observeThemeChanges();\n  }\n\n  /**\n   * Read theme colors from CSS variables for consistent theming\n   */\n  private updateThemeColors(): void {\n    const styles = getComputedStyle(document.documentElement);\n\n    this.colors = {\n      healthy: styles.getPropertyValue('--status-healthy').trim() || '#00E676',\n      warning: styles.getPropertyValue('--status-warning').trim() || '#FFB74D',\n      error: styles.getPropertyValue('--status-error').trim() || '#FF5252',\n      text: styles.getPropertyValue('--text-primary').trim() || '#FFFFFF',\n      textMuted: styles.getPropertyValue('--text-muted').trim() || '#888888',\n      background: styles.getPropertyValue('--bg-tertiary').trim() || '#2a2a2a'\n    };\n  }\n\n  /**\n   * Observe theme changes and update colors accordingly\n   */\n  private observeThemeChanges(): void {\n    const observer = new MutationObserver((mutations) => {\n      mutations.forEach((mutation) => {\n        if (mutation.attributeName === 'data-theme') {\n          this.updateThemeColors();\n          this.render();\n        }\n      });\n    });\n\n    observer.observe(document.documentElement, {\n      attributes: true,\n      attributeFilter: ['data-theme']\n    });\n  }\n\n  private setCanvasSize(): void {\n    const dpr = window.devicePixelRatio || 1;\n    const rect = this.canvas.getBoundingClientRect();\n\n    this.canvas.width = rect.width * dpr;\n    this.canvas.height = rect.height * dpr;\n\n    // Reset transform to prevent cumulative scaling on repeated instantiation\n    this.ctx.setTransform(1, 0, 0, 1, 0, 0);\n    this.ctx.scale(dpr, dpr);\n  }\n\n  /**\n   * Draw gauge with score and status (Real-time compatible)\n   *\n   * CRITICAL FIX: Comprehensive input validation to prevent canvas errors\n   *\n   * @param score - Health score (0-100)\n   * @param status - Status label (optional, auto-calculated if omitted)\n   */\n  public draw(score: number, status?: string): void {\n    // CRITICAL FIX: Validate score is a valid number\n    if (!isFinite(score) || score < 0 || score > 100) {\n      logger.error(` HealthGauge: Invalid score: ${score}, using 0`);\n      this.score = 0;\n    } else {\n      this.score = Math.max(0, Math.min(100, score));\n    }\n\n    // CRITICAL FIX: Validate status if provided\n    if (status !== undefined) {\n      const validStatuses = ['healthy', 'uncertain', 'faulty', 'UNKNOWN'];\n      if (!validStatuses.includes(status)) {\n        logger.error(` HealthGauge: Invalid status: ${status}, using UNKNOWN`);\n        this.customStatus = 'UNKNOWN';\n      } else {\n        this.customStatus = status;\n      }\n    } else {\n      this.customStatus = status;\n    }\n\n    this.render();\n  }\n\n  /**\n   * Update and render the gauge with new score\n   *\n   * CRITICAL FIX: Input validation to prevent invalid scores\n   *\n   * @param score - Health score (0-100)\n   * @param animate - Whether to animate the transition\n   */\n  public updateScore(score: number, animate: boolean = true): void {\n    // CRITICAL FIX: Validate score is a valid number\n    if (!isFinite(score) || score < 0 || score > 100) {\n      logger.error(` HealthGauge.updateScore: Invalid score: ${score}, using 0`);\n      score = 0;\n    }\n\n    const targetScore = Math.max(0, Math.min(100, score));\n\n    // CRITICAL FIX: Reset custom status to allow auto-calculated status\n    this.customStatus = undefined;\n\n    if (animate) {\n      this.animateToScore(targetScore);\n    } else {\n      this.score = targetScore;\n      this.render();\n    }\n  }\n\n  private animateToScore(targetScore: number): void {\n    const startScore = this.score;\n    const diff = targetScore - startScore;\n    const duration = 1000; // 1 second\n    const startTime = Date.now();\n\n    const animate = (): void => {\n      const elapsed = Date.now() - startTime;\n      const progress = Math.min(elapsed / duration, 1);\n\n      // Ease out cubic\n      const eased = 1 - Math.pow(1 - progress, 3);\n\n      this.score = startScore + diff * eased;\n      this.render();\n\n      if (progress < 1) {\n        this.animationFrame = requestAnimationFrame(animate);\n      }\n    };\n\n    if (this.animationFrame) {\n      cancelAnimationFrame(this.animationFrame);\n    }\n\n    animate();\n  }\n\n  private render(): void {\n    const width = this.canvas.width / (window.devicePixelRatio || 1);\n    const height = this.canvas.height / (window.devicePixelRatio || 1);\n    const centerX = width / 2;\n    const centerY = height / 2;\n    // CRITICAL FIX: Prevent negative radius for small/hidden canvas\n    const radius = Math.max(0, Math.min(width, height) / 2 - 20);\n\n    // Clear canvas\n    this.ctx.clearRect(0, 0, width, height);\n\n    // Draw background arc (theme-aware)\n    this.drawArc(centerX, centerY, radius, 0, 100, this.colors.background, 8);\n\n    // Draw score arc\n    const color = this.getScoreColor(this.score);\n    this.drawArc(centerX, centerY, radius, 0, this.score, color, 10);\n\n    // Draw center text\n    this.drawText(centerX, centerY, this.score);\n  }\n\n  private drawArc(\n    x: number,\n    y: number,\n    radius: number,\n    startScore: number,\n    endScore: number,\n    color: string,\n    lineWidth: number\n  ): void {\n    const startAngle = this.scoreToAngle(startScore);\n    const endAngle = this.scoreToAngle(endScore);\n\n    this.ctx.beginPath();\n    this.ctx.arc(x, y, radius, startAngle, endAngle);\n    this.ctx.strokeStyle = color;\n    this.ctx.lineWidth = lineWidth;\n    this.ctx.lineCap = 'round';\n    this.ctx.stroke();\n  }\n\n  private scoreToAngle(score: number): number {\n    // Map score (0-100) to angle (-135 to +135, 270 total arc)\n    const startAngle = -135 * (Math.PI / 180); // -135\n    const totalAngle = 270 * (Math.PI / 180); // 270\n    return startAngle + (score / 100) * totalAngle;\n  }\n\n  private drawText(x: number, y: number, score: number): void {\n    // Draw score value (theme-aware text color)\n    this.ctx.font = 'bold 48px system-ui, -apple-system, sans-serif';\n    this.ctx.fillStyle = this.colors.text;\n    this.ctx.textAlign = 'center';\n    this.ctx.textBaseline = 'middle';\n    this.ctx.fillText(Math.round(score).toString(), x, y - 10);\n\n    // Draw percentage symbol (theme-aware muted color)\n    this.ctx.font = '24px system-ui, -apple-system, sans-serif';\n    this.ctx.fillStyle = this.colors.textMuted;\n    this.ctx.fillText('%', x, y + 30);\n\n    // Draw status label (use custom status if provided, otherwise auto-calculate)\n    const status = this.customStatus !== undefined ? this.customStatus : this.getStatusLabel(score);\n    this.ctx.font = '16px system-ui, -apple-system, sans-serif';\n    this.ctx.fillStyle = this.getScoreColor(score);\n    this.ctx.fillText(status, x, y + 60);\n  }\n\n  private getScoreColor(score: number): string {\n    // Use theme-aware status colors from CSS variables\n    if (score >= 75) {\n      return this.colors.healthy;\n    } else if (score >= 50) {\n      return this.colors.warning;\n    } else {\n      return this.colors.error;\n    }\n  }\n\n  private getStatusLabel(score: number): string {\n    if (score >= 75) {\n      return 'UNAUFFLLIG';\n    } else if (score >= 50) {\n      return 'ABWEICHUNG';\n    } else {\n      return 'AUFFLLIG';\n    }\n  }\n\n  /**\n   * Destroy the component and clean up\n   */\n  public destroy(): void {\n    if (this.animationFrame) {\n      cancelAnimationFrame(this.animationFrame);\n    }\n  }\n}\n","/**\n * ZANOBOT - PHASE 3: DIAGNOSE (REAL-TIME)\n *\n * Real-time operation mode with live feedback loop.\n *\n * Flow:\n * 1. Stream audio continuously\n * 2. Process in 330ms chunks (3-4x per second)\n * 3. Extract features  GMIA inference  Health score\n * 4. Apply filtering (last 10 scores, trim 2 min/max)\n * 5. Update HealthGauge in real-time\n * 6. User sees live feedback (\"Sweet Spot Search\")\n * 7. Stop button saves final filtered score\n */\n\nimport { extractFeaturesFromChunk, DEFAULT_DSP_CONFIG } from '@core/dsp/features.js';\nimport { inferGMIA } from '@core/ml/gmia.js';\nimport {\n  calculateHealthScore,\n  ScoreHistory,\n  LabelHistory,\n  getClassificationDetails,\n  classifyDiagnosticState,\n  classifyHealthStatus,\n  MIN_CONFIDENT_MATCH_SCORE,\n} from '@core/ml/scoring.js';\nimport { saveDiagnosis, getMachine } from '@data/db.js';\nimport { AudioVisualizer } from '@ui/components/AudioVisualizer.js';\nimport { HealthGauge } from '@ui/components/HealthGauge.js';\nimport {\n  getRawAudioStream,\n  getSmartStartStatusMessage,\n  DEFAULT_SMART_START_CONFIG,\n} from '@core/audio/audioHelper.js';\nimport { AudioWorkletManager, isAudioWorkletSupported } from '@core/audio/audioWorkletHelper.js';\nimport { notify } from '@utils/notifications.js';\nimport type { Machine, DiagnosisResult, GMIAModel } from '@data/types.js';\nimport { logger } from '@utils/logger.js';\nimport { BUTTON_TEXT, MODAL_TITLE } from '@ui/constants.js';\n\nexport class DiagnosePhase {\n  private machine: Machine;\n  private selectedDeviceId: string | undefined; // Selected microphone device ID\n  private audioContext: AudioContext | null = null;\n  private mediaStream: MediaStream | null = null;\n  private cameraStream: MediaStream | null = null; // VISUAL POSITIONING: Camera stream for ghost overlay\n  private audioWorkletManager: AudioWorkletManager | null = null;\n  private visualizer: AudioVisualizer | null = null;\n  private healthGauge: HealthGauge | null = null;\n  private activeModels: GMIAModel[] = [];\n\n  // Real-time processing\n  private isProcessing: boolean = false;\n  private scoreHistory: ScoreHistory;\n  private labelHistory: LabelHistory; // CRITICAL FIX: Label history for majority voting\n  private lastProcessedScore: number = 0;\n  private lastProcessedStatus: 'healthy' | 'uncertain' | 'faulty' | 'UNKNOWN' = 'UNKNOWN';\n  private lastDetectedState: string = 'UNKNOWN'; // MULTICLASS: Store detected state\n  private hasValidMeasurement: boolean = false; // Track if actual measurement occurred\n  private useAudioWorklet: boolean = true;\n  private isStarting: boolean = false;\n  private isSaving: boolean = false; // CRITICAL FIX: Prevent duplicate save calls\n\n  // DEBUG: Store last calculation values for UI display\n  private lastDebugValues: {\n    weightMagnitude: number;\n    featureMagnitude: number;\n    magnitudeFactor: number;\n    cosine: number;\n    adjustedCosine: number;\n    scalingConstant: number;\n    rawScore: number;\n  } | null = null;\n\n  // Configuration\n  private chunkSize: number; // 330ms in samples\n  // CRITICAL FIX: Use 48000 Hz to match AUDIO_CONSTRAINTS.sampleRate\n  // This prevents unnecessary browser resampling (48k hardware  44.1k context)\n  private requestedSampleRate: number = 48000; // Requested sample rate\n  private actualSampleRate: number = 48000; // Actual sample rate from AudioContext\n  private dspConfig: typeof DEFAULT_DSP_CONFIG; // DSP config with actual sample rate\n\n  // CRITICAL FIX: Store event listener reference for proper cleanup\n  private diagnoseButtonClickHandler: (() => void) | null = null;\n\n  constructor(machine: Machine, selectedDeviceId?: string) {\n    this.machine = machine;\n    this.selectedDeviceId = selectedDeviceId;\n\n    // DEBUG LOGGING: Show which machine is being used for diagnosis\n    logger.debug(' DiagnosePhase Constructor:', {\n      machineId: machine.id,\n      machineName: machine.name,\n      numModels: machine.referenceModels?.length || 0,\n    });\n\n    // Initialize with default config (will be updated when AudioContext is created)\n    this.chunkSize = Math.floor(DEFAULT_DSP_CONFIG.windowSize * this.requestedSampleRate);\n    this.dspConfig = { ...DEFAULT_DSP_CONFIG };\n\n    // Initialize score history for filtering\n    this.scoreHistory = new ScoreHistory();\n    // CRITICAL FIX: Initialize label history for majority voting\n    this.labelHistory = new LabelHistory();\n  }\n\n  /**\n   * Update machine data (e.g., after new reference model is added)\n   */\n  public setMachine(machine: Machine): void {\n    this.machine = machine;\n    logger.debug(' Machine updated in DiagnosePhase:', {\n      machineId: machine.id,\n      machineName: machine.name,\n      numModels: machine.referenceModels?.length || 0,\n    });\n  }\n\n  /**\n   * Initialize the diagnose phase UI\n   */\n  public init(): void {\n    this.applyAppShellLayout();\n    const diagnoseBtn = document.getElementById('diagnose-btn');\n    if (diagnoseBtn) {\n      // CRITICAL FIX: Store handler reference to enable cleanup in destroy()\n      this.diagnoseButtonClickHandler = () => this.startDiagnosis();\n      diagnoseBtn.addEventListener('click', this.diagnoseButtonClickHandler);\n    }\n  }\n\n  /**\n   * Start real-time diagnosis with Smart Start\n   */\n  private async startDiagnosis(): Promise<void> {\n    if (this.isStarting || this.isProcessing || this.mediaStream) {\n      notify.warning('Eine Diagnose luft bereits.');\n      return;\n    }\n\n    try {\n      // Refresh machine data to ensure latest reference models are loaded\n      const latestMachine = await getMachine(this.machine.id);\n      if (latestMachine) {\n        this.machine = latestMachine;\n      } else {\n        notify.error('Maschine nicht gefunden. Bitte neu auswhlen.');\n        return;\n      }\n\n      // DEBUG LOGGING: Show which machine and models are loaded\n      logger.debug(' Diagnosis Start Debug:', {\n        machineId: this.machine.id,\n        machineName: this.machine.name,\n        numModels: this.machine.referenceModels?.length || 0,\n        models: this.machine.referenceModels?.map(m => ({\n          label: m.label,\n          trainingDate: new Date(m.trainingDate).toLocaleString(),\n          sampleRate: m.sampleRate,\n          weightMagnitude: m.metadata?.weightMagnitude?.toFixed(6) || 'N/A',\n        })) || [],\n      });\n\n      // Check if machine has reference models (multiclass)\n      if (!this.machine.referenceModels || this.machine.referenceModels.length === 0) {\n        notify.error('Kein Referenzmodell gefunden. Bitte zuerst eine Referenzaufnahme erstellen.');\n        return;\n      }\n\n      logger.info(' Starting REAL-TIME diagnosis with Smart Start...');\n\n      // Check AudioWorklet support - CRITICAL for real-time processing\n      this.useAudioWorklet = isAudioWorkletSupported();\n      if (!this.useAudioWorklet) {\n        logger.error(' AudioWorklet not supported - Real-time diagnosis requires AudioWorklet');\n        notify.error(\n          'Ihr Browser untersttzt keine Real-Time-Diagnose. Bitte verwenden Sie Chrome, Edge oder Safari.',\n          new Error('AudioWorklet not supported'),\n          { title: 'Browser nicht kompatibel', duration: 0 }\n        );\n        return;\n      }\n\n      this.isStarting = true;\n\n      // Reset state for new diagnosis\n      this.hasValidMeasurement = false;\n      this.lastProcessedScore = 0;\n      this.lastProcessedStatus = 'UNKNOWN';\n      this.lastDetectedState = 'UNKNOWN'; // MULTICLASS: Reset detected state\n      this.scoreHistory.clear();\n      this.labelHistory.clear(); // CRITICAL FIX: Clear label history\n\n      // CRITICAL FIX: Validate sample rate compatibility BEFORE creating any resources\n      // This prevents allocating AudioContext/MediaStream that must be immediately destroyed\n      const expectedSampleRate = this.machine.referenceModels[0]?.sampleRate;\n      if (!expectedSampleRate) {\n        notify.error('Kein Referenzmodell mit gltiger Sample Rate gefunden.');\n        this.isStarting = false;\n        return;\n      }\n\n      // Check if all models have the same sample rate\n      const uniqueRates = [...new Set(this.machine.referenceModels.map(m => m.sampleRate))];\n      if (uniqueRates.length > 1) {\n        logger.warn(` Multiple sample rates in models: ${uniqueRates.join(', ')}Hz`);\n      }\n\n      // Request microphone access using central helper with selected device\n      this.mediaStream = await getRawAudioStream(this.selectedDeviceId);\n\n      // VISUAL POSITIONING: Request camera access for ghost overlay\n      // Non-blocking: If camera access fails, continue with audio only\n      try {\n        this.cameraStream = await navigator.mediaDevices.getUserMedia({\n          video: { facingMode: 'environment' }, // Prefer back camera on mobile\n          audio: false,\n        });\n        logger.info(' Camera access granted for ghost overlay');\n      } catch (cameraError) {\n        logger.warn(' Camera access denied or not available - continuing without ghost overlay', cameraError);\n        notify.info('Kamera nicht verfgbar. Diagnose wird ohne Positionshilfe fortgesetzt.', {\n          title: 'Kamera optional',\n        });\n        this.cameraStream = null;\n      }\n\n      // Create audio context with the expected sample rate\n      // Note: Browser may still override this based on hardware capabilities\n      this.audioContext = new AudioContext({ sampleRate: expectedSampleRate });\n\n      // CRITICAL FIX: Update configuration with actual sample rate\n      this.actualSampleRate = this.audioContext.sampleRate;\n\n      if (this.actualSampleRate !== expectedSampleRate) {\n        logger.warn(\n          ` AudioContext sample rate is ${this.actualSampleRate}Hz instead of requested ${expectedSampleRate}Hz`\n        );\n        logger.warn(\n          ` This indicates hardware does not support ${expectedSampleRate}Hz - sample rate mismatch!`\n        );\n      }\n\n      // CRITICAL: Validate sample rate compatibility with trained models\n      // This check now happens AFTER we know the actual hardware rate\n      this.activeModels = this.machine.referenceModels.filter(\n        (model) => model.sampleRate === this.actualSampleRate\n      );\n      if (this.activeModels.length === 0) {\n        const rateList = [...new Set(this.machine.referenceModels.map((model) => model.sampleRate))]\n          .sort((a, b) => a - b)\n          .join(', ');\n        logger.error(\n          ` Sample Rate Mismatch: Hardware=${this.actualSampleRate}Hz, ModelRates=[${rateList}]`\n        );\n        notify.error(\n          `Audio-Setup Fehler: Ihr Mikrofon luft bei ${this.actualSampleRate}Hz, aber kein ` +\n            `Referenzmodell wurde bei dieser Sample Rate trainiert (Modelle: ${rateList}Hz). ` +\n            'Bitte verwenden Sie das gleiche Audio-Setup wie beim Training oder erstellen Sie ' +\n            'ein neues Referenzmodell mit der aktuellen Sample Rate.',\n          new Error('Sample Rate Mismatch'),\n          {\n            title: 'Inkompatible Sample Rate',\n            duration: 0,\n          }\n        );\n        // Clean up and abort\n        this.cleanup();\n        return;\n      }\n\n      if (this.activeModels.length < this.machine.referenceModels.length) {\n        logger.warn(\n          ` Sample Rate Filter: ${this.activeModels.length}/${this.machine.referenceModels.length} Modelle kompatibel (${this.actualSampleRate}Hz)`\n        );\n      }\n\n      logger.info(\n        ` Sample Rate validation passed: ${this.actualSampleRate}Hz (matches model training)`\n      );\n\n      // Update chunkSize and DSP config with actual sample rate\n      this.chunkSize = Math.floor(DEFAULT_DSP_CONFIG.windowSize * this.actualSampleRate);\n      this.dspConfig = {\n        ...DEFAULT_DSP_CONFIG,\n        sampleRate: this.actualSampleRate,\n        frequencyRange: [0, this.actualSampleRate / 2], // Update Nyquist frequency\n      };\n\n      logger.debug(\n        ` DSP Config: sampleRate=${this.dspConfig.sampleRate}Hz, chunkSize=${this.chunkSize} samples, windowSize=${DEFAULT_DSP_CONFIG.windowSize}s`\n      );\n\n      // Show recording modal\n      this.showRecordingModal();\n\n      // Initialize HealthGauge\n      const gaugeCanvas = document.getElementById('health-gauge-canvas');\n      if (gaugeCanvas) {\n        this.healthGauge = new HealthGauge('health-gauge-canvas');\n        this.healthGauge.draw(0, 'UNKNOWN'); // Initial state\n      }\n\n      // Start visualizer\n      const waveformCanvas = document.getElementById('waveform-canvas');\n      if (waveformCanvas) {\n        this.visualizer = new AudioVisualizer('waveform-canvas');\n        this.visualizer.start(this.audioContext, this.mediaStream);\n      }\n\n      // Initialize AudioWorklet Manager (always available at this point)\n      this.audioWorkletManager = new AudioWorkletManager({\n        bufferSize: this.chunkSize * 2,\n        warmUpDuration: DEFAULT_SMART_START_CONFIG.warmUpDuration, // Use config as Single Source of Truth\n        onAudioChunk: (chunk) => {\n          // Real-time audio chunk received from worklet\n          if (this.isProcessing) {\n            this.processChunkDirectly(chunk);\n          }\n        },\n        onSmartStartStateChange: (state) => {\n          const statusMsg = getSmartStartStatusMessage(state);\n          this.updateSmartStartStatus(statusMsg);\n        },\n        onSmartStartComplete: (rms) => {\n          logger.info(` Smart Start: Signal detected! RMS: ${rms.toFixed(4)}`);\n          this.updateSmartStartStatus('Diagnose luft');\n          this.isProcessing = true; // Start processing incoming chunks\n        },\n        onSmartStartTimeout: () => {\n          logger.warn(' Smart Start timeout - cleaning up resources');\n          notify.warning('Bitte nher an die Maschine gehen und erneut versuchen.', {\n            title: 'Kein Signal erkannt',\n          });\n          // CRITICAL FIX: Call cleanup() to properly release all resources\n          this.cleanup();\n          this.hideRecordingModal();\n        },\n      });\n\n      // Initialize AudioWorklet\n      await this.audioWorkletManager.init(this.audioContext, this.mediaStream);\n\n      // Start Smart Start sequence\n      this.audioWorkletManager.startSmartStart();\n\n      logger.info(' Real-time diagnosis initialized!');\n    } catch (error) {\n      logger.error('Diagnosis error:', error);\n      notify.error('Mikrofonzugriff fehlgeschlagen', error as Error, {\n        title: 'Zugriff verweigert',\n        duration: 0,\n      });\n\n      // Cleanup on error\n      this.cleanup();\n      this.hideRecordingModal();\n    } finally {\n      this.isStarting = false;\n    }\n  }\n\n  /**\n   * Cleanup resources (AudioContext, MediaStream, etc.)\n   */\n  private cleanup(): void {\n    // Stop processing\n    this.isProcessing = false;\n    this.isStarting = false;\n\n    // Reset state flags to prevent memory leaks\n    this.hasValidMeasurement = false;\n    this.lastProcessedScore = 0;\n    this.lastProcessedStatus = 'UNKNOWN';\n    this.lastDetectedState = 'UNKNOWN'; // MULTICLASS: Reset detected state\n    this.scoreHistory.clear();\n    this.labelHistory.clear(); // CRITICAL FIX: Clear label history\n\n    // Cleanup AudioWorklet\n    if (this.audioWorkletManager) {\n      this.audioWorkletManager.cleanup();\n      this.audioWorkletManager = null;\n    }\n\n    // Stop visualizer\n    if (this.visualizer) {\n      this.visualizer.stop();\n    }\n\n    // Stop media stream tracks\n    if (this.mediaStream) {\n      this.mediaStream.getTracks().forEach((track) => track.stop());\n      this.mediaStream = null;\n    }\n\n    // VISUAL POSITIONING: Stop camera stream\n    if (this.cameraStream) {\n      this.cameraStream.getTracks().forEach((track) => track.stop());\n      this.cameraStream = null;\n    }\n\n    // Close audio context with error handling to prevent leaks\n    if (this.audioContext && this.audioContext.state !== 'closed') {\n      try {\n        this.audioContext.close();\n      } catch (error) {\n        logger.warn(' Error closing AudioContext:', error);\n      } finally {\n        // Always null the reference to prevent leaks\n        this.audioContext = null;\n      }\n    }\n\n    // Clean up dynamically created DOM elements to prevent memory leaks\n    // CRITICAL FIX: Only remove elements within the recording modal to avoid affecting other UI\n    const modal = document.getElementById('recording-modal');\n    if (modal) {\n      // Remove live display elements within modal only\n      const liveDisplays = modal.querySelectorAll('.live-display');\n      liveDisplays.forEach((element) => element.remove());\n\n      // Remove smart start status elements within modal only\n      const smartStartStatuses = modal.querySelectorAll('#smart-start-status');\n      smartStartStatuses.forEach((element) => element.remove());\n    }\n\n    logger.debug(' Cleanup complete');\n  }\n\n  /**\n   * Process audio chunk directly (called from AudioWorklet)\n   *\n   * This is the NEW real-time processing pipeline using AudioWorklet.\n   * Receives chunks directly from the audio thread.\n   *\n   * MULTICLASS MODE: Uses classifyDiagnosticState() to compare against all trained models.\n   *\n   * @param chunk - Audio chunk from AudioWorklet (4096 samples)\n   */\n  private processChunkDirectly(chunk: Float32Array): void {\n    // Check if processing is active to prevent race conditions during cleanup\n    if (!this.isProcessing) {\n      return;\n    }\n\n    // Validate reference models exist\n    if (!this.activeModels || this.activeModels.length === 0) {\n      return;\n    }\n\n    // CRITICAL FIX: Comprehensive chunk validation to prevent runtime errors\n    try {\n      // Validate chunk exists and is correct type\n      if (!chunk || !(chunk instanceof Float32Array)) {\n        logger.error(' Invalid chunk received: not a Float32Array');\n        return;\n      }\n\n      // Validate chunk is not empty\n      if (chunk.length === 0) {\n        logger.debug(' Empty chunk received, skipping');\n        return;\n      }\n\n      // CRITICAL: Ensure chunk has minimum required samples for feature extraction\n      // Required: this.chunkSize samples (330ms window = ~15840 samples at 48kHz, ~14553 at 44.1kHz)\n      // If chunk is smaller, skip processing and wait for more data from AudioWorklet\n      if (chunk.length < this.chunkSize) {\n        logger.debug(\n          ` Chunk too small: ${chunk.length} < ${this.chunkSize} samples, waiting for more data`\n        );\n        return;\n      }\n\n      // Extract exactly chunkSize samples for feature extraction (discard excess if any)\n      // This ensures consistent window sizes across all processing cycles\n      const processingChunk = chunk.slice(0, this.chunkSize);\n\n      // Step 1: Extract features (Energy Spectral Densities)\n      // CRITICAL FIX: Use actual sample rate from dspConfig (not hardcoded DEFAULT_DSP_CONFIG)\n      const featureVector = extractFeaturesFromChunk(processingChunk, this.dspConfig);\n\n      // Step 2: MULTICLASS CLASSIFICATION\n      // Compare against all trained models and find best match\n      // CRITICAL: Pass actualSampleRate for validation against model's training sample rate\n      const diagnosis = classifyDiagnosticState(\n        this.activeModels,\n        featureVector,\n        this.actualSampleRate\n      );\n\n      // Step 3: Add score to history for filtering\n      this.scoreHistory.addScore(diagnosis.healthScore);\n\n      // CRITICAL FIX: Add label to history for majority voting\n      const detectedState = (typeof diagnosis.metadata?.detectedState === 'string'\n        ? diagnosis.metadata.detectedState\n        : 'UNKNOWN');\n      this.labelHistory.addLabel(detectedState);\n\n      // Step 4: Get filtered score (trimmed mean of last 10)\n      const filteredScore = this.scoreHistory.getFilteredScore();\n\n      // Step 5: Derive status from filtered score for consistency\n      const filteredStatus = classifyHealthStatus(filteredScore);\n\n      // Step 6: Store debug values from diagnosis metadata\n      if (diagnosis.metadata?.debug) {\n        const debug = diagnosis.metadata.debug as {\n          weightMagnitude: number;\n          featureMagnitude: number;\n          magnitudeFactor: number;\n          cosine: number;\n          adjustedCosine: number;\n          scalingConstant: number;\n          rawScore: number;\n        };\n        this.lastDebugValues = debug;\n        logger.debug(' Debug values stored:', this.lastDebugValues);\n      } else {\n        logger.warn(' No debug values in diagnosis.metadata!', diagnosis.metadata);\n      }\n\n      // Step 7: Update UI in real-time with detected state and debug values\n      this.updateLiveDisplay(filteredScore, filteredStatus, detectedState);\n      this.updateDebugDisplay();\n\n      // Step 8: Store for final save (use filtered score/status for consistency)\n      this.lastProcessedScore = filteredScore;\n      this.lastProcessedStatus = filteredStatus;\n      this.lastDetectedState = detectedState; // MULTICLASS: Store detected state (will be replaced by majority vote on save)\n      this.hasValidMeasurement = true; // Mark that we have valid data\n\n      // Debug log every 10th update\n      if (this.scoreHistory.getAllScores().length % 10 === 0) {\n        logger.debug(\n          ` Live Score: ${filteredScore.toFixed(1)}% | State: ${detectedState} (${filteredStatus})`\n        );\n      }\n    } catch (error) {\n      logger.error('Chunk processing error:', error);\n\n      // CRITICAL: Check for sample rate mismatch error\n      if (error instanceof Error && error.message.includes('Sample Rate Mismatch')) {\n        // Stop processing immediately\n        this.isProcessing = false;\n\n        // Show user-friendly error message\n        notify.error(\n          'Audio-Setup Fehler: Die Sample Rate Ihres Mikrofons ' +\n            `(${this.actualSampleRate}Hz) stimmt nicht mit der Sample Rate des ` +\n            'trainierten Modells berein. Bitte verwenden Sie das gleiche Audio-Setup ' +\n            'wie beim Training oder erstellen Sie ein neues Referenzmodell.',\n          error,\n          {\n            title: 'Inkompatible Sample Rate',\n            duration: 0,\n          }\n        );\n\n        // Clean up resources\n        this.cleanup();\n        this.hideRecordingModal();\n      }\n    }\n  }\n\n  /**\n   * Update Smart Start status message\n   *\n   * Shows descriptive feedback during the extended settling time (5 seconds).\n   * This helps the user understand that the system is waiting for OS audio\n   * filters (AGC, noise cancellation) to stabilize.\n   */\n  private updateSmartStartStatus(message: string): void {\n    const statusElement = document.getElementById('smart-start-status');\n    if (statusElement) {\n      // Enhance the message with more descriptive text\n      let enhancedMessage = message;\n\n      if (message.includes('Stabilisierung')) {\n        enhancedMessage = ` ${message}\\n(Mikrofon pegelt ein, OS-Filter werden stabilisiert...)`;\n      } else if (message.includes('Warte')) {\n        enhancedMessage = ` ${message}`;\n      }\n\n      statusElement.textContent = enhancedMessage;\n\n      // Hide once recording starts\n      if (message.includes('luft')) {\n        statusElement.style.display = 'none';\n      }\n    }\n  }\n\n  /**\n   * Update debug display with calculation values\n   */\n  private updateDebugDisplay(): void {\n    if (!this.lastDebugValues) {\n      logger.warn(' updateDebugDisplay: No debug values available!');\n      return;\n    }\n\n    logger.debug(' Updating debug display with values:', this.lastDebugValues);\n    const v = this.lastDebugValues;\n\n    const updateElement = (id: string, text: string, highlight: boolean = false) => {\n      const el = document.getElementById(id);\n      if (el) {\n        el.textContent = text;\n        if (highlight) {\n          el.style.color = '#ff8800';\n          el.style.fontWeight = '700';\n        }\n        logger.debug(`   Updated ${id}: ${text}`);\n      } else {\n        logger.error(`   Element not found: ${id}`);\n      }\n    };\n\n    updateElement('debug-weight-magnitude', `weightMagnitude: ${v.weightMagnitude.toFixed(6)}`);\n    updateElement('debug-feature-magnitude', `featureMagnitude: ${v.featureMagnitude.toFixed(6)}`);\n    updateElement('debug-magnitude-factor', `magnitudeFactor: ${v.magnitudeFactor.toFixed(4)}`, v.magnitudeFactor < 0.5);\n    updateElement('debug-cosine', `cosine: ${v.cosine.toFixed(4)}`);\n    updateElement('debug-adjusted-cosine', `adjustedCosine: ${v.adjustedCosine.toFixed(4)}`);\n    updateElement('debug-scaling-constant', `scalingConstant: ${v.scalingConstant.toFixed(4)}`);\n    updateElement('debug-raw-score', `RAW SCORE: ${v.rawScore.toFixed(1)}%`, v.rawScore === 0);\n  }\n\n  /**\n   * Update live display (HealthGauge)\n   *\n   * MULTICLASS: Shows detected state label (e.g., \"Baseline\", \"Unwucht\", etc.)\n   * UX FIX: Hide detected state if score < 70% to avoid confusing display\n   */\n  private updateLiveDisplay(score: number, status: string, detectedState?: string): void {\n    if (this.healthGauge) {\n      this.healthGauge.draw(score, status);\n    }\n\n    // Update score display if visible in modal\n    const scoreElement = document.getElementById('live-health-score');\n    if (scoreElement) {\n      // Only update the numeric value (% symbol is in HTML)\n      const scoreValue = score.toFixed(1);\n      const unitSpan = scoreElement.querySelector('.live-score-unit');\n      if (unitSpan) {\n        scoreElement.childNodes[0].textContent = scoreValue;\n      } else {\n        scoreElement.textContent = `${scoreValue}%`;\n      }\n    }\n\n    // Update the score display container with color class based on score\n    const scoreDisplay = document.getElementById('live-score-display');\n    if (scoreDisplay) {\n      // Remove existing score color classes\n      scoreDisplay.classList.remove('score-healthy', 'score-uncertain', 'score-faulty');\n\n      // Add appropriate color class based on score thresholds\n      if (score >= 75) {\n        scoreDisplay.classList.add('score-healthy');\n      } else if (score >= 50) {\n        scoreDisplay.classList.add('score-uncertain');\n      } else {\n        scoreDisplay.classList.add('score-faulty');\n      }\n    }\n\n    const statusElement = document.getElementById('live-status');\n    if (statusElement) {\n      // UX FIX: Only show detected state if score meets confident match threshold\n      // Below threshold the match is uncertain, showing the label would be confusing\n      const shouldShowState = score >= MIN_CONFIDENT_MATCH_SCORE && detectedState && detectedState !== 'UNKNOWN';\n\n      if (shouldShowState) {\n        statusElement.textContent = `${status} | ${detectedState}`;\n      } else {\n        statusElement.textContent = status;\n      }\n      statusElement.className = `live-status status-${status.toLowerCase()}`;\n    }\n  }\n\n  /**\n   * Stop recording and save final result\n   */\n  private stopRecording(): void {\n    // CRITICAL FIX: Prevent duplicate calls (e.g., user clicking Stop button twice)\n    // This prevents saving the same diagnosis multiple times\n    if (this.isSaving) {\n      logger.warn(' Stop already in progress, ignoring duplicate call');\n      return;\n    }\n\n    this.isSaving = true;\n    logger.info(' Stopping diagnosis...');\n\n    // CRITICAL FIX: Save ALL values BEFORE cleanup (cleanup resets them!)\n    const hadValidMeasurement = this.hasValidMeasurement;\n    const finalScore = this.lastProcessedScore;\n    const finalStatus = this.lastProcessedStatus;\n    const scoreHistoryCopy = this.scoreHistory.getAllScores().slice(); // Copy array\n    // CRITICAL FIX: Use majority voting for final label instead of last chunk\n    const finalDetectedState = this.labelHistory.getMajorityLabel();\n    const labelHistoryCopy = this.labelHistory.getAllLabels().slice(); // Copy for debugging\n\n    logger.info(\n      ` Majority voting: ${finalDetectedState} (from ${labelHistoryCopy.length} chunks: ${labelHistoryCopy.slice(-5).join(', ')})`\n    );\n\n    // Cleanup resources\n    this.cleanup();\n\n    // Save final diagnosis ONLY if we have valid measurement data\n    if (hadValidMeasurement) {\n      this.saveFinalDiagnosis(finalScore, finalStatus, finalDetectedState, scoreHistoryCopy);\n    } else {\n      logger.warn(' No valid measurement data - skipping save');\n      this.hideRecordingModal();\n    }\n  }\n\n  /**\n   * Save final diagnosis result\n   *\n   * MULTICLASS: Includes detected state in metadata\n   *\n   * CRITICAL FIX: Accepts values as parameters (saved before cleanup)\n   *\n   * @param finalScore - Health score before cleanup\n   * @param finalStatus - Health status before cleanup\n   * @param detectedState - Detected state before cleanup\n   * @param scoreHistory - Score history array before cleanup\n   */\n  private async saveFinalDiagnosis(\n    finalScore: number,\n    finalStatus: 'healthy' | 'uncertain' | 'faulty' | 'UNKNOWN',\n    detectedState: string,\n    scoreHistory: number[]\n  ): Promise<void> {\n    try {\n      // Validate machine data\n      if (!this.machine || !this.machine.id) {\n        throw new Error('Machine data is invalid or missing');\n      }\n\n      if (!this.machine.referenceModels || this.machine.referenceModels.length === 0) {\n        throw new Error('No reference models available');\n      }\n\n      // Use the passed values (saved before cleanup)\n\n      // Get classification details\n      const classification = getClassificationDetails(finalScore);\n\n      // UX FIX: Hide detected state if score below confident match threshold\n      const effectiveDetectedState = finalScore >= MIN_CONFIDENT_MATCH_SCORE ? detectedState : 'UNKNOWN';\n\n      // MULTICLASS: Generate hint based on detected state\n      let hint = classification.recommendation;\n      if (effectiveDetectedState !== 'UNKNOWN') {\n        if (finalStatus === 'healthy') {\n          hint = `Maschine luft im Normalzustand \"${effectiveDetectedState}\" (${finalScore.toFixed(1)}%). Keine Anomalien erkannt.`;\n        } else if (finalStatus === 'faulty') {\n          hint = `Fehlerzustand erkannt: \"${effectiveDetectedState}\" (${finalScore.toFixed(1)}%). Sofortige Inspektion empfohlen.`;\n        }\n      }\n\n      // Create diagnosis result\n      // CRITICAL FIX: Add random suffix to prevent ID collisions\n      // If multiple diagnoses are saved in the same millisecond, they would collide\n      // without a random suffix (e.g., rapid automated testing or high-frequency monitoring)\n      const randomSuffix = Math.random().toString(36).substring(2, 9);\n\n      // CRITICAL FIX: Ensure status is valid for DiagnosisResult (never 'UNKNOWN')\n      // If finalStatus is somehow still 'UNKNOWN', default to 'uncertain'\n      const validStatus: 'healthy' | 'uncertain' | 'faulty' =\n        finalStatus === 'UNKNOWN' ? 'uncertain' : finalStatus;\n\n      const diagnosis: DiagnosisResult = {\n        id: `diag-${Date.now()}-${randomSuffix}`,\n        machineId: this.machine.id,\n        timestamp: Date.now(),\n        healthScore: finalScore,\n        status: validStatus,\n        confidence: classification.confidence,\n        rawCosineSimilarity: 0, // Not stored for real-time\n        metadata: {\n          processingMode: 'real-time',\n          totalScores: scoreHistory.length,\n          scoreHistory: scoreHistory.slice(-10), // Use passed scoreHistory (saved before cleanup)\n          detectedState: effectiveDetectedState, // MULTICLASS: Store detected state (UNKNOWN if score < 70%)\n          multiclassMode: true,\n          evaluatedModels: this.activeModels.length,\n        },\n        analysis: {\n          hint,\n        },\n      };\n\n      logger.info(\n        ` Saving final diagnosis: ${finalScore.toFixed(1)}% | State: ${detectedState} (${finalStatus})`\n      );\n\n      // Save to database\n      await saveDiagnosis(diagnosis);\n\n      // Hide modal\n      this.hideRecordingModal();\n\n      // Show results\n      this.showResults(diagnosis);\n\n      logger.info(' Diagnosis saved successfully!');\n    } catch (error) {\n      logger.error('Save error:', error);\n      notify.error('Diagnose konnte nicht gespeichert werden', error as Error, {\n        title: 'Speicherfehler',\n        duration: 0,\n      });\n      this.hideRecordingModal();\n    } finally {\n      // CRITICAL FIX: Reset flag after save completes (success or error)\n      // This allows future diagnoses to be saved\n      this.isSaving = false;\n    }\n  }\n\n  /**\n   * Show recording modal\n   */\n  private showRecordingModal(): void {\n    const modal = document.getElementById('recording-modal');\n    if (modal) {\n      modal.style.display = 'flex';\n    }\n\n    // CRITICAL FIX: Update machine name in modal subtitle\n    // This was showing hardcoded \"MACHINE 002\" from index.html instead of selected machine\n    const machineIdElement = document.getElementById('machine-id');\n    if (machineIdElement) {\n      machineIdElement.textContent = this.machine.name;\n      logger.debug(' Modal machine name updated:', this.machine.name);\n    }\n\n    // Update button text and behavior\n    const stopBtn = document.getElementById('stop-recording-btn');\n    if (stopBtn) {\n      stopBtn.textContent = BUTTON_TEXT.STOP_DIAGNOSE;\n      stopBtn.onclick = () => this.stopRecording();\n    }\n\n    // Update modal title\n    const modalTitle = document.querySelector('#recording-modal .modal-header h3');\n    if (modalTitle) {\n      modalTitle.textContent = MODAL_TITLE.RECORDING_DIAGNOSE;\n    }\n\n    // Add Smart Start status and live score display\n    const modalBody = document.querySelector('#recording-modal .modal-body');\n    // CRITICAL FIX: Check within modal only to prevent conflicts with other UI elements\n    if (modalBody && modal && !modal.querySelector('.live-display')) {\n      // Get reference model info for display\n      const refModelInfo = this.activeModels.length > 0\n        ? this.activeModels.map(m => {\n            const trainingDate = new Date(m.trainingDate).toLocaleString('de-DE', {\n              day: '2-digit',\n              month: '2-digit',\n              year: 'numeric',\n              hour: '2-digit',\n              minute: '2-digit'\n            });\n            return `${m.label} (${trainingDate})`;\n          }).join(', ')\n        : 'Keine Modelle geladen';\n\n      const liveDisplay = document.createElement('div');\n      liveDisplay.className = 'live-display';\n      liveDisplay.innerHTML = `\n        <div id=\"smart-start-status\" class=\"smart-start-status\">Initialisierung...</div>\n        <div class=\"reference-model-info\" style=\"background: rgba(0, 212, 255, 0.1); border-left: 3px solid var(--primary-color); padding: 8px 12px; margin: 12px 0; border-radius: 4px;\">\n          <div style=\"font-size: 0.75rem; color: var(--text-muted); margin-bottom: 4px;\">REFERENZMODELL(E):</div>\n          <div style=\"font-size: 0.85rem; color: var(--text-primary); font-weight: 500;\">${refModelInfo}</div>\n          <div style=\"font-size: 0.7rem; color: var(--text-muted); margin-top: 4px;\">${this.activeModels.length} Zustand(e) trainiert</div>\n        </div>\n        <div class=\"debug-info\" data-view-level=\"expert\" style=\"background: rgba(255, 136, 0, 0.1); border-left: 3px solid #ff8800; padding: 8px 12px; margin: 12px 0; border-radius: 4px; font-family: monospace; font-size: 0.75rem;\">\n          <div style=\"color: var(--text-muted); margin-bottom: 4px; font-weight: 600;\"> DEBUG VALUES:</div>\n          <div id=\"debug-weight-magnitude\" style=\"color: var(--text-primary);\">weightMagnitude: --</div>\n          <div id=\"debug-feature-magnitude\" style=\"color: var(--text-primary);\">featureMagnitude: --</div>\n          <div id=\"debug-magnitude-factor\" style=\"color: var(--text-primary);\">magnitudeFactor: --</div>\n          <div id=\"debug-cosine\" style=\"color: var(--text-primary);\">cosine: --</div>\n          <div id=\"debug-adjusted-cosine\" style=\"color: var(--text-primary);\">adjustedCosine: --</div>\n          <div id=\"debug-scaling-constant\" style=\"color: var(--text-primary);\">scalingConstant: --</div>\n          <div id=\"debug-raw-score\" style=\"color: var(--text-primary); font-weight: 600; margin-top: 4px;\">RAW SCORE: --</div>\n        </div>\n        <div class=\"live-score-container\">\n          <p class=\"live-hint\">Telefon nher an die Maschine halten fr optimales Signal</p>\n          <div id=\"live-score-display\" class=\"live-score-display is-active\">\n            <div class=\"live-score-ring\"></div>\n            <p class=\"live-score-label\">bereinstimmung</p>\n            <p id=\"live-health-score\" class=\"live-score\">--<span class=\"live-score-unit\">%</span></p>\n          </div>\n          <p id=\"live-status\" class=\"live-status\">ANALYSIERE...</p>\n        </div>\n      `;\n      modalBody.appendChild(liveDisplay);\n    }\n\n    // VISUAL POSITIONING: Add ghost overlay if camera and reference image are available\n    if (this.cameraStream && this.machine.referenceImage && modalBody) {\n      // Create container for ghost overlay\n      const ghostContainer = document.createElement('div');\n      ghostContainer.id = 'ghost-overlay-container';\n      ghostContainer.className = 'ghost-overlay-container';\n      ghostContainer.style.cssText = `\n        position: relative;\n        width: 100%;\n        max-width: 300px;\n        margin: 12px auto;\n        border-radius: 8px;\n        overflow: hidden;\n        border: 2px solid var(--primary-color);\n      `;\n\n      // Create video element (live feed)\n      const video = document.createElement('video');\n      video.id = 'diagnosis-video';\n      video.autoplay = true;\n      video.playsInline = true;\n      video.muted = true;\n      video.style.cssText = `\n        width: 100%;\n        height: auto;\n        display: block;\n      `;\n      video.srcObject = this.cameraStream;\n\n      // Create ghost image overlay (reference image)\n      const ghostImage = document.createElement('img');\n      ghostImage.id = 'ghost-overlay-image';\n      ghostImage.className = 'ghost-overlay-image';\n      ghostImage.style.cssText = `\n        position: absolute;\n        top: 0;\n        left: 0;\n        width: 100%;\n        height: 100%;\n        object-fit: cover;\n        opacity: 0.4;\n        pointer-events: none;\n        z-index: 10;\n      `;\n\n      // Convert Blob to URL for image src\n      const imageUrl = URL.createObjectURL(this.machine.referenceImage);\n      ghostImage.src = imageUrl;\n\n      // Add hint text\n      const hint = document.createElement('p');\n      hint.className = 'ghost-overlay-hint';\n      hint.style.cssText = `\n        font-size: 0.75rem;\n        color: var(--text-muted);\n        text-align: center;\n        margin-top: 8px;\n      `;\n      hint.textContent = ' Bewegen Sie das Handy, bis Live-Bild und Referenzbild bereinstimmen';\n\n      // Assemble elements\n      ghostContainer.appendChild(video);\n      ghostContainer.appendChild(ghostImage);\n\n      // Insert at top of modal body\n      modalBody.insertBefore(ghostContainer, modalBody.firstChild);\n      modalBody.insertBefore(hint, ghostContainer.nextSibling);\n\n      logger.info(' Ghost overlay added to diagnosis modal');\n    }\n  }\n\n  /**\n   * Hide recording modal\n   */\n  private hideRecordingModal(): void {\n    const modal = document.getElementById('recording-modal');\n    if (modal) {\n      modal.style.display = 'none';\n\n      // CRITICAL FIX: Clean up live display within modal only\n      // Note: .reference-model-info is inside .live-display, so removing\n      // .live-display automatically removes .reference-model-info as well\n      const liveDisplay = modal.querySelector('.live-display');\n      if (liveDisplay) {\n        liveDisplay.remove();\n      }\n\n      // VISUAL POSITIONING: Clean up ghost overlay elements\n      const ghostContainer = modal.querySelector('#ghost-overlay-container');\n      if (ghostContainer) {\n        // Revoke blob URL to prevent memory leaks\n        const ghostImage = ghostContainer.querySelector('#ghost-overlay-image') as HTMLImageElement | null;\n        if (ghostImage && ghostImage.src) {\n          URL.revokeObjectURL(ghostImage.src);\n        }\n        ghostContainer.remove();\n      }\n      const ghostHint = modal.querySelector('.ghost-overlay-hint');\n      if (ghostHint) {\n        ghostHint.remove();\n      }\n    }\n  }\n\n  /**\n   * Show diagnosis results\n   */\n  private showResults(diagnosis: DiagnosisResult): void {\n    const modal = document.getElementById('diagnosis-modal');\n    if (!modal) return;\n\n    // Update machine info\n    const machineBarcode = document.getElementById('machine-barcode');\n    if (machineBarcode) {\n      machineBarcode.textContent = this.machine.name;\n    }\n\n    // Draw final health gauge\n    const gaugeCanvas = document.getElementById('health-gauge-canvas');\n    if (gaugeCanvas) {\n      if (this.healthGauge) {\n        this.healthGauge.destroy();\n      }\n      this.healthGauge = new HealthGauge('health-gauge-canvas');\n      this.healthGauge.draw(diagnosis.healthScore, diagnosis.status);\n    }\n\n    // Update status\n    const resultStatus = document.getElementById('result-status');\n    if (resultStatus) {\n      // MULTICLASS: Show detected state if available\n      const detectedState = diagnosis.metadata?.detectedState;\n      if (detectedState && detectedState !== 'UNKNOWN') {\n        resultStatus.textContent = `${diagnosis.status} | ${detectedState}`;\n      } else {\n        resultStatus.textContent = diagnosis.status;\n      }\n      resultStatus.className = `result-status status-${diagnosis.status.toLowerCase()}`;\n    }\n\n    // Update confidence\n    const resultConfidence = document.getElementById('result-confidence');\n    if (resultConfidence) {\n      resultConfidence.textContent = diagnosis.confidence.toFixed(1);\n    }\n\n    // Update analysis hint\n    const analysisHint = document.getElementById('analysis-hint');\n    if (analysisHint) {\n      // MULTICLASS: Use diagnosis.analysis.hint if available (contains detected state info)\n      if (diagnosis.analysis?.hint) {\n        analysisHint.textContent = diagnosis.analysis.hint;\n      } else {\n        // Fallback to old method\n        const classification = getClassificationDetails(diagnosis.healthScore);\n        analysisHint.textContent = classification.recommendation;\n      }\n    }\n\n    // Show modal\n    modal.style.display = 'flex';\n\n    // Setup close button\n    const closeBtn = document.getElementById('close-diagnosis-modal');\n    if (closeBtn) {\n      closeBtn.onclick = () => {\n        modal.style.display = 'none';\n      };\n    }\n  }\n\n  private applyAppShellLayout(): void {\n    const modal = document.getElementById('diagnosis-modal');\n    if (!modal) return;\n\n    const modalContent = modal.querySelector('.modal-content');\n    if (!modalContent) return;\n\n    modalContent.classList.add('app-shell-container');\n    modalContent.querySelector('.modal-header')?.classList.add('shell-header');\n    modalContent.querySelector('.modal-body')?.classList.add('shell-content');\n    modalContent.querySelector('.modal-actions')?.classList.add('shell-footer');\n  }\n\n  /**\n   * Destroy phase and cleanup all resources\n   */\n  public destroy(): void {\n    this.cleanup();\n\n    // CRITICAL FIX: Remove event listener to prevent stacking on re-init\n    if (this.diagnoseButtonClickHandler) {\n      const diagnoseBtn = document.getElementById('diagnose-btn');\n      if (diagnoseBtn) {\n        diagnoseBtn.removeEventListener('click', this.diagnoseButtonClickHandler);\n      }\n      this.diagnoseButtonClickHandler = null;\n    }\n\n    // Destroy visualizer\n    if (this.visualizer) {\n      this.visualizer.destroy();\n      this.visualizer = null;\n    }\n\n    // Cleanup health gauge instance to prevent leaks\n    if (this.healthGauge) {\n      this.healthGauge.destroy();\n      this.healthGauge = null;\n    }\n\n    // Clear score history\n    this.scoreHistory.clear();\n    this.labelHistory.clear(); // CRITICAL FIX: Clear label history\n  }\n}\n","/**\n * ZANOBOT - Detection Mode Router (Strategy Pattern)\n *\n * Enables clean switching between Level 1 (GMIA) and Level 2 (YAMNet) modes.\n * Implements Strategy Pattern for mode-agnostic detection interface.\n *\n * IMPORTANT: This file bridges Level 1 and Level 2 without modifying either!\n */\n\nimport type { DetectionMode } from './ml/level2/types.js';\n\n/**\n * Detection result interface (unified for both modes)\n */\nexport interface DetectionResult {\n  score: number; // Health score (0-100)\n  status: 'healthy' | 'warning' | 'critical' | 'uncertain' | 'faulty';\n  confidence: number; // Confidence level (0-100)\n  message: string; // Human-readable status message\n  mode: DetectionMode; // Which detection mode was used\n  timestamp: number;\n  metadata?: Record<string, unknown>;\n}\n\n/**\n * Detection Strategy Interface\n * Both Level 1 and Level 2 can implement this interface\n */\nexport interface DetectionStrategy {\n  mode: DetectionMode;\n  isReady(): boolean;\n  initialize(): Promise<void>;\n  hasReference(): boolean;\n  createReference(audioBuffer: AudioBuffer, machineId: string, label?: string): Promise<void>;\n  analyze(audioBuffer: AudioBuffer): Promise<DetectionResult>;\n  loadReference(machineId: string): Promise<boolean>;\n  dispose(): void;\n}\n\n/**\n * Storage key for detection mode preference\n */\nconst DETECTION_MODE_KEY = 'zanobo-detection-mode';\n\n/**\n * Get current detection mode from storage\n */\nexport function getDetectionMode(): DetectionMode {\n  try {\n    const stored = localStorage.getItem(DETECTION_MODE_KEY);\n    if (stored === 'STATIONARY' || stored === 'CYCLIC') {\n      return stored;\n    }\n  } catch {\n    // localStorage not available\n  }\n  return 'STATIONARY'; // Default to Level 1 (GMIA)\n}\n\n/**\n * Save detection mode to storage\n */\nexport function setDetectionMode(mode: DetectionMode): void {\n  try {\n    localStorage.setItem(DETECTION_MODE_KEY, mode);\n  } catch {\n    // localStorage not available\n  }\n}\n\n/**\n * Detection Mode Configuration\n */\nexport interface DetectionModeConfig {\n  mode: DetectionMode;\n  name: string;\n  description: string;\n  icon: string;\n  features: string[];\n}\n\n/**\n * Available detection modes with descriptions\n */\nexport const DETECTION_MODES: Record<DetectionMode, DetectionModeConfig> = {\n  STATIONARY: {\n    mode: 'STATIONARY',\n    name: 'Level 1: Stationre Gerusche (GMIA)',\n    description: 'Fr kontinuierlich laufende Maschinen wie Ventilatoren, Pumpen, Kompressoren',\n    icon: '',\n    features: [\n      'Frequenzanalyse mit FFT',\n      'Gaussian Model fr statistische Erkennung',\n      'Schnelle lokale Verarbeitung',\n      'Keine ML-Bibliothek erforderlich',\n    ],\n  },\n  CYCLIC: {\n    mode: 'CYCLIC',\n    name: 'Level 2: Zyklische Gerusche (ML)',\n    description:\n      'Fr Maschinen mit wiederkehrenden Ablufen wie Verpackungsmaschinen, Montagelinien',\n    icon: '',\n    features: [\n      'YAMNet Deep Learning Model',\n      'Referenzlauf-Vergleich',\n      'Mel-Spektrogramm Visualisierung',\n      'WebGPU-beschleunigte Inferenz',\n    ],\n  },\n};\n\n/**\n * Check if Level 2 is available (TensorFlow.js loaded)\n */\nexport async function isLevel2Available(): Promise<boolean> {\n  try {\n    // Dynamic import to check availability\n    await import('@tensorflow/tfjs');\n    return true;\n  } catch {\n    return false;\n  }\n}\n\n/**\n * Mode Change Event\n */\nexport type ModeChangeCallback = (newMode: DetectionMode, oldMode: DetectionMode) => void;\n\n/**\n * Detection Mode Manager\n *\n * Manages mode switching and notifies listeners\n */\nexport class DetectionModeManager {\n  private currentMode: DetectionMode;\n  private listeners: Set<ModeChangeCallback> = new Set();\n\n  constructor() {\n    this.currentMode = getDetectionMode();\n  }\n\n  /**\n   * Get current detection mode\n   */\n  getMode(): DetectionMode {\n    return this.currentMode;\n  }\n\n  /**\n   * Set detection mode\n   */\n  setMode(mode: DetectionMode): void {\n    if (mode === this.currentMode) return;\n\n    const oldMode = this.currentMode;\n    this.currentMode = mode;\n    setDetectionMode(mode);\n\n    // Notify listeners\n    this.listeners.forEach((callback) => {\n      try {\n        callback(mode, oldMode);\n      } catch (error) {\n        console.error('Mode change listener error:', error);\n      }\n    });\n  }\n\n  /**\n   * Toggle between modes\n   */\n  toggleMode(): DetectionMode {\n    const newMode = this.currentMode === 'STATIONARY' ? 'CYCLIC' : 'STATIONARY';\n    this.setMode(newMode);\n    return newMode;\n  }\n\n  /**\n   * Subscribe to mode changes\n   */\n  onModeChange(callback: ModeChangeCallback): () => void {\n    this.listeners.add(callback);\n    return () => this.listeners.delete(callback);\n  }\n\n  /**\n   * Get mode configuration\n   */\n  getModeConfig(): DetectionModeConfig {\n    return DETECTION_MODES[this.currentMode];\n  }\n\n  /**\n   * Check if current mode is Level 2\n   */\n  isLevel2(): boolean {\n    return this.currentMode === 'CYCLIC';\n  }\n\n  /**\n   * Check if current mode is Level 1\n   */\n  isLevel1(): boolean {\n    return this.currentMode === 'STATIONARY';\n  }\n}\n\n/**\n * Singleton instance\n */\nlet modeManagerInstance: DetectionModeManager | null = null;\n\n/**\n * Get the global DetectionModeManager instance\n */\nexport function getDetectionModeManager(): DetectionModeManager {\n  if (!modeManagerInstance) {\n    modeManagerInstance = new DetectionModeManager();\n  }\n  return modeManagerInstance;\n}\n","/**\n * ZANOBOT - Mode Selector Component\n *\n * UI component for switching between Level 1 (GMIA) and Level 2 (ML) modes.\n * Can be integrated into the Settings page or shown as a modal.\n */\n\nimport {\n  getDetectionModeManager,\n  DETECTION_MODES,\n  type DetectionModeConfig,\n} from '@core/detection-mode.js';\nimport type { DetectionMode } from '@data/types.js';\nimport { notify } from '@utils/notifications.js';\nimport { logger } from '@utils/logger.js';\n\n/**\n * Mode Selector Component\n *\n * Renders a toggle/card selection for choosing detection mode.\n */\nexport class ModeSelector {\n  private container: HTMLElement | null = null;\n  private modeManager = getDetectionModeManager();\n  private onChange?: (mode: DetectionMode) => void;\n\n  constructor() {\n    // Subscribe to mode changes\n    this.modeManager.onModeChange((newMode, oldMode) => {\n      logger.info(`Mode changed: ${oldMode}  ${newMode}`);\n      this.updateUI();\n    });\n  }\n\n  /**\n   * Render the component\n   */\n  render(containerId: string): void {\n    this.container = document.getElementById(containerId);\n    if (!this.container) {\n      logger.error(`Container not found: ${containerId}`);\n      return;\n    }\n\n    this.container.innerHTML = this.getTemplate();\n    this.attachEventListeners();\n    this.updateUI();\n  }\n\n  /**\n   * Get HTML template\n   */\n  private getTemplate(): string {\n    const currentMode = this.modeManager.getMode();\n\n    return `\n      <div class=\"mode-selector-component\">\n        <h3 class=\"mode-selector-title\"> Analysemodus</h3>\n        <p class=\"mode-selector-description\">\n          Whlen Sie den passenden Modus fr Ihre Maschine\n        </p>\n\n        <div class=\"mode-cards\">\n          ${this.renderModeCard(DETECTION_MODES.STATIONARY, currentMode === 'STATIONARY')}\n          ${this.renderModeCard(DETECTION_MODES.CYCLIC, currentMode === 'CYCLIC')}\n        </div>\n\n        <div class=\"mode-info\" id=\"mode-info\">\n          ${this.renderModeInfo(DETECTION_MODES[currentMode])}\n        </div>\n      </div>\n    `;\n  }\n\n  /**\n   * Render a mode card\n   */\n  private renderModeCard(config: DetectionModeConfig, isSelected: boolean): string {\n    return `\n      <label class=\"mode-card ${isSelected ? 'selected' : ''}\" data-mode=\"${config.mode}\">\n        <input\n          type=\"radio\"\n          name=\"detection-mode\"\n          value=\"${config.mode}\"\n          ${isSelected ? 'checked' : ''}\n        >\n        <div class=\"mode-card-icon\">${config.icon}</div>\n        <div class=\"mode-card-content\">\n          <strong class=\"mode-card-name\">${config.name}</strong>\n          <span class=\"mode-card-description\">${config.description}</span>\n        </div>\n        <div class=\"mode-card-check\">\n          ${isSelected ? '' : ''}\n        </div>\n      </label>\n    `;\n  }\n\n  /**\n   * Render mode info/features\n   */\n  private renderModeInfo(config: DetectionModeConfig): string {\n    return `\n      <div class=\"mode-features\">\n        <h4>${config.icon} Funktionen von ${config.mode === 'STATIONARY' ? 'Level 1' : 'Level 2'}:</h4>\n        <ul>\n          ${config.features.map((f) => `<li> ${f}</li>`).join('')}\n        </ul>\n      </div>\n    `;\n  }\n\n  /**\n   * Attach event listeners\n   */\n  private attachEventListeners(): void {\n    const radios = this.container?.querySelectorAll('input[name=\"detection-mode\"]');\n\n    radios?.forEach((radio) => {\n      radio.addEventListener('change', (e) => {\n        const target = e.target as HTMLInputElement;\n        const mode = target.value as DetectionMode;\n        this.selectMode(mode);\n      });\n    });\n\n    // Also handle card clicks\n    const cards = this.container?.querySelectorAll('.mode-card');\n    cards?.forEach((card) => {\n      card.addEventListener('click', () => {\n        const mode = card.getAttribute('data-mode') as DetectionMode;\n        const radio = card.querySelector('input') as HTMLInputElement;\n        if (radio && !radio.checked) {\n          radio.checked = true;\n          this.selectMode(mode);\n        }\n      });\n    });\n  }\n\n  /**\n   * Select a mode\n   */\n  private selectMode(mode: DetectionMode): void {\n    const oldMode = this.modeManager.getMode();\n    if (mode === oldMode) return;\n\n    this.modeManager.setMode(mode);\n\n    // Show notification\n    const config = DETECTION_MODES[mode];\n    notify.success(`Modus gendert: ${config.name}`);\n\n    // Trigger callback\n    this.onChange?.(mode);\n  }\n\n  /**\n   * Update UI to reflect current mode\n   */\n  private updateUI(): void {\n    if (!this.container) return;\n\n    const currentMode = this.modeManager.getMode();\n\n    // Update cards\n    const cards = this.container.querySelectorAll('.mode-card');\n    cards.forEach((card) => {\n      const mode = card.getAttribute('data-mode');\n      const isSelected = mode === currentMode;\n\n      card.classList.toggle('selected', isSelected);\n\n      const check = card.querySelector('.mode-card-check');\n      if (check) check.textContent = isSelected ? '' : '';\n\n      const radio = card.querySelector('input') as HTMLInputElement;\n      if (radio) radio.checked = isSelected;\n    });\n\n    // Update info\n    const infoElement = this.container.querySelector('#mode-info');\n    if (infoElement) {\n      infoElement.innerHTML = this.renderModeInfo(DETECTION_MODES[currentMode]);\n    }\n  }\n\n  /**\n   * Get current mode\n   */\n  getCurrentMode(): DetectionMode {\n    return this.modeManager.getMode();\n  }\n\n  /**\n   * Set change callback\n   */\n  setOnChange(callback: (mode: DetectionMode) => void): void {\n    this.onChange = callback;\n  }\n\n  /**\n   * Cleanup\n   */\n  destroy(): void {\n    this.container = null;\n  }\n}\n\n/**\n * Get singleton mode selector styles\n * Call this once to inject styles into the document\n */\nexport function injectModeSelectorStyles(): void {\n  if (document.getElementById('mode-selector-styles')) return;\n\n  const style = document.createElement('style');\n  style.id = 'mode-selector-styles';\n  style.textContent = `\n    .mode-selector-component {\n      padding: 16px;\n    }\n\n    .mode-selector-title {\n      font-size: 18px;\n      font-weight: 600;\n      margin-bottom: 8px;\n      color: var(--text-primary, #1a2332);\n    }\n\n    .mode-selector-description {\n      font-size: 14px;\n      color: var(--text-secondary, #6b7280);\n      margin-bottom: 16px;\n    }\n\n    .mode-cards {\n      display: flex;\n      gap: 16px;\n      margin-bottom: 16px;\n    }\n\n    @media (max-width: 600px) {\n      .mode-cards {\n        flex-direction: column;\n      }\n    }\n\n    .mode-card {\n      flex: 1;\n      display: flex;\n      flex-direction: column;\n      align-items: center;\n      padding: 20px;\n      border: 2px solid var(--border-color, #e5e7eb);\n      border-radius: 12px;\n      cursor: pointer;\n      transition: all 0.2s ease;\n      background: var(--bg-secondary, #ffffff);\n      position: relative;\n    }\n\n    .mode-card:hover {\n      border-color: var(--accent-color, #00d4ff);\n      transform: translateY(-2px);\n      box-shadow: 0 4px 12px rgba(0, 212, 255, 0.2);\n    }\n\n    .mode-card.selected {\n      border-color: var(--accent-color, #00d4ff);\n      background: rgba(0, 212, 255, 0.1);\n    }\n\n    .mode-card input {\n      position: absolute;\n      opacity: 0;\n      pointer-events: none;\n    }\n\n    .mode-card-icon {\n      font-size: 48px;\n      margin-bottom: 12px;\n    }\n\n    .mode-card-content {\n      text-align: center;\n    }\n\n    .mode-card-name {\n      display: block;\n      font-size: 14px;\n      font-weight: 600;\n      color: var(--text-primary, #1a2332);\n      margin-bottom: 4px;\n    }\n\n    .mode-card-description {\n      display: block;\n      font-size: 12px;\n      color: var(--text-secondary, #6b7280);\n      line-height: 1.4;\n    }\n\n    .mode-card-check {\n      position: absolute;\n      top: 12px;\n      right: 12px;\n      width: 24px;\n      height: 24px;\n      border-radius: 50%;\n      background: var(--accent-color, #00d4ff);\n      color: white;\n      display: flex;\n      align-items: center;\n      justify-content: center;\n      font-size: 14px;\n      font-weight: bold;\n    }\n\n    .mode-info {\n      background: var(--bg-tertiary, #f3f4f6);\n      border-radius: 8px;\n      padding: 16px;\n    }\n\n    .mode-features h4 {\n      font-size: 14px;\n      font-weight: 600;\n      margin-bottom: 8px;\n      color: var(--text-primary, #1a2332);\n    }\n\n    .mode-features ul {\n      list-style: none;\n      padding: 0;\n      margin: 0;\n    }\n\n    .mode-features li {\n      font-size: 13px;\n      color: var(--text-secondary, #6b7280);\n      padding: 4px 0;\n    }\n\n    /* Level 2 specific styles */\n    .level2-reference-phase,\n    .level2-diagnose-phase {\n      padding: 20px;\n    }\n\n    .phase-header {\n      margin-bottom: 24px;\n    }\n\n    .phase-header h2 {\n      font-size: 24px;\n      margin-bottom: 8px;\n    }\n\n    .phase-description {\n      color: var(--text-secondary, #6b7280);\n    }\n\n    .machine-info {\n      background: var(--bg-tertiary, #f3f4f6);\n      padding: 12px 16px;\n      border-radius: 8px;\n      margin-bottom: 20px;\n    }\n\n    .machine-label {\n      font-size: 12px;\n      color: var(--text-secondary, #6b7280);\n    }\n\n    .machine-name {\n      font-weight: 600;\n      margin-left: 8px;\n    }\n\n    .recording-status,\n    .diagnosis-status {\n      display: flex;\n      align-items: center;\n      gap: 12px;\n      padding: 16px;\n      background: var(--bg-secondary, #ffffff);\n      border-radius: 12px;\n      margin-bottom: 20px;\n      border: 1px solid var(--border-color, #e5e7eb);\n    }\n\n    .status-icon {\n      font-size: 32px;\n    }\n\n    .status-text {\n      font-size: 16px;\n      color: var(--text-primary, #1a2332);\n    }\n\n    .progress-container {\n      margin-bottom: 20px;\n    }\n\n    .progress-bar {\n      height: 8px;\n      background: var(--bg-tertiary, #e5e7eb);\n      border-radius: 4px;\n      overflow: hidden;\n      margin-bottom: 8px;\n    }\n\n    .progress-fill {\n      height: 100%;\n      background: var(--accent-color, #00d4ff);\n      transition: width 0.3s ease;\n    }\n\n    .progress-text {\n      font-size: 12px;\n      color: var(--text-secondary, #6b7280);\n    }\n\n    .timer-display {\n      text-align: center;\n      padding: 20px;\n      background: var(--bg-tertiary, #f3f4f6);\n      border-radius: 12px;\n      margin-bottom: 20px;\n    }\n\n    .timer-value {\n      font-size: 48px;\n      font-weight: bold;\n      color: var(--accent-color, #00d4ff);\n    }\n\n    .timer-unit {\n      display: block;\n      font-size: 14px;\n      color: var(--text-secondary, #6b7280);\n    }\n\n    .action-buttons {\n      display: flex;\n      gap: 12px;\n      margin-bottom: 20px;\n    }\n\n    .btn-large {\n      padding: 16px 32px;\n      font-size: 16px;\n    }\n\n    .info-box {\n      background: rgba(0, 212, 255, 0.1);\n      border: 1px solid rgba(0, 212, 255, 0.3);\n      border-radius: 8px;\n      padding: 16px;\n      margin-bottom: 20px;\n    }\n\n    .info-box h4 {\n      margin-bottom: 8px;\n      color: var(--text-primary, #1a2332);\n    }\n\n    .info-box ul {\n      margin: 0;\n      padding-left: 20px;\n    }\n\n    .info-box li {\n      font-size: 14px;\n      color: var(--text-secondary, #6b7280);\n      margin-bottom: 4px;\n    }\n\n    .backend-info {\n      text-align: center;\n      padding: 8px;\n      color: var(--text-secondary, #6b7280);\n    }\n\n    .similarity-container {\n      margin-bottom: 20px;\n    }\n\n    .similarity-label {\n      font-size: 14px;\n      color: var(--text-secondary, #6b7280);\n      margin-bottom: 8px;\n    }\n\n    .similarity-meter {\n      display: flex;\n      align-items: center;\n      gap: 12px;\n    }\n\n    .meter-bar {\n      flex: 1;\n      height: 24px;\n      background: var(--bg-tertiary, #e5e7eb);\n      border-radius: 12px;\n      overflow: hidden;\n    }\n\n    .meter-fill {\n      height: 100%;\n      border-radius: 12px;\n      transition: width 0.5s ease-out;\n    }\n\n    .meter-value {\n      font-size: 24px;\n      font-weight: bold;\n      min-width: 80px;\n      text-align: right;\n    }\n\n    .health-status {\n      margin-bottom: 20px;\n    }\n\n    .health-icon {\n      font-size: 48px;\n      margin-bottom: 8px;\n    }\n\n    .health-message {\n      font-size: 18px;\n      font-weight: 600;\n    }\n\n    .spectrogram-container {\n      margin-bottom: 20px;\n    }\n\n    .spectrogram-container h4 {\n      margin-bottom: 12px;\n    }\n\n    #spectrogram-canvas {\n      width: 100%;\n      max-width: 600px;\n      border: 1px solid var(--border-color, #e5e7eb);\n      border-radius: 8px;\n    }\n\n    .result-details {\n      background: var(--bg-secondary, #ffffff);\n      border: 1px solid var(--border-color, #e5e7eb);\n      border-radius: 12px;\n      padding: 16px;\n    }\n\n    .result-details h4 {\n      margin-bottom: 12px;\n    }\n\n    .details-grid {\n      display: grid;\n      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));\n      gap: 12px;\n    }\n\n    .detail-item {\n      display: flex;\n      flex-direction: column;\n    }\n\n    .detail-label {\n      font-size: 12px;\n      color: var(--text-secondary, #6b7280);\n    }\n\n    .detail-value {\n      font-size: 18px;\n      font-weight: 600;\n      color: var(--text-primary, #1a2332);\n    }\n  `;\n\n  document.head.appendChild(style);\n}\n","/**\n * ZANOBOT - PHASE 4: SETTINGS\n *\n * Application settings and data management.\n *\n * Features:\n * - Database backup (export to JSON)\n * - Database restore (import from JSON)\n * - Data statistics\n * - Clear all data\n */\n\nimport { exportData, importData, getDBStats, clearAllData } from '@data/db.js';\nimport { notify } from '@utils/notifications.js';\nimport { logger } from '@utils/logger.js';\nimport {\n  getVisualizerSettings,\n  setVisualizerSettings,\n} from '@utils/visualizerSettings.js';\nimport { ModeSelector, injectModeSelectorStyles } from '@ui/components/ModeSelector.js';\nimport { getDetectionModeManager } from '@core/detection-mode.js';\n\nexport class SettingsPhase {\n  private modeSelector: ModeSelector | null = null;\n  private unsubscribeModeChange?: () => void;\n\n  constructor() {}\n\n  /**\n   * Initialize the settings phase UI\n   */\n  public init(): void {\n    // Export database button\n    const exportBtn = document.getElementById('export-data-btn');\n    if (exportBtn) {\n      exportBtn.addEventListener('click', () => this.handleExportData());\n    }\n\n    // Import database button\n    const importBtn = document.getElementById('import-data-btn');\n    if (importBtn) {\n      importBtn.addEventListener('click', () => this.handleImportData());\n    }\n\n    // Clear all data button\n    const clearBtn = document.getElementById('clear-data-btn');\n    if (clearBtn) {\n      clearBtn.addEventListener('click', () => this.handleClearData());\n    }\n\n    // Show statistics button\n    const statsBtn = document.getElementById('show-stats-btn');\n    if (statsBtn) {\n      statsBtn.addEventListener('click', () => this.showStats());\n    }\n\n    this.initVisualizerScaleSettings();\n\n    // Initialize mode selector for analysis method selection\n    this.initModeSelector();\n\n    // Load stats on init\n    this.showStats();\n  }\n\n  /**\n   * Initialize the Mode Selector component for GIMA/YAMNet toggle\n   */\n  private initModeSelector(): void {\n    // Inject styles\n    injectModeSelectorStyles();\n\n    // Create and render the mode selector\n    this.modeSelector = new ModeSelector();\n    this.modeSelector.render('analysis-mode-selector');\n\n    // Subscribe to mode changes to update visibility of mode-dependent settings\n    const modeManager = getDetectionModeManager();\n    this.unsubscribeModeChange = modeManager.onModeChange((newMode) => {\n      this.updateModeVisibility(newMode);\n    });\n\n    // Set initial visibility based on current mode\n    this.updateModeVisibility(modeManager.getMode());\n\n    logger.info(' Mode selector initialized');\n  }\n\n  /**\n   * Update visibility of mode-dependent settings\n   */\n  private updateModeVisibility(mode: 'STATIONARY' | 'CYCLIC'): void {\n    // Update data-detection-mode attribute on body for CSS-based visibility\n    document.body.setAttribute('data-detection-mode', mode);\n\n    // Update info badges in the mode settings info section\n    const infoSection = document.getElementById('mode-settings-info');\n    if (infoSection) {\n      const badges = infoSection.querySelectorAll('[data-detection-mode]');\n      badges.forEach((badge) => {\n        const badgeMode = badge.getAttribute('data-detection-mode');\n        (badge as HTMLElement).style.display = badgeMode === mode ? 'flex' : 'none';\n      });\n    }\n\n    logger.debug(`Mode visibility updated: ${mode}`);\n  }\n\n  private initVisualizerScaleSettings(): void {\n    const freqToggle = document.getElementById(\n      'frequency-scale-toggle'\n    ) as HTMLInputElement | null;\n    const ampToggle = document.getElementById(\n      'amplitude-scale-toggle'\n    ) as HTMLInputElement | null;\n\n    if (!freqToggle && !ampToggle) {\n      return;\n    }\n\n    const settings = getVisualizerSettings();\n\n    if (freqToggle) {\n      freqToggle.checked = settings.frequencyScale === 'log';\n      freqToggle.addEventListener('change', () => {\n        setVisualizerSettings({\n          frequencyScale: freqToggle.checked ? 'log' : 'linear',\n        });\n      });\n    }\n\n    if (ampToggle) {\n      ampToggle.checked = settings.amplitudeScale === 'log';\n      ampToggle.addEventListener('change', () => {\n        setVisualizerSettings({\n          amplitudeScale: ampToggle.checked ? 'log' : 'linear',\n        });\n      });\n    }\n  }\n\n  /**\n   * Handle database export\n   */\n  private async handleExportData(): Promise<void> {\n    try {\n      logger.info(' Exporting database...');\n\n      // Get all data\n      const data = await exportData();\n\n      // Create JSON blob\n      const jsonString = JSON.stringify(data, null, 2);\n      const blob = new Blob([jsonString], { type: 'application/json' });\n\n      // Create filename with timestamp\n      const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, -5);\n      const filename = `zanobot-backup-${timestamp}.json`;\n\n      // Trigger download\n      const url = URL.createObjectURL(blob);\n      const a = document.createElement('a');\n      a.href = url;\n      a.download = filename;\n      document.body.appendChild(a);\n      a.click();\n      document.body.removeChild(a);\n      URL.revokeObjectURL(url);\n\n      logger.info(` Database exported: ${filename}`);\n      notify.success(\n        `Datei: ${filename}\\n\\nMaschinen: ${data.machines.length}\\nAufnahmen: ${data.recordings.length}\\nDiagnosen: ${data.diagnoses.length}`,\n        { title: 'Datenbank exportiert' }\n      );\n    } catch (error) {\n      logger.error('Export error:', error);\n      notify.error('Fehler beim Exportieren der Datenbank', error as Error);\n    }\n  }\n\n  /**\n   * Handle database import\n   */\n  private async handleImportData(): Promise<void> {\n    try {\n      // Create file input\n      const input = document.createElement('input');\n      input.type = 'file';\n      input.accept = 'application/json,.json';\n\n      input.onchange = async (e: Event) => {\n        const target = e.target as HTMLInputElement;\n        const file = target.files?.[0];\n\n        if (!file) {\n          return;\n        }\n\n        logger.info(` Importing database from: ${file.name}`);\n\n        try {\n          // Read file\n          const text = await file.text();\n          const data = JSON.parse(text);\n\n          // Validate data structure\n          if (!data.machines && !data.recordings && !data.diagnoses) {\n            throw new Error('Invalid backup file format');\n          }\n\n          // Ask for merge or replace\n          const merge = confirm(\n            `Datenbank importieren aus: ${file.name}\\n\\n` +\n              `Mchten Sie die Daten ZUSAMMENFHREN?\\n\\n` +\n              `JA = Zusammenfhren mit bestehenden Daten\\n` +\n              `NEIN = Alle bestehenden Daten ERSETZEN`\n          );\n\n          // Confirm replace if not merging\n          if (!merge) {\n            const confirmReplace = confirm(\n              ` ACHTUNG!\\n\\n` +\n                `Alle bestehenden Daten werden GELSCHT und durch die Import-Daten ersetzt!\\n\\n` +\n                `Mchten Sie fortfahren?`\n            );\n\n            if (!confirmReplace) {\n              return;\n            }\n          }\n\n          // Import data\n          await importData(data, merge);\n\n          // Show success\n          const stats = {\n            machines: data.machines?.length || 0,\n            recordings: data.recordings?.length || 0,\n            diagnoses: data.diagnoses?.length || 0,\n          };\n\n          notify.success(\n            `Maschinen: ${stats.machines}\\nAufnahmen: ${stats.recordings}\\nDiagnosen: ${stats.diagnoses}\\n\\nModus: ${merge ? 'Zusammengefhrt' : 'Ersetzt'}`,\n            { title: 'Datenbank importiert' }\n          );\n\n          // Refresh stats display\n          this.showStats();\n\n          logger.info(' Database import complete');\n        } catch (error) {\n          logger.error('Import error:', error);\n          notify.error('Fehler beim Importieren', error as Error, {\n            duration: 0,\n          });\n        }\n      };\n\n      input.click();\n    } catch (error) {\n      logger.error('Import setup error:', error);\n      notify.error('Fehler beim Vorbereiten des Imports', error as Error);\n    }\n  }\n\n  /**\n   * Handle clear all data\n   */\n  private async handleClearData(): Promise<void> {\n    const confirmed = confirm(\n      ` ACHTUNG!\\n\\n` +\n        `Alle Daten werden UNWIDERRUFLICH gelscht:\\n` +\n        `- Alle Maschinen\\n` +\n        `- Alle Referenzmodelle\\n` +\n        `- Alle Aufnahmen\\n` +\n        `- Alle Diagnosen\\n\\n` +\n        `Mchten Sie fortfahren?`\n    );\n\n    if (!confirmed) {\n      return;\n    }\n\n    // Double confirmation\n    const doubleConfirm = confirm(\n      `Sind Sie ABSOLUT SICHER?\\n\\n` + `Diese Aktion kann NICHT rckgngig gemacht werden!`\n    );\n\n    if (!doubleConfirm) {\n      return;\n    }\n\n    try {\n      logger.info(' Clearing all data...');\n\n      await clearAllData();\n\n      notify.success('Alle Daten wurden gelscht', { title: 'Datenbank geleert' });\n\n      // Refresh stats display\n      this.showStats();\n\n      logger.info(' All data cleared');\n    } catch (error) {\n      logger.error('Clear error:', error);\n      notify.error('Fehler beim Lschen der Daten', error as Error, {\n        duration: 0,\n      });\n    }\n  }\n\n  /**\n   * Show database statistics\n   */\n  private async showStats(): Promise<void> {\n    try {\n      const stats = await getDBStats();\n\n      // Update UI elements\n      const machinesCount = document.getElementById('stats-machines');\n      const recordingsCount = document.getElementById('stats-recordings');\n      const diagnosesCount = document.getElementById('stats-diagnoses');\n\n      if (machinesCount) {\n        machinesCount.textContent = stats.machines.toString();\n      }\n\n      if (recordingsCount) {\n        recordingsCount.textContent = stats.recordings.toString();\n      }\n\n      if (diagnosesCount) {\n        diagnosesCount.textContent = stats.diagnoses.toString();\n      }\n\n      logger.debug(' Database stats:', stats);\n    } catch (error) {\n      logger.error('Stats error:', error);\n    }\n  }\n\n  /**\n   * Cleanup\n   */\n  public destroy(): void {\n    // Cleanup mode selector\n    if (this.modeSelector) {\n      this.modeSelector.destroy();\n      this.modeSelector = null;\n    }\n\n    // Unsubscribe from mode changes\n    if (this.unsubscribeModeChange) {\n      this.unsubscribeModeChange();\n      this.unsubscribeModeChange = undefined;\n    }\n  }\n}\n","/**\n * ZANOBOT - LEVEL 2: REFERENCE PHASE (ML-based)\n *\n * Creates a reference embedding from healthy machine audio using YAMNet.\n * This is used for cyclic machine analysis (Level 2).\n *\n * Flow:\n * 1. User starts recording (10 seconds)\n * 2. Audio is captured and converted to AudioBuffer\n * 3. YAMNet extracts 1024-dimensional embeddings\n * 4. Reference is saved to IndexedDB for later comparison\n *\n * IMPORTANT: This phase is completely separate from Level 1 (GMIA)!\n */\n\nimport { Level2Detector } from '@core/ml/level2/index.js';\nimport type { Level2Reference } from '@core/ml/level2/types.js';\nimport { notify } from '@utils/notifications.js';\nimport { logger } from '@utils/logger.js';\nimport type { Machine } from '@data/types.js';\nimport { getMachine, saveMachine } from '@data/db.js';\n\n/**\n * Recording state\n */\ntype RecordingState = 'idle' | 'countdown' | 'recording' | 'processing' | 'complete' | 'error';\n\n/**\n * Level 2 Reference Phase\n *\n * Handles the creation of ML-based reference recordings for cyclic machines.\n */\nexport class Level2ReferencePhase {\n  private machine: Machine;\n  private detector: Level2Detector;\n  private selectedDeviceId: string | undefined;\n\n  // Recording state\n  private state: RecordingState = 'idle';\n  private mediaRecorder: MediaRecorder | null = null;\n  private audioChunks: Blob[] = [];\n  private recordingDuration: number = 10000; // 10 seconds\n\n  // VISUAL POSITIONING: Camera stream for reference image\n  private cameraStream: MediaStream | null = null;\n  private capturedReferenceImage: Blob | null = null;\n\n  // UI Elements\n  private container: HTMLElement | null = null;\n  private statusElement: HTMLElement | null = null;\n  private progressElement: HTMLElement | null = null;\n  private startButton: HTMLButtonElement | null = null;\n  private timerElement: HTMLElement | null = null;\n\n  // Callbacks\n  private onComplete?: (reference: Level2Reference) => void;\n  private onError?: (error: Error) => void;\n\n  constructor(machine: Machine, selectedDeviceId?: string) {\n    this.machine = machine;\n    this.selectedDeviceId = selectedDeviceId;\n    this.detector = new Level2Detector({\n      onProgress: (progress, message) => this.updateProgress(progress, message),\n      onError: (error) => this.handleError(error),\n      onReferenceCreated: (ref) => this.handleReferenceCreated(ref),\n    });\n\n    logger.info(' Level2ReferencePhase initialized for machine:', machine.id);\n  }\n\n  /**\n   * Initialize the phase (load YAMNet model)\n   */\n  async initialize(): Promise<void> {\n    try {\n      this.setState('processing');\n      this.updateProgress(0, 'Initialisiere ML-Modell...');\n      await this.detector.initialize();\n      this.setState('idle');\n    } catch (error) {\n      this.handleError(error as Error);\n    }\n  }\n\n  /**\n   * Render the UI\n   */\n  render(containerId: string): void {\n    this.container = document.getElementById(containerId);\n    if (!this.container) {\n      logger.error(`Container element not found: ${containerId}`);\n      return;\n    }\n\n    this.container.innerHTML = this.getTemplate();\n    this.bindElements();\n    this.attachEventListeners();\n  }\n\n  /**\n   * Get HTML template\n   */\n  private getTemplate(): string {\n    return `\n      <div class=\"level2-reference-phase\">\n        <div class=\"phase-header\">\n          <h2> Level 2: Referenzlauf (ML)</h2>\n          <p class=\"phase-description\">\n            Nehmen Sie einen Referenzlauf Ihrer Maschine im Normalzustand auf.\n            Diese Aufnahme wird verwendet, um zuknftige Abweichungen zu erkennen.\n          </p>\n        </div>\n\n        <div class=\"machine-info\">\n          <span class=\"machine-label\">Maschine:</span>\n          <span class=\"machine-name\">${this.machine.name}</span>\n        </div>\n\n        <div class=\"recording-status\" id=\"level2-status\">\n          <div class=\"status-icon\"></div>\n          <div class=\"status-text\">Bereit fr Aufnahme</div>\n        </div>\n\n        <div class=\"progress-container\" id=\"level2-progress\" style=\"display: none;\">\n          <div class=\"progress-bar\">\n            <div class=\"progress-fill\" style=\"width: 0%\"></div>\n          </div>\n          <div class=\"progress-text\">0%</div>\n        </div>\n\n        <div class=\"timer-display\" id=\"level2-timer\" style=\"display: none;\">\n          <span class=\"timer-value\">10</span>\n          <span class=\"timer-unit\">Sekunden</span>\n        </div>\n\n        <!-- VISUAL POSITIONING: Camera preview for reference image -->\n        <div class=\"camera-preview-container\" id=\"level2-camera-container\" style=\"display: none;\">\n          <video id=\"level2-camera-preview\" autoplay playsinline muted></video>\n          <p class=\"camera-hint\"> Position fr Referenzbild - halten Sie das Gert ruhig</p>\n        </div>\n\n        <div class=\"action-buttons\">\n          <button id=\"level2-start-btn\" class=\"btn btn-primary btn-large\">\n             Referenz aufnehmen\n          </button>\n        </div>\n\n        <div class=\"info-box\">\n          <h4> Hinweise fr gute Aufnahmen:</h4>\n          <ul>\n            <li>Stellen Sie sicher, dass die Maschine im Normalzustand luft</li>\n            <li>Halten Sie das Mikrofon konstant in Position</li>\n            <li>Vermeiden Sie Strgerusche whrend der Aufnahme</li>\n            <li>Die Aufnahme dauert 10 Sekunden</li>\n          </ul>\n        </div>\n\n        <div class=\"backend-info\" id=\"level2-backend-info\"></div>\n      </div>\n    `;\n  }\n\n  /**\n   * Bind UI elements\n   */\n  private bindElements(): void {\n    this.statusElement = this.container?.querySelector('#level2-status') || null;\n    this.progressElement = this.container?.querySelector('#level2-progress') || null;\n    this.startButton = this.container?.querySelector('#level2-start-btn') || null;\n    this.timerElement = this.container?.querySelector('#level2-timer') || null;\n\n    // Show backend info\n    const backendInfo = this.container?.querySelector('#level2-backend-info');\n    if (backendInfo && this.detector.isReady()) {\n      const info = this.detector.getBackendInfo();\n      backendInfo.innerHTML = `\n        <small>Backend: ${info?.backend || 'nicht geladen'} ${info?.isGPU ? '(GPU)' : '(CPU)'}</small>\n      `;\n    }\n  }\n\n  /**\n   * Attach event listeners\n   */\n  private attachEventListeners(): void {\n    this.startButton?.addEventListener('click', () => this.startRecording());\n  }\n\n  /**\n   * Start recording\n   */\n  async startRecording(): Promise<void> {\n    if (this.state !== 'idle') return;\n\n    try {\n      this.setState('countdown');\n      this.updateStatus(' Aufnahme startet...', 'info');\n\n      // Get microphone access\n      const stream = await navigator.mediaDevices.getUserMedia({\n        audio: {\n          deviceId: this.selectedDeviceId ? { exact: this.selectedDeviceId } : undefined,\n          echoCancellation: false,\n          noiseSuppression: false,\n          autoGainControl: false,\n        },\n      });\n\n      // VISUAL POSITIONING: Request camera access for reference image (non-blocking)\n      try {\n        this.cameraStream = await navigator.mediaDevices.getUserMedia({\n          video: { facingMode: 'environment' }, // Prefer back camera\n          audio: false,\n        });\n        logger.info(' Camera access granted for reference image');\n        this.setupCameraPreview();\n      } catch (cameraError) {\n        logger.warn(' Camera access denied - continuing without reference image', cameraError);\n        this.cameraStream = null;\n      }\n\n      // Start countdown (3 seconds)\n      await this.countdown(3);\n\n      // Start recording\n      this.setState('recording');\n      this.audioChunks = [];\n      this.mediaRecorder = new MediaRecorder(stream);\n\n      this.mediaRecorder.ondataavailable = (event) => {\n        if (event.data.size > 0) {\n          this.audioChunks.push(event.data);\n        }\n      };\n\n      this.mediaRecorder.onstop = async () => {\n        // Stop all tracks\n        stream.getTracks().forEach((track) => track.stop());\n\n        // Cleanup camera\n        this.cleanupCamera();\n\n        // Process recording\n        await this.processRecording();\n      };\n\n      // Show timer\n      this.showTimer(this.recordingDuration / 1000);\n\n      // Start recording\n      this.mediaRecorder.start();\n      this.updateStatus(' Aufnahme luft...', 'recording');\n\n      // VISUAL POSITIONING: Capture snapshot halfway through recording\n      const snapshotDelay = (this.recordingDuration / 2);\n      setTimeout(() => {\n        this.captureReferenceSnapshot();\n      }, snapshotDelay);\n\n      // Stop after duration\n      setTimeout(() => {\n        if (this.mediaRecorder?.state === 'recording') {\n          this.mediaRecorder.stop();\n        }\n      }, this.recordingDuration);\n    } catch (error) {\n      this.handleError(error as Error);\n    }\n  }\n\n  /**\n   * VISUAL POSITIONING: Setup camera preview\n   */\n  private setupCameraPreview(): void {\n    const cameraContainer = this.container?.querySelector('#level2-camera-container') as HTMLElement;\n    const videoElement = this.container?.querySelector('#level2-camera-preview') as HTMLVideoElement;\n\n    if (!cameraContainer || !videoElement || !this.cameraStream) return;\n\n    videoElement.srcObject = this.cameraStream;\n    cameraContainer.style.display = 'block';\n    logger.info(' Camera preview activated');\n  }\n\n  /**\n   * VISUAL POSITIONING: Capture reference snapshot from camera\n   */\n  private captureReferenceSnapshot(): void {\n    if (!this.cameraStream) {\n      logger.info(' No camera stream - skipping reference snapshot');\n      return;\n    }\n\n    const videoElement = this.container?.querySelector('#level2-camera-preview') as HTMLVideoElement;\n    if (!videoElement || videoElement.readyState < 2) {\n      logger.warn(' Video element not ready - skipping snapshot');\n      return;\n    }\n\n    try {\n      // Create canvas for snapshot\n      const canvas = document.createElement('canvas');\n      canvas.width = videoElement.videoWidth;\n      canvas.height = videoElement.videoHeight;\n\n      const ctx = canvas.getContext('2d');\n      if (!ctx) return;\n\n      ctx.drawImage(videoElement, 0, 0);\n\n      // Convert to blob\n      canvas.toBlob(\n        (blob) => {\n          if (blob) {\n            this.capturedReferenceImage = blob;\n            logger.info(` Reference snapshot captured: ${blob.size} bytes (${canvas.width}x${canvas.height})`);\n          }\n        },\n        'image/jpeg',\n        0.85\n      );\n    } catch (error) {\n      logger.warn(' Failed to capture snapshot:', error);\n    }\n  }\n\n  /**\n   * VISUAL POSITIONING: Cleanup camera stream\n   */\n  private cleanupCamera(): void {\n    // Hide camera container\n    const cameraContainer = this.container?.querySelector('#level2-camera-container') as HTMLElement;\n    if (cameraContainer) {\n      cameraContainer.style.display = 'none';\n    }\n\n    // Stop camera stream\n    if (this.cameraStream) {\n      this.cameraStream.getTracks().forEach((track) => track.stop());\n      this.cameraStream = null;\n    }\n\n    logger.info(' Camera cleaned up');\n  }\n\n  /**\n   * Countdown before recording\n   */\n  private async countdown(seconds: number): Promise<void> {\n    for (let i = seconds; i > 0; i--) {\n      this.updateStatus(` Aufnahme startet in ${i}...`, 'countdown');\n      await this.sleep(1000);\n    }\n  }\n\n  /**\n   * Show recording timer\n   */\n  private showTimer(seconds: number): void {\n    if (!this.timerElement) return;\n\n    this.timerElement.style.display = 'block';\n    const timerValue = this.timerElement.querySelector('.timer-value');\n    let remaining = seconds;\n\n    const interval = setInterval(() => {\n      remaining--;\n      if (timerValue) {\n        timerValue.textContent = String(remaining);\n      }\n\n      if (remaining <= 0) {\n        clearInterval(interval);\n        this.timerElement!.style.display = 'none';\n      }\n    }, 1000);\n  }\n\n  /**\n   * Process the recorded audio\n   */\n  private async processRecording(): Promise<void> {\n    this.setState('processing');\n    this.updateStatus(' Verarbeite Aufnahme...', 'processing');\n    this.showProgress();\n\n    try {\n      // Convert chunks to AudioBuffer\n      const audioBlob = new Blob(this.audioChunks, { type: 'audio/webm' });\n      const arrayBuffer = await audioBlob.arrayBuffer();\n\n      // Decode audio\n      const audioContext = new AudioContext();\n      const audioBuffer = await audioContext.decodeAudioData(arrayBuffer);\n      audioContext.close();\n\n      // Create reference\n      await this.detector.createReference(audioBuffer, this.machine.id, 'Baseline');\n    } catch (error) {\n      this.handleError(error as Error);\n    }\n  }\n\n  /**\n   * Handle successful reference creation\n   */\n  private async handleReferenceCreated(reference: Level2Reference): Promise<void> {\n    this.setState('complete');\n    this.updateStatus(' Referenz erfolgreich erstellt!', 'success');\n    this.hideProgress();\n\n    // VISUAL POSITIONING: Save reference image to machine\n    await this.saveReferenceImage();\n\n    notify.success('Level 2 Referenz wurde gespeichert');\n\n    // Update button\n    if (this.startButton) {\n      this.startButton.textContent = ' Referenz erstellt';\n      this.startButton.disabled = true;\n    }\n\n    // Trigger callback\n    this.onComplete?.(reference);\n\n    logger.info(' Level 2 reference created:', {\n      machineId: reference.machineId,\n      duration: reference.duration,\n      embeddingSize: reference.embedding.length,\n      hasReferenceImage: !!this.capturedReferenceImage,\n    });\n  }\n\n  /**\n   * VISUAL POSITIONING: Save reference image to machine\n   */\n  private async saveReferenceImage(): Promise<void> {\n    if (!this.capturedReferenceImage) {\n      logger.info(' No reference image to save');\n      return;\n    }\n\n    try {\n      // Get latest machine data\n      const machineToUpdate = await getMachine(this.machine.id);\n      if (!machineToUpdate) {\n        logger.warn(' Machine not found for image save');\n        return;\n      }\n\n      // Save reference image\n      machineToUpdate.referenceImage = this.capturedReferenceImage;\n      await saveMachine(machineToUpdate);\n\n      // Update local machine reference\n      this.machine = machineToUpdate;\n\n      logger.info(` Reference image saved to machine (${this.capturedReferenceImage.size} bytes)`);\n    } catch (error) {\n      logger.error(' Failed to save reference image:', error);\n    }\n  }\n\n  /**\n   * Handle errors\n   */\n  private handleError(error: Error): void {\n    this.setState('error');\n    this.updateStatus(` Fehler: ${error.message}`, 'error');\n    this.hideProgress();\n\n    notify.error(error.message, error);\n\n    // Reset button\n    if (this.startButton) {\n      this.startButton.textContent = ' Referenz aufnehmen';\n      this.startButton.disabled = false;\n    }\n\n    this.onError?.(error);\n    logger.error('Level 2 Reference error:', error);\n  }\n\n  /**\n   * Update status display\n   */\n  private updateStatus(text: string, type: 'info' | 'recording' | 'processing' | 'success' | 'error' | 'countdown'): void {\n    if (!this.statusElement) return;\n\n    const icons: Record<string, string> = {\n      info: '',\n      recording: '',\n      processing: '',\n      success: '',\n      error: '',\n      countdown: '',\n    };\n\n    const statusText = this.statusElement.querySelector('.status-text');\n    const statusIcon = this.statusElement.querySelector('.status-icon');\n\n    if (statusText) statusText.textContent = text;\n    if (statusIcon) statusIcon.textContent = icons[type] || '';\n\n    // Update CSS class\n    this.statusElement.className = `recording-status status-${type}`;\n  }\n\n  /**\n   * Update progress display\n   */\n  private updateProgress(progress: number, message: string): void {\n    if (!this.progressElement) return;\n\n    const fill = this.progressElement.querySelector('.progress-fill') as HTMLElement;\n    const text = this.progressElement.querySelector('.progress-text');\n\n    if (fill) fill.style.width = `${progress}%`;\n    if (text) text.textContent = message;\n  }\n\n  /**\n   * Show progress bar\n   */\n  private showProgress(): void {\n    if (this.progressElement) {\n      this.progressElement.style.display = 'block';\n    }\n  }\n\n  /**\n   * Hide progress bar\n   */\n  private hideProgress(): void {\n    if (this.progressElement) {\n      this.progressElement.style.display = 'none';\n    }\n  }\n\n  /**\n   * Set internal state\n   */\n  private setState(state: RecordingState): void {\n    this.state = state;\n\n    // Update button state\n    if (this.startButton) {\n      this.startButton.disabled = state !== 'idle' && state !== 'complete' && state !== 'error';\n    }\n  }\n\n  /**\n   * Sleep utility\n   */\n  private sleep(ms: number): Promise<void> {\n    return new Promise((resolve) => setTimeout(resolve, ms));\n  }\n\n  /**\n   * Set completion callback\n   */\n  setOnComplete(callback: (reference: Level2Reference) => void): void {\n    this.onComplete = callback;\n  }\n\n  /**\n   * Set error callback\n   */\n  setOnError(callback: (error: Error) => void): void {\n    this.onError = callback;\n  }\n\n  /**\n   * Cleanup\n   */\n  destroy(): void {\n    if (this.mediaRecorder?.state === 'recording') {\n      this.mediaRecorder.stop();\n    }\n\n    // VISUAL POSITIONING: Cleanup camera\n    this.cleanupCamera();\n    this.capturedReferenceImage = null;\n\n    this.detector.dispose();\n    this.container = null;\n    logger.info(' Level2ReferencePhase destroyed');\n  }\n}\n","/**\n * ZANOBOT - LEVEL 2: DIAGNOSE PHASE (ML-based)\n *\n * Compares current machine audio against reference using YAMNet embeddings.\n * This is used for cyclic machine analysis (Level 2).\n *\n * Flow:\n * 1. Load reference embedding from storage\n * 2. Record current machine audio (10 seconds)\n * 3. Extract YAMNet embeddings from current audio\n * 4. Calculate cosine similarity with reference\n * 5. Display health status and spectrogram\n *\n * IMPORTANT: This phase is completely separate from Level 1 (GMIA)!\n */\n\nimport { Level2Detector } from '@core/ml/level2/index.js';\nimport { MelSpectrogramGenerator } from '@core/audio/mel-spectrogram.js';\nimport type { Level2AnalysisResult, HealthStatusResult } from '@core/ml/level2/index.js';\nimport { notify } from '@utils/notifications.js';\nimport { logger } from '@utils/logger.js';\nimport type { Machine, DiagnosisResult } from '@data/types.js';\nimport { getMachine, saveDiagnosis } from '@data/db.js';\n\n/**\n * Diagnosis state\n */\ntype DiagnosisState = 'idle' | 'loading-reference' | 'recording' | 'analyzing' | 'complete' | 'error' | 'no-reference';\n\n/**\n * Level 2 Diagnose Phase\n *\n * Handles ML-based diagnosis for cyclic machines.\n */\nexport class Level2DiagnosePhase {\n  private machine: Machine;\n  private detector: Level2Detector;\n  private specGen: MelSpectrogramGenerator;\n  private selectedDeviceId: string | undefined;\n\n  // State\n  private state: DiagnosisState = 'idle';\n  private mediaRecorder: MediaRecorder | null = null;\n  private audioChunks: Blob[] = [];\n  private recordingDuration: number = 10000; // 10 seconds\n  private lastResult: Level2AnalysisResult | null = null;\n\n  // VISUAL POSITIONING: Camera stream for ghost overlay\n  private cameraStream: MediaStream | null = null;\n\n  // CRITICAL FIX: Store audio stream reference for proper cleanup\n  // Without this, the microphone could stay locked if destroy() is called\n  // before MediaRecorder.onstop triggers (e.g., during quick navigation)\n  private audioStream: MediaStream | null = null;\n\n  // LIVE WATERFALL: Audio context and analyser for real-time visualization\n  private audioContext: AudioContext | null = null;\n  private analyserNode: AnalyserNode | null = null;\n  private waterfallCanvas: HTMLCanvasElement | null = null;\n  private waterfallCtx: CanvasRenderingContext2D | null = null;\n  private waterfallAnimationId: number | null = null;\n  private waterfallData: number[][] = []; // Stores history of FFT data for waterfall effect\n  private waterfallStartTime: number = 0;\n\n  // UI Elements\n  private container: HTMLElement | null = null;\n  private statusElement: HTMLElement | null = null;\n  private resultElement: HTMLElement | null = null;\n  private spectrogramCanvas: HTMLCanvasElement | null = null;\n  private startButton: HTMLButtonElement | null = null;\n  private similarityMeter: HTMLElement | null = null;\n\n  // Callbacks\n  private onComplete?: (result: Level2AnalysisResult) => void;\n  private onError?: (error: Error) => void;\n\n  constructor(machine: Machine, selectedDeviceId?: string) {\n    this.machine = machine;\n    this.selectedDeviceId = selectedDeviceId;\n    this.specGen = new MelSpectrogramGenerator();\n    this.detector = new Level2Detector({\n      onProgress: (progress, message) => this.updateProgress(progress, message),\n      onError: (error) => this.handleError(error),\n      onAnalysisComplete: (result) => this.handleAnalysisComplete(result),\n    });\n\n    logger.info(' Level2DiagnosePhase initialized for machine:', machine.id);\n  }\n\n  /**\n   * Initialize the phase (load YAMNet and reference)\n   */\n  async initialize(): Promise<void> {\n    try {\n      this.setState('loading-reference');\n      await this.detector.initialize();\n\n      // Try to load reference\n      const hasReference = await this.detector.loadReferenceFromStorage(this.machine.id);\n\n      if (!hasReference) {\n        this.setState('no-reference');\n        this.updateStatus(' Keine Referenz vorhanden. Bitte zuerst Referenz erstellen.', 'warning');\n      } else {\n        this.setState('idle');\n        this.updateStatus(' Referenz geladen. Bereit fr Diagnose.', 'ready');\n      }\n    } catch (error) {\n      this.handleError(error as Error);\n    }\n  }\n\n  /**\n   * Render the UI\n   */\n  render(containerId: string): void {\n    this.container = document.getElementById(containerId);\n    if (!this.container) {\n      logger.error(`Container element not found: ${containerId}`);\n      return;\n    }\n\n    this.container.innerHTML = this.getTemplate();\n    this.bindElements();\n    this.attachEventListeners();\n  }\n\n  /**\n   * Get HTML template\n   */\n  private getTemplate(): string {\n    return `\n      <div class=\"level2-diagnose-phase\">\n        <div class=\"phase-header\">\n          <h2> Level 2: Maschine prfen (ML)</h2>\n          <p class=\"phase-description\">\n            Vergleichen Sie den aktuellen Maschinenzustand mit der Referenz.\n          </p>\n        </div>\n\n        <div class=\"machine-info\">\n          <span class=\"machine-label\">Maschine:</span>\n          <span class=\"machine-name\">${this.machine.name}</span>\n        </div>\n\n        <div class=\"diagnosis-status\" id=\"level2-diag-status\">\n          <div class=\"status-icon\"></div>\n          <div class=\"status-text\">Initialisiere...</div>\n        </div>\n\n        <!-- VISUAL POSITIONING: Ghost overlay container (hidden initially) -->\n        <div class=\"ghost-overlay-container\" id=\"level2-ghost-container\" style=\"display: none;\">\n          <div class=\"ghost-overlay-wrapper\">\n            <video id=\"level2-live-video\" autoplay playsinline muted></video>\n            <img id=\"level2-ghost-image\" class=\"ghost-overlay-image\" alt=\"Reference position\" />\n          </div>\n          <p class=\"ghost-hint\"> Bewegen Sie das Handy, bis Live-Bild und Referenzbild bereinstimmen</p>\n        </div>\n\n        <!-- LIVE WATERFALL: Real-time spectrogram during recording -->\n        <div class=\"waterfall-container\" id=\"level2-waterfall-container\" style=\"display: none;\">\n          <h4> Live-Aufnahme</h4>\n          <canvas id=\"level2-waterfall-canvas\" width=\"400\" height=\"150\"></canvas>\n          <div class=\"waterfall-time-indicator\">\n            <span id=\"waterfall-elapsed\">0</span>s / 10s\n          </div>\n        </div>\n\n        <div class=\"similarity-container\" id=\"level2-similarity\" style=\"display: none;\">\n          <div class=\"similarity-label\">bereinstimmung mit Referenz</div>\n          <div class=\"similarity-meter\">\n            <div class=\"meter-bar\">\n              <div class=\"meter-fill\" id=\"similarity-fill\" style=\"width: 0%\"></div>\n            </div>\n            <div class=\"meter-value\" id=\"similarity-value\">0%</div>\n          </div>\n        </div>\n\n        <!-- TRAFFIC LIGHT: Enhanced health status display -->\n        <div class=\"traffic-light-status\" id=\"level2-traffic-light\" style=\"display: none;\">\n          <div class=\"traffic-light\">\n            <div class=\"light red\" id=\"light-red\"></div>\n            <div class=\"light yellow\" id=\"light-yellow\"></div>\n            <div class=\"light green\" id=\"light-green\"></div>\n          </div>\n          <div class=\"traffic-light-info\">\n            <div class=\"traffic-light-label\" id=\"traffic-light-label\">-</div>\n            <div class=\"traffic-light-score\" id=\"traffic-light-score\">-</div>\n          </div>\n        </div>\n\n        <div class=\"health-status\" id=\"level2-health-status\" style=\"display: none;\">\n          <div class=\"health-icon\"></div>\n          <div class=\"health-message\"></div>\n        </div>\n\n        <div class=\"spectrogram-container\" id=\"level2-spectrogram\" style=\"display: none;\">\n          <h4> Spektrogramm (Analyse)</h4>\n          <canvas id=\"spectrogram-canvas\" width=\"600\" height=\"200\"></canvas>\n        </div>\n\n        <div class=\"action-buttons\">\n          <button id=\"level2-diag-btn\" class=\"btn btn-primary btn-large\" disabled>\n             Maschine prfen\n          </button>\n        </div>\n\n        <div class=\"result-details\" id=\"level2-result-details\" style=\"display: none;\">\n          <h4> Analyseergebnis</h4>\n          <div class=\"details-grid\">\n            <div class=\"detail-item\">\n              <span class=\"detail-label\">hnlichkeit:</span>\n              <span class=\"detail-value\" id=\"detail-similarity\">-</span>\n            </div>\n            <div class=\"detail-item\">\n              <span class=\"detail-label\">Status:</span>\n              <span class=\"detail-value\" id=\"detail-status\">-</span>\n            </div>\n            <div class=\"detail-item\">\n              <span class=\"detail-label\">Analysezeit:</span>\n              <span class=\"detail-value\" id=\"detail-time\">-</span>\n            </div>\n          </div>\n        </div>\n\n        <div class=\"backend-info\" id=\"level2-diag-backend-info\"></div>\n      </div>\n    `;\n  }\n\n  /**\n   * Bind UI elements\n   */\n  private bindElements(): void {\n    this.statusElement = this.container?.querySelector('#level2-diag-status') || null;\n    this.resultElement = this.container?.querySelector('#level2-result-details') || null;\n    this.startButton = this.container?.querySelector('#level2-diag-btn') || null;\n    this.similarityMeter = this.container?.querySelector('#level2-similarity') || null;\n    this.spectrogramCanvas = this.container?.querySelector('#spectrogram-canvas') || null;\n\n    // LIVE WATERFALL: Bind canvas\n    this.waterfallCanvas = this.container?.querySelector('#level2-waterfall-canvas') || null;\n    if (this.waterfallCanvas) {\n      this.waterfallCtx = this.waterfallCanvas.getContext('2d');\n    }\n\n    // Show backend info\n    const backendInfo = this.container?.querySelector('#level2-diag-backend-info');\n    if (backendInfo && this.detector.isReady()) {\n      const info = this.detector.getBackendInfo();\n      backendInfo.innerHTML = `\n        <small>Backend: ${info?.backend || 'nicht geladen'} ${info?.isGPU ? '(GPU)' : '(CPU)'}</small>\n      `;\n    }\n  }\n\n  /**\n   * Attach event listeners\n   */\n  private attachEventListeners(): void {\n    this.startButton?.addEventListener('click', () => this.startDiagnosis());\n  }\n\n  /**\n   * Start diagnosis recording\n   */\n  async startDiagnosis(): Promise<void> {\n    // Allow restart from 'idle' or 'complete' state\n    if (this.state !== 'idle' && this.state !== 'complete') return;\n\n    if (!this.detector.hasLoadedReference()) {\n      notify.error('Keine Referenz vorhanden. Bitte zuerst Referenz erstellen.');\n      return;\n    }\n\n    try {\n      this.setState('recording');\n      this.updateStatus(' Aufnahme luft...', 'recording');\n\n      // Refresh machine data for reference image\n      const latestMachine = await getMachine(this.machine.id);\n      if (latestMachine) {\n        this.machine = latestMachine;\n      }\n\n      // Get microphone access\n      // CRITICAL FIX: Store stream as class property for proper cleanup in destroy()\n      this.audioStream = await navigator.mediaDevices.getUserMedia({\n        audio: {\n          deviceId: this.selectedDeviceId ? { exact: this.selectedDeviceId } : undefined,\n          echoCancellation: false,\n          noiseSuppression: false,\n          autoGainControl: false,\n        },\n      });\n\n      // VISUAL POSITIONING: Request camera access (non-blocking)\n      try {\n        this.cameraStream = await navigator.mediaDevices.getUserMedia({\n          video: { facingMode: 'environment' },\n          audio: false,\n        });\n        logger.info(' Camera access granted for ghost overlay');\n        this.setupGhostOverlay();\n      } catch (cameraError) {\n        logger.warn(' Camera access denied - continuing without ghost overlay');\n        this.cameraStream = null;\n      }\n\n      // LIVE WATERFALL: Setup audio context and analyser\n      this.audioContext = new AudioContext();\n      this.analyserNode = this.audioContext.createAnalyser();\n      this.analyserNode.fftSize = 256;\n      this.analyserNode.smoothingTimeConstant = 0.7;\n\n      const source = this.audioContext.createMediaStreamSource(this.audioStream);\n      source.connect(this.analyserNode);\n\n      // Start waterfall visualization\n      this.startWaterfallVisualization();\n\n      // Start recording\n      this.audioChunks = [];\n      this.mediaRecorder = new MediaRecorder(this.audioStream);\n\n      this.mediaRecorder.ondataavailable = (event) => {\n        if (event.data.size > 0) {\n          this.audioChunks.push(event.data);\n        }\n      };\n\n      this.mediaRecorder.onstop = async () => {\n        // CRITICAL FIX: Use class property and null-check for safety\n        this.cleanupAudioStream();\n        this.stopWaterfallVisualization();\n        this.cleanupCameraStream();\n        await this.processRecording();\n      };\n\n      // Start recording\n      this.mediaRecorder.start();\n\n      // Show countdown\n      this.showRecordingTimer(this.recordingDuration / 1000);\n\n      // Stop after duration\n      setTimeout(() => {\n        if (this.mediaRecorder?.state === 'recording') {\n          this.mediaRecorder.stop();\n        }\n      }, this.recordingDuration);\n    } catch (error) {\n      this.handleError(error as Error);\n    }\n  }\n\n  /**\n   * VISUAL POSITIONING: Setup ghost overlay with reference image\n   */\n  private setupGhostOverlay(): void {\n    const ghostContainer = this.container?.querySelector('#level2-ghost-container') as HTMLElement;\n    const videoElement = this.container?.querySelector('#level2-live-video') as HTMLVideoElement;\n    const ghostImage = this.container?.querySelector('#level2-ghost-image') as HTMLImageElement;\n\n    if (!ghostContainer || !videoElement || !ghostImage) return;\n\n    // Attach camera stream to video\n    if (this.cameraStream) {\n      videoElement.srcObject = this.cameraStream;\n    }\n\n    // Load reference image if available\n    if (this.machine.referenceImage) {\n      const imageUrl = URL.createObjectURL(this.machine.referenceImage);\n      ghostImage.src = imageUrl;\n      ghostImage.onload = () => {\n        // Revoke URL after image loads to free memory\n        // Note: We create a new one each time, so this is safe\n      };\n    }\n\n    // Show the container\n    ghostContainer.style.display = 'block';\n    logger.info(' Ghost overlay activated');\n  }\n\n  /**\n   * CRITICAL FIX: Cleanup audio stream to release microphone\n   * This ensures the microphone is released even if destroy() is called\n   * before MediaRecorder.onstop triggers (e.g., during quick navigation).\n   * Without this, phone calls could be blocked!\n   */\n  private cleanupAudioStream(): void {\n    if (this.audioStream) {\n      this.audioStream.getTracks().forEach(track => track.stop());\n      this.audioStream = null;\n      logger.debug(' Audio stream released - microphone is now available for other apps');\n    }\n  }\n\n  /**\n   * Cleanup camera stream\n   */\n  private cleanupCameraStream(): void {\n    if (this.cameraStream) {\n      this.cameraStream.getTracks().forEach(track => track.stop());\n      this.cameraStream = null;\n    }\n\n    // Hide ghost container\n    const ghostContainer = this.container?.querySelector('#level2-ghost-container') as HTMLElement;\n    if (ghostContainer) {\n      ghostContainer.style.display = 'none';\n    }\n\n    // Revoke ghost image URL\n    const ghostImage = this.container?.querySelector('#level2-ghost-image') as HTMLImageElement;\n    if (ghostImage && ghostImage.src) {\n      URL.revokeObjectURL(ghostImage.src);\n      ghostImage.src = '';\n    }\n  }\n\n  /**\n   * LIVE WATERFALL: Start real-time spectrogram visualization\n   */\n  private startWaterfallVisualization(): void {\n    const container = this.container?.querySelector('#level2-waterfall-container') as HTMLElement;\n    if (container) {\n      container.style.display = 'block';\n    }\n\n    this.waterfallData = [];\n    this.waterfallStartTime = Date.now();\n\n    const render = () => {\n      if (!this.analyserNode || !this.waterfallCanvas || !this.waterfallCtx) {\n        return;\n      }\n\n      const bufferLength = this.analyserNode.frequencyBinCount;\n      const dataArray = new Uint8Array(bufferLength);\n      this.analyserNode.getByteFrequencyData(dataArray);\n\n      // Convert to normalized values and add to history\n      const normalized = Array.from(dataArray).map(v => v / 255);\n      this.waterfallData.push(normalized);\n\n      // Limit history to canvas width\n      const maxColumns = this.waterfallCanvas.width;\n      if (this.waterfallData.length > maxColumns) {\n        this.waterfallData.shift();\n      }\n\n      // Render waterfall\n      this.renderWaterfall();\n\n      // Update time indicator\n      const elapsed = Math.floor((Date.now() - this.waterfallStartTime) / 1000);\n      const elapsedElement = this.container?.querySelector('#waterfall-elapsed');\n      if (elapsedElement) {\n        elapsedElement.textContent = elapsed.toString();\n      }\n\n      this.waterfallAnimationId = requestAnimationFrame(render);\n    };\n\n    render();\n  }\n\n  /**\n   * Render waterfall spectrogram to canvas\n   */\n  private renderWaterfall(): void {\n    if (!this.waterfallCanvas || !this.waterfallCtx || this.waterfallData.length === 0) return;\n\n    const ctx = this.waterfallCtx;\n    const width = this.waterfallCanvas.width;\n    const height = this.waterfallCanvas.height;\n\n    // Clear canvas\n    ctx.fillStyle = '#1a1a2e';\n    ctx.fillRect(0, 0, width, height);\n\n    // Calculate column width (builds up from left to right)\n    const columnWidth = Math.max(1, Math.floor(width / (this.recordingDuration / 1000 * 30))); // ~30fps\n    const numColumns = this.waterfallData.length;\n\n    for (let col = 0; col < numColumns; col++) {\n      const column = this.waterfallData[col];\n      const x = col * columnWidth;\n\n      for (let row = 0; row < column.length; row++) {\n        const value = column[row];\n        const y = height - (row / column.length) * height;\n        const rowHeight = height / column.length;\n\n        // Color based on intensity (blue -> cyan -> green -> yellow -> red)\n        const color = this.getWaterfallColor(value);\n        ctx.fillStyle = color;\n        ctx.fillRect(x, y - rowHeight, columnWidth, rowHeight);\n      }\n    }\n\n    // Draw progress line\n    const progress = (Date.now() - this.waterfallStartTime) / this.recordingDuration;\n    const lineX = Math.min(progress * width, width - 2);\n    ctx.strokeStyle = '#00f3ff';\n    ctx.lineWidth = 2;\n    ctx.beginPath();\n    ctx.moveTo(lineX, 0);\n    ctx.lineTo(lineX, height);\n    ctx.stroke();\n  }\n\n  /**\n   * Get color for waterfall visualization (Viridis-like)\n   */\n  private getWaterfallColor(value: number): string {\n    // Clamp value\n    const v = Math.max(0, Math.min(1, value));\n\n    // Enhanced color mapping for visibility\n    if (v < 0.2) {\n      // Dark blue/purple\n      const intensity = v / 0.2;\n      return `rgb(${Math.floor(20 + 20 * intensity)}, ${Math.floor(10 + 30 * intensity)}, ${Math.floor(60 + 40 * intensity)})`;\n    } else if (v < 0.4) {\n      // Blue to cyan\n      const intensity = (v - 0.2) / 0.2;\n      return `rgb(${Math.floor(40 * (1 - intensity))}, ${Math.floor(40 + 180 * intensity)}, ${Math.floor(100 + 155 * intensity)})`;\n    } else if (v < 0.6) {\n      // Cyan to green\n      const intensity = (v - 0.4) / 0.2;\n      return `rgb(${Math.floor(100 * intensity)}, ${Math.floor(220 - 20 * intensity)}, ${Math.floor(255 - 155 * intensity)})`;\n    } else if (v < 0.8) {\n      // Green to yellow\n      const intensity = (v - 0.6) / 0.2;\n      return `rgb(${Math.floor(100 + 155 * intensity)}, ${Math.floor(200 + 55 * intensity)}, ${Math.floor(100 - 100 * intensity)})`;\n    } else {\n      // Yellow to red\n      const intensity = (v - 0.8) / 0.2;\n      return `rgb(255, ${Math.floor(255 - 200 * intensity)}, ${Math.floor(intensity * 50)})`;\n    }\n  }\n\n  /**\n   * Stop waterfall visualization\n   */\n  private stopWaterfallVisualization(): void {\n    if (this.waterfallAnimationId) {\n      cancelAnimationFrame(this.waterfallAnimationId);\n      this.waterfallAnimationId = null;\n    }\n\n    // Close audio context\n    if (this.audioContext && this.audioContext.state !== 'closed') {\n      this.audioContext.close();\n      this.audioContext = null;\n    }\n\n    this.analyserNode = null;\n\n    // Hide waterfall container\n    const container = this.container?.querySelector('#level2-waterfall-container') as HTMLElement;\n    if (container) {\n      container.style.display = 'none';\n    }\n  }\n\n  /**\n   * Show recording timer\n   */\n  private showRecordingTimer(seconds: number): void {\n    let remaining = seconds;\n    const interval = setInterval(() => {\n      remaining--;\n      this.updateStatus(` Aufnahme luft... (${remaining}s)`, 'recording');\n\n      if (remaining <= 0) {\n        clearInterval(interval);\n      }\n    }, 1000);\n  }\n\n  /**\n   * Process recorded audio\n   */\n  private async processRecording(): Promise<void> {\n    this.setState('analyzing');\n    this.updateStatus(' Analysiere Aufnahme...', 'analyzing');\n\n    try {\n      // Convert chunks to AudioBuffer\n      const audioBlob = new Blob(this.audioChunks, { type: 'audio/webm' });\n      const arrayBuffer = await audioBlob.arrayBuffer();\n\n      // Decode audio\n      const audioContext = new AudioContext();\n      const audioBuffer = await audioContext.decodeAudioData(arrayBuffer);\n      audioContext.close();\n\n      // Analyze\n      await this.detector.analyzeAudio(audioBuffer);\n    } catch (error) {\n      this.handleError(error as Error);\n    }\n  }\n\n  /**\n   * Handle analysis completion\n   */\n  private async handleAnalysisComplete(result: Level2AnalysisResult): Promise<void> {\n    this.lastResult = result;\n    this.setState('complete');\n\n    // Update UI\n    this.updateSimilarityMeter(result.percentage);\n    this.updateHealthStatus(result.status);\n    this.updateTrafficLight(result.percentage, result.status); // TRAFFIC LIGHT\n    this.renderSpectrogram(result.spectrogram);\n    this.showResultDetails(result);\n\n    this.updateStatus(` Analyse abgeschlossen: ${result.percentage.toFixed(1)}%`, 'complete');\n\n    // Notification based on status\n    if (result.status.status === 'HEALTHY') {\n      notify.success(result.status.message);\n    } else if (result.status.status === 'WARNING') {\n      notify.warning(result.status.message);\n    } else {\n      notify.error(result.status.message);\n    }\n\n    // Save diagnosis result to database\n    await this.saveDiagnosisResult(result);\n\n    this.onComplete?.(result);\n\n    logger.info(' Level 2 analysis complete:', {\n      similarity: result.percentage,\n      status: result.status.status,\n      analysisTime: result.analysisTime,\n    });\n  }\n\n  /**\n   * Save diagnosis result to database\n   */\n  private async saveDiagnosisResult(result: Level2AnalysisResult): Promise<void> {\n    try {\n      // Map Level2 status to DiagnosisResult status\n      const statusMap: Record<string, 'healthy' | 'uncertain' | 'faulty'> = {\n        'HEALTHY': 'healthy',\n        'WARNING': 'uncertain',\n        'CRITICAL': 'faulty',\n      };\n\n      const diagnosis: DiagnosisResult = {\n        id: `diag-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,\n        machineId: this.machine.id,\n        timestamp: result.timestamp,\n        healthScore: result.percentage,\n        status: statusMap[result.status.status] || 'uncertain',\n        confidence: result.similarity * 100, // Convert 0-1 to 0-100\n        rawCosineSimilarity: result.similarity,\n        metadata: {\n          analysisMethod: 'YAMNet',\n          level: 2,\n          analysisTime: result.analysisTime,\n          statusMessage: result.status.message,\n        },\n      };\n\n      await saveDiagnosis(diagnosis);\n      logger.info(' Level 2 diagnosis saved to database');\n      notify.info('Diagnose gespeichert');\n    } catch (error) {\n      logger.error(' Failed to save diagnosis:', error);\n      notify.error('Diagnose konnte nicht gespeichert werden');\n    }\n  }\n\n  /**\n   * TRAFFIC LIGHT: Update visual status indicator\n   * Uses same colors as Level 1 for consistency:\n   * - Green (Healthy): 85% similarity\n   * - Yellow (Warning): 70-85% similarity\n   * - Red (Critical): <70% similarity\n   */\n  private updateTrafficLight(percentage: number, status: HealthStatusResult): void {\n    const trafficLight = this.container?.querySelector('#level2-traffic-light') as HTMLElement;\n    if (!trafficLight) return;\n\n    trafficLight.style.display = 'flex';\n\n    const redLight = this.container?.querySelector('#light-red') as HTMLElement;\n    const yellowLight = this.container?.querySelector('#light-yellow') as HTMLElement;\n    const greenLight = this.container?.querySelector('#light-green') as HTMLElement;\n    const label = this.container?.querySelector('#traffic-light-label') as HTMLElement;\n    const score = this.container?.querySelector('#traffic-light-score') as HTMLElement;\n\n    // Reset all lights\n    [redLight, yellowLight, greenLight].forEach(light => {\n      if (light) {\n        light.classList.remove('active');\n      }\n    });\n\n    // Activate appropriate light based on status\n    if (status.status === 'HEALTHY') {\n      greenLight?.classList.add('active');\n      if (label) {\n        label.textContent = 'GESUND';\n        label.style.color = '#10b981';\n      }\n    } else if (status.status === 'WARNING') {\n      yellowLight?.classList.add('active');\n      if (label) {\n        label.textContent = 'WARNUNG';\n        label.style.color = '#f59e0b';\n      }\n    } else {\n      redLight?.classList.add('active');\n      if (label) {\n        label.textContent = 'KRITISCH';\n        label.style.color = '#ef4444';\n      }\n    }\n\n    // Update score display\n    if (score) {\n      score.textContent = `${percentage.toFixed(1)}%`;\n      score.style.color = status.color;\n    }\n  }\n\n  /**\n   * Update similarity meter\n   */\n  private updateSimilarityMeter(percentage: number): void {\n    if (!this.similarityMeter) return;\n\n    this.similarityMeter.style.display = 'block';\n\n    const fill = document.getElementById('similarity-fill') as HTMLElement;\n    const value = document.getElementById('similarity-value');\n\n    if (fill) {\n      fill.style.width = `${percentage}%`;\n      fill.style.transition = 'width 0.5s ease-out';\n\n      // Color based on percentage\n      if (percentage >= 85) {\n        fill.style.background = 'linear-gradient(to right, #10b981, #34d399)';\n      } else if (percentage >= 70) {\n        fill.style.background = 'linear-gradient(to right, #f59e0b, #fbbf24)';\n      } else {\n        fill.style.background = 'linear-gradient(to right, #ef4444, #f87171)';\n      }\n    }\n\n    if (value) {\n      value.textContent = `${percentage.toFixed(1)}%`;\n    }\n  }\n\n  /**\n   * Update health status display\n   */\n  private updateHealthStatus(status: HealthStatusResult): void {\n    const healthElement = this.container?.querySelector('#level2-health-status') as HTMLElement;\n    if (!healthElement) return;\n\n    healthElement.style.display = 'block';\n    healthElement.style.backgroundColor = status.color;\n    healthElement.style.padding = '20px';\n    healthElement.style.borderRadius = '12px';\n    healthElement.style.textAlign = 'center';\n    healthElement.style.color = 'white';\n\n    const icon = healthElement.querySelector('.health-icon');\n    const message = healthElement.querySelector('.health-message');\n\n    if (icon) icon.textContent = status.icon;\n    if (message) message.textContent = status.message;\n  }\n\n  /**\n   * Render spectrogram visualization\n   */\n  private renderSpectrogram(spectrogram: number[][]): void {\n    const container = this.container?.querySelector('#level2-spectrogram') as HTMLElement;\n    if (!container || !this.spectrogramCanvas) return;\n\n    container.style.display = 'block';\n    this.specGen.renderToCanvas(spectrogram, this.spectrogramCanvas);\n  }\n\n  /**\n   * Show result details\n   */\n  private showResultDetails(result: Level2AnalysisResult): void {\n    if (!this.resultElement) return;\n\n    this.resultElement.style.display = 'block';\n\n    const similarity = document.getElementById('detail-similarity');\n    const status = document.getElementById('detail-status');\n    const time = document.getElementById('detail-time');\n\n    if (similarity) similarity.textContent = `${result.percentage.toFixed(1)}%`;\n    if (status) {\n      status.textContent = result.status.status;\n      status.style.color = result.status.color;\n    }\n    if (time) time.textContent = `${result.analysisTime.toFixed(0)} ms`;\n  }\n\n  /**\n   * Update status display\n   */\n  private updateStatus(text: string, type: string): void {\n    if (!this.statusElement) return;\n\n    const icons: Record<string, string> = {\n      ready: '',\n      recording: '',\n      analyzing: '',\n      complete: '',\n      error: '',\n      warning: '',\n    };\n\n    const statusText = this.statusElement.querySelector('.status-text');\n    const statusIcon = this.statusElement.querySelector('.status-icon');\n\n    if (statusText) statusText.textContent = text;\n    if (statusIcon) statusIcon.textContent = icons[type] || '';\n\n    this.statusElement.className = `diagnosis-status status-${type}`;\n  }\n\n  /**\n   * Update progress (from detector events)\n   */\n  private updateProgress(_progress: number, _message: string): void {\n    // Progress is shown via status updates for now\n  }\n\n  /**\n   * Handle errors\n   */\n  private handleError(error: Error): void {\n    this.setState('error');\n    this.updateStatus(` Fehler: ${error.message}`, 'error');\n\n    notify.error(error.message, error);\n\n    // Reset button\n    if (this.startButton) {\n      this.startButton.textContent = ' Maschine prfen';\n      this.startButton.disabled = false;\n    }\n\n    this.onError?.(error);\n    logger.error('Level 2 Diagnose error:', error);\n  }\n\n  /**\n   * Set state and update button\n   */\n  private setState(state: DiagnosisState): void {\n    this.state = state;\n\n    if (this.startButton) {\n      this.startButton.disabled = state !== 'idle';\n\n      if (state === 'complete') {\n        this.startButton.textContent = ' Erneut prfen';\n        this.startButton.disabled = false;\n      }\n    }\n  }\n\n  /**\n   * Reload reference from storage\n   * Called when a new reference is created in Level2ReferencePhase\n   */\n  async reloadReference(): Promise<boolean> {\n    try {\n      this.setState('loading-reference');\n      this.updateStatus(' Lade neue Referenz...', 'loading');\n\n      const hasReference = await this.detector.loadReferenceFromStorage(this.machine.id);\n\n      if (hasReference) {\n        this.setState('idle');\n        this.updateStatus(' Neue Referenz geladen. Bereit fr Diagnose.', 'ready');\n        logger.info(' Level2DiagnosePhase: Reference reloaded successfully');\n        return true;\n      } else {\n        this.setState('no-reference');\n        this.updateStatus(' Keine Referenz vorhanden. Bitte zuerst Referenz erstellen.', 'warning');\n        return false;\n      }\n    } catch (error) {\n      logger.error(' Error reloading reference:', error);\n      this.handleError(error as Error);\n      return false;\n    }\n  }\n\n  /**\n   * Set completion callback\n   */\n  setOnComplete(callback: (result: Level2AnalysisResult) => void): void {\n    this.onComplete = callback;\n  }\n\n  /**\n   * Set error callback\n   */\n  setOnError(callback: (error: Error) => void): void {\n    this.onError = callback;\n  }\n\n  /**\n   * Get last result\n   */\n  getLastResult(): Level2AnalysisResult | null {\n    return this.lastResult;\n  }\n\n  /**\n   * Cleanup\n   *\n   * CRITICAL FIX: Always release audio stream to ensure microphone is available\n   * for other apps (e.g., phone calls). Previously, the stream was only stopped\n   * in MediaRecorder.onstop callback, which wouldn't be called if destroy()\n   * was invoked before recording started or completed.\n   */\n  destroy(): void {\n    if (this.mediaRecorder?.state === 'recording') {\n      this.mediaRecorder.stop();\n    }\n\n    // CRITICAL FIX: Always cleanup audio stream to release microphone\n    // This ensures phone calls work even if MediaRecorder.onstop wasn't triggered\n    this.cleanupAudioStream();\n\n    // Cleanup waterfall visualization\n    this.stopWaterfallVisualization();\n\n    // Cleanup camera stream\n    this.cleanupCameraStream();\n\n    this.detector.dispose();\n    this.container = null;\n    logger.info(' Level2DiagnosePhase destroyed');\n  }\n}\n","/**\n * ZANOBOT - ROUTER\n *\n * Simple state manager that controls the 4-phase flow:\n * Phase 1: Identify  Phase 2: Reference / Phase 3: Diagnose\n * Phase 4: Settings (always available, independent of machine selection)\n *\n * The user MUST select a machine (Phase 1) before accessing Phase 2 or 3.\n *\n * DETECTION MODE SUPPORT:\n * - STATIONARY (Level 1): Uses GMIA analysis (ReferencePhase, DiagnosePhase)\n * - CYCLIC (Level 2): Uses YAMNet ML analysis (Level2ReferencePhase, Level2DiagnosePhase)\n */\n\nimport { IdentifyPhase } from './phases/1-Identify.js';\nimport { ReferencePhase } from './phases/2-Reference.js';\nimport { DiagnosePhase } from './phases/3-Diagnose.js';\nimport { SettingsPhase } from './phases/4-Settings.js';\nimport { Level2ReferencePhase } from './phases/Level2-Reference.js';\nimport { Level2DiagnosePhase } from './phases/Level2-Diagnose.js';\nimport { getDetectionModeManager } from '@core/detection-mode.js';\nimport type { DetectionMode } from '@data/types.js';\nimport type { Machine } from '@data/types.js';\nimport { logger } from '@utils/logger.js';\n\nexport class Router {\n  private currentMachine: Machine | null = null;\n  private identifyPhase: IdentifyPhase;\n  private settingsPhase: SettingsPhase;\n\n  // Level 1 (GMIA) phases\n  private referencePhase: ReferencePhase | null = null;\n  private diagnosePhase: DiagnosePhase | null = null;\n\n  // Level 2 (YAMNet) phases\n  private level2ReferencePhase: Level2ReferencePhase | null = null;\n  private level2DiagnosePhase: Level2DiagnosePhase | null = null;\n\n  // Mode management\n  private modeManager = getDetectionModeManager();\n  private unsubscribeModeChange?: () => void;\n\n  constructor() {\n    // Initialize Phase 1 (always available)\n    this.identifyPhase = new IdentifyPhase((machine) => this.onMachineSelected(machine));\n    this.identifyPhase.init();\n\n    // Initialize Phase 4 (Settings - always available, independent of machine selection)\n    this.settingsPhase = new SettingsPhase();\n    this.settingsPhase.init();\n\n    // Lock Phase 2 and 3 initially\n    this.lockPhases();\n\n    // Set initial mode visibility\n    this.updateModeVisibility(this.modeManager.getMode());\n\n    // Subscribe to mode changes\n    this.unsubscribeModeChange = this.modeManager.onModeChange((newMode, oldMode) => {\n      logger.info(` Detection mode changed: ${oldMode}  ${newMode}`);\n      this.handleModeChange(newMode);\n    });\n  }\n\n  /**\n   * Called when a machine is selected in Phase 1\n   */\n  private onMachineSelected(machine: Machine): void {\n    logger.info(` Machine selected: ${machine.name} (${machine.id})`);\n\n    // DEBUG LOGGING: Show selected machine details\n    logger.debug(' Machine Selection Debug:', {\n      machineId: machine.id,\n      machineName: machine.name,\n      createdAt: new Date(machine.createdAt).toLocaleString(),\n      numModels: machine.referenceModels?.length || 0,\n      models: machine.referenceModels?.map(m => ({\n        label: m.label,\n        trainingDate: new Date(m.trainingDate).toLocaleString(),\n        weightMagnitude: m.metadata?.weightMagnitude?.toFixed(6) || 'N/A',\n      })) || [],\n    });\n\n    // Stop any active IdentifyPhase resources (e.g., temporary microphone streams)\n    this.identifyPhase.cleanup();\n\n    this.currentMachine = machine;\n\n    // Update UI to show selected machine\n    this.updateMachineDisplay(machine);\n\n    // Unlock Phase 2 and 3\n    this.unlockPhases();\n\n    // Collapse the machine selection container after successful selection\n    this.collapseSection('select-machine-content');\n\n    // Initialize Phase 2 and 3 with the selected machine\n    this.initializePhases(machine);\n  }\n\n  /**\n   * Initialize Phase 2 (Reference) and Phase 3 (Diagnose)\n   * Initializes the appropriate phases based on current detection mode.\n   */\n  private initializePhases(machine: Machine): void {\n    // Cleanup all previous instances with error handling\n    this.cleanupAllPhases();\n\n    // Get selected microphone device ID from Phase 1\n    const selectedDeviceId = this.identifyPhase.getSelectedDeviceId();\n    logger.info(` Using microphone device: ${selectedDeviceId || 'default'}`);\n\n    const currentMode = this.modeManager.getMode();\n    logger.info(` Initializing phases for mode: ${currentMode}`);\n\n    if (currentMode === 'STATIONARY') {\n      // Level 1: GMIA analysis\n      this.initializeLevel1Phases(machine, selectedDeviceId);\n    } else {\n      // Level 2: YAMNet ML analysis\n      this.initializeLevel2Phases(machine, selectedDeviceId);\n    }\n\n    // Update mode visibility in UI\n    this.updateModeVisibility(currentMode);\n  }\n\n  /**\n   * Initialize Level 1 (GMIA) phases\n   */\n  private initializeLevel1Phases(machine: Machine, selectedDeviceId?: string): void {\n    logger.info(' Initializing Level 1 (GMIA) phases');\n\n    // Create Level 1 instances\n    this.referencePhase = new ReferencePhase(machine, selectedDeviceId);\n    this.referencePhase.init();\n\n    this.diagnosePhase = new DiagnosePhase(machine, selectedDeviceId);\n    this.diagnosePhase.init();\n\n    // Register callback to update UI when reference model is saved\n    this.referencePhase.setOnMachineUpdated((updatedMachine) => {\n      if (this.diagnosePhase) {\n        this.diagnosePhase.setMachine(updatedMachine);\n      }\n      this.updateMachineDisplay(updatedMachine);\n    });\n  }\n\n  /**\n   * Initialize Level 2 (YAMNet ML) phases\n   */\n  private async initializeLevel2Phases(machine: Machine, selectedDeviceId?: string): Promise<void> {\n    logger.info(' Initializing Level 2 (YAMNet) phases');\n\n    // Create Level 2 instances\n    this.level2ReferencePhase = new Level2ReferencePhase(machine, selectedDeviceId);\n    this.level2DiagnosePhase = new Level2DiagnosePhase(machine, selectedDeviceId);\n\n    // Render into containers\n    this.level2ReferencePhase.render('level2-reference-container');\n    this.level2DiagnosePhase.render('level2-diagnose-container');\n\n    // CRITICAL: Register callback to update diagnose phase when reference is created\n    // This ensures the diagnose phase reloads the reference after training\n    this.level2ReferencePhase.setOnComplete(async () => {\n      logger.info(' Level 2 reference created, reloading in diagnose phase...');\n      if (this.level2DiagnosePhase) {\n        await this.level2DiagnosePhase.reloadReference();\n      }\n    });\n\n    // Initialize ML models asynchronously\n    try {\n      await Promise.all([\n        this.level2ReferencePhase.initialize(),\n        this.level2DiagnosePhase.initialize(),\n      ]);\n      logger.info(' Level 2 phases initialized successfully');\n    } catch (error) {\n      logger.error(' Error initializing Level 2 phases:', error);\n    }\n  }\n\n  /**\n   * Cleanup all phase instances\n   */\n  private cleanupAllPhases(): void {\n    // Cleanup Level 1 phases\n    if (this.referencePhase) {\n      try {\n        this.referencePhase.destroy();\n      } catch (error) {\n        logger.warn(' Error destroying reference phase:', error);\n      }\n      this.referencePhase = null;\n    }\n    if (this.diagnosePhase) {\n      try {\n        this.diagnosePhase.destroy();\n      } catch (error) {\n        logger.warn(' Error destroying diagnose phase:', error);\n      }\n      this.diagnosePhase = null;\n    }\n\n    // Cleanup Level 2 phases\n    if (this.level2ReferencePhase) {\n      try {\n        this.level2ReferencePhase.destroy();\n      } catch (error) {\n        logger.warn(' Error destroying Level 2 reference phase:', error);\n      }\n      this.level2ReferencePhase = null;\n    }\n    if (this.level2DiagnosePhase) {\n      try {\n        this.level2DiagnosePhase.destroy();\n      } catch (error) {\n        logger.warn(' Error destroying Level 2 diagnose phase:', error);\n      }\n      this.level2DiagnosePhase = null;\n    }\n  }\n\n  /**\n   * Handle detection mode change\n   * Reinitializes phases for the new mode if a machine is selected.\n   */\n  private handleModeChange(newMode: DetectionMode): void {\n    // Update visibility first\n    this.updateModeVisibility(newMode);\n\n    // If a machine is selected, reinitialize phases for the new mode\n    if (this.currentMachine) {\n      this.initializePhases(this.currentMachine);\n    }\n  }\n\n  /**\n   * Update UI visibility based on detection mode\n   */\n  private updateModeVisibility(mode: DetectionMode): void {\n    // Set mode attribute on body for CSS-based visibility\n    document.body.setAttribute('data-detection-mode', mode);\n\n    // Update visibility of mode-specific containers\n    const level1Contents = document.querySelectorAll('[data-detection-mode=\"STATIONARY\"]');\n    const level2Contents = document.querySelectorAll('[data-detection-mode=\"CYCLIC\"]');\n\n    level1Contents.forEach((el) => {\n      (el as HTMLElement).style.display = mode === 'STATIONARY' ? '' : 'none';\n    });\n\n    level2Contents.forEach((el) => {\n      (el as HTMLElement).style.display = mode === 'CYCLIC' ? '' : 'none';\n    });\n\n    logger.debug(`Mode visibility updated: ${mode}`);\n  }\n\n  /**\n   * Lock Phase 2 and 3 (disable buttons)\n   */\n  private lockPhases(): void {\n    this.setPhaseState('record-reference-content', false);\n    this.setPhaseState('run-diagnosis-content', false);\n  }\n\n  /**\n   * Unlock Phase 2 and 3 (enable buttons)\n   */\n  private unlockPhases(): void {\n    this.setPhaseState('record-reference-content', true);\n    this.setPhaseState('run-diagnosis-content', true);\n  }\n\n  /**\n   * Enable/disable a phase section\n   */\n  private setPhaseState(sectionId: string, enabled: boolean): void {\n    const section = document.getElementById(sectionId);\n    if (!section) return;\n\n    const buttons = section.querySelectorAll('button');\n    buttons.forEach((btn) => {\n      btn.disabled = !enabled;\n      btn.style.opacity = enabled ? '1' : '0.5';\n      btn.style.cursor = enabled ? 'pointer' : 'not-allowed';\n    });\n  }\n\n  /**\n   * Update UI to display selected machine info\n   */\n  private updateMachineDisplay(machine: Machine): void {\n    // Update user name in header\n    const userName = document.getElementById('user-name');\n    if (userName) {\n      userName.textContent = machine.name;\n    }\n\n    // Show reference status (MULTICLASS)\n    const recordSection = document.getElementById('record-reference-content');\n    if (recordSection) {\n      const description = recordSection.querySelector('.sub-description');\n      if (description) {\n        if (machine.referenceModels && machine.referenceModels.length > 0) {\n          const count = machine.referenceModels.length;\n          // CRITICAL FIX: Sort by trainingDate with defensive fallback for missing dates\n          // This prevents crashes if any model has undefined/null trainingDate\n          const sortedModels = [...machine.referenceModels].sort(\n            (a, b) => (b.trainingDate || 0) - (a.trainingDate || 0)\n          );\n          // CRITICAL FIX: Use toLocaleString() instead of toLocaleDateString() to include time\n          const latestTimestamp = sortedModels[0]?.trainingDate;\n          const latestDate = latestTimestamp\n            ? new Date(latestTimestamp).toLocaleString('de-DE', {\n                day: '2-digit',\n                month: '2-digit',\n                year: 'numeric',\n                hour: '2-digit',\n                minute: '2-digit',\n              })\n            : 'unbekannt';\n          description.textContent = `${count} Zustand${count > 1 ? 'e' : ''} trainiert (zuletzt: ${latestDate}) - Weitere hinzufgen`;\n        } else {\n          description.textContent = '10-Sekunden Referenzaufnahme (Erforderlich fr Diagnose)';\n        }\n      }\n    }\n\n    // Show/hide diagnosis availability\n    const diagnoseSection = document.getElementById('run-diagnosis-content');\n    if (diagnoseSection) {\n      const description = diagnoseSection.querySelector('.sub-description');\n      if (description) {\n        if (machine.referenceModels && machine.referenceModels.length > 0) {\n          description.textContent = 'Live-Analyse durchfhren';\n        } else {\n          description.textContent = ' Bitte erst Referenz aufnehmen';\n        }\n      }\n    }\n  }\n\n  /**\n   * Collapse a collapsible section by content ID\n   */\n  private collapseSection(sectionId: string): void {\n    const content = document.getElementById(sectionId);\n    if (!content) {\n      return;\n    }\n\n    if (!content.dataset.originalDisplay) {\n      const computedStyle = window.getComputedStyle(content);\n      content.dataset.originalDisplay = computedStyle.display;\n    }\n\n    const computedDisplay = window.getComputedStyle(content).display;\n    if (computedDisplay !== 'none') {\n      content.style.display = 'none';\n    }\n\n    const header = document.querySelector(`.section-header[data-target=\"${sectionId}\"]`);\n    const icon = header?.querySelector('.collapse-icon');\n    if (icon) {\n      icon.classList.remove('rotated');\n    }\n  }\n}\n","/**\n * ZANOBOT - GLOBAL ERROR BOUNDARY\n *\n * Provides global error handling for uncaught errors and unhandled promise rejections.\n * Displays user-friendly error messages and logs technical details for debugging.\n */\n\nimport { logger } from './logger.js';\nimport { notify } from './notifications.js';\n\n/**\n * Error boundary configuration\n */\ninterface ErrorBoundaryConfig {\n  /**\n   * Show error details to user (useful for development)\n   */\n  showDetails: boolean;\n  /**\n   * Callback for custom error handling\n   */\n  onError?: (error: Error, errorInfo: { type: 'error' | 'rejection'; timestamp: number }) => void;\n}\n\n/**\n * Default configuration\n */\nconst defaultConfig: ErrorBoundaryConfig = {\n  showDetails: import.meta.env.DEV || import.meta.env.MODE === 'development',\n};\n\n/**\n * Global error boundary class\n */\nclass ErrorBoundary {\n  private config: ErrorBoundaryConfig;\n  private isInitialized = false;\n  private errorHandler: ((event: ErrorEvent) => void) | null = null;\n  private rejectionHandler: ((event: PromiseRejectionEvent) => void) | null = null;\n\n  constructor(config?: Partial<ErrorBoundaryConfig>) {\n    this.config = { ...defaultConfig, ...config };\n  }\n\n  /**\n   * Initialize error boundary\n   */\n  public init(): void {\n    if (this.isInitialized) {\n      logger.warn('Error boundary already initialized');\n      return;\n    }\n\n    // Handle uncaught errors\n    this.errorHandler = (event: ErrorEvent) => {\n      this.handleError(event.error || new Error(event.message), 'error');\n      event.preventDefault(); // Prevent default browser error handling\n    };\n    window.addEventListener('error', this.errorHandler);\n\n    // Handle unhandled promise rejections\n    this.rejectionHandler = (event: PromiseRejectionEvent) => {\n      const error = event.reason instanceof Error ? event.reason : new Error(String(event.reason));\n      this.handleError(error, 'rejection');\n      event.preventDefault(); // Prevent default browser rejection handling\n    };\n    window.addEventListener('unhandledrejection', this.rejectionHandler);\n\n    this.isInitialized = true;\n    logger.info(' Error boundary initialized');\n  }\n\n  /**\n   * Destroy error boundary and cleanup listeners\n   */\n  public destroy(): void {\n    if (!this.isInitialized) {\n      return;\n    }\n\n    if (this.errorHandler) {\n      window.removeEventListener('error', this.errorHandler);\n      this.errorHandler = null;\n    }\n\n    if (this.rejectionHandler) {\n      window.removeEventListener('unhandledrejection', this.rejectionHandler);\n      this.rejectionHandler = null;\n    }\n\n    this.isInitialized = false;\n    logger.info('Error boundary destroyed');\n  }\n\n  /**\n   * Handle error\n   */\n  private handleError(error: Error, type: 'error' | 'rejection'): void {\n    const timestamp = Date.now();\n    const errorInfo = { type, timestamp };\n\n    // Log error\n    logger.error(`Uncaught ${type}:`, error);\n\n    // Call custom error handler if provided\n    if (this.config.onError) {\n      try {\n        this.config.onError(error, errorInfo);\n      } catch (handlerError) {\n        logger.error('Error in custom error handler:', handlerError);\n      }\n    }\n\n    // Show user-friendly error message\n    this.showErrorMessage(error);\n  }\n\n  /**\n   * Show user-friendly error message\n   */\n  private showErrorMessage(error: Error): void {\n    let message = 'Ein unerwarteter Fehler ist aufgetreten.';\n    let hint = '';\n\n    // Check for common error types and provide helpful messages\n    if (error.name === 'NotAllowedError' || error.message.includes('Permission')) {\n      message = 'Zugriff verweigert';\n      hint = 'Bitte erlauben Sie den Zugriff auf Mikrofon/Kamera in Ihren Browser-Einstellungen.';\n    } else if (error.name === 'NotFoundError') {\n      message = 'Hardware nicht gefunden';\n      hint = 'Bitte stellen Sie sicher, dass Ihr Mikrofon/Kamera angeschlossen ist.';\n    } else if (error.name === 'QuotaExceededError') {\n      message = 'Speicherplatz voll';\n      hint = 'Bitte lschen Sie alte Diagnosen oder Referenzaufnahmen.';\n    } else if (error.message.includes('Network')) {\n      message = 'Netzwerkfehler';\n      hint = 'Bitte berprfen Sie Ihre Internetverbindung.';\n    } else if (error.message.includes('AudioContext')) {\n      message = 'Audio-System-Fehler';\n      hint = 'Bitte laden Sie die Seite neu. Falls das Problem weiterhin besteht, verwenden Sie einen aktuellen Browser.';\n    }\n\n    // Prepare error details for development mode\n    const details = this.config.showDetails\n      ? `\\n\\nTechnische Details:\\n${error.name}: ${error.message}\\n${error.stack || 'Kein Stack Trace verfgbar'}`\n      : '';\n\n    // Show notification with error\n    notify.error(\n      `${message}\\n\\n${hint}${details}`,\n      error,\n      {\n        title: 'Unerwarteter Fehler',\n        duration: 0, // Don't auto-dismiss\n      }\n    );\n  }\n\n  /**\n   * Update configuration\n   */\n  public configure(config: Partial<ErrorBoundaryConfig>): void {\n    this.config = { ...this.config, ...config };\n  }\n}\n\n/**\n * Global error boundary instance\n */\nexport const errorBoundary = new ErrorBoundary();\n\n/**\n * Initialize error boundary with optional config\n */\nexport function initErrorBoundary(config?: Partial<ErrorBoundaryConfig>): void {\n  if (config) {\n    errorBoundary.configure(config);\n  }\n  errorBoundary.init();\n}\n\n/**\n * Destroy error boundary\n */\nexport function destroyErrorBoundary(): void {\n  errorBoundary.destroy();\n}\n","/**\n * ZANOBOT - View Level Settings\n *\n * Manages the User Experience View Level system:\n * - basic: Simple \"traffic light\" interface for operators\n * - advanced: Additional details for supervisors/maintenance staff\n * - expert: Full technical details for engineers\n *\n * Follows the same pattern as visualizerSettings.ts\n */\n\nexport type ViewLevel = 'basic' | 'advanced' | 'expert';\n\nexport const VIEW_LEVEL_EVENT = 'zanobot:view-level-change';\n\nconst STORAGE_KEY = 'zanobot.view-level';\n\nconst defaultLevel: ViewLevel = 'basic';\n\n/**\n * Valid view levels for validation\n */\nconst validLevels: ViewLevel[] = ['basic', 'advanced', 'expert'];\n\n/**\n * Display names for each view level (German)\n */\nexport const viewLevelDisplayNames: Record<ViewLevel, string> = {\n  basic: 'Basis',\n  advanced: 'Fortgeschritten',\n  expert: 'Experte',\n};\n\n/**\n * Descriptions for each view level (German)\n */\nexport const viewLevelDescriptions: Record<ViewLevel, string> = {\n  basic: 'Einfache Ampel-Anzeige fr Bediener',\n  advanced: 'Details fr Vorarbeiter & Instandhalter',\n  expert: 'Volle technische Ansicht fr Ingenieure',\n};\n\n/**\n * Read view level from localStorage\n */\nconst readFromStorage = (): ViewLevel => {\n  try {\n    const raw = localStorage.getItem(STORAGE_KEY);\n    if (!raw) {\n      return defaultLevel;\n    }\n    // Validate the stored value\n    if (validLevels.includes(raw as ViewLevel)) {\n      return raw as ViewLevel;\n    }\n    return defaultLevel;\n  } catch {\n    return defaultLevel;\n  }\n};\n\n/**\n * Get the current view level\n */\nexport const getViewLevel = (): ViewLevel => readFromStorage();\n\n/**\n * Set the view level and persist to localStorage\n * Also updates the data attribute on the HTML element\n */\nexport const setViewLevel = (level: ViewLevel): ViewLevel => {\n  // Validate the level\n  if (!validLevels.includes(level)) {\n    level = defaultLevel;\n  }\n\n  // Persist to localStorage\n  try {\n    localStorage.setItem(STORAGE_KEY, level);\n  } catch {\n    // Ignore storage errors (e.g., private mode)\n  }\n\n  // Update the data attribute on the HTML element\n  document.documentElement.setAttribute('data-view-level', level);\n\n  // Dispatch custom event for reactive updates\n  window.dispatchEvent(\n    new CustomEvent<ViewLevel>(VIEW_LEVEL_EVENT, { detail: level })\n  );\n\n  return level;\n};\n\n/**\n * Apply the saved view level to the document\n * Should be called on app initialization\n */\nexport const applyViewLevel = (): ViewLevel => {\n  const level = readFromStorage();\n  document.documentElement.setAttribute('data-view-level', level);\n  return level;\n};\n\n/**\n * Get all available view levels\n */\nexport const getAvailableViewLevels = (): ViewLevel[] => [...validLevels];\n","/**\n * ZANOBOT - MAIN APPLICATION ENTRY POINT\n *\n * Initializes the entire app:\n * - Database\n * - Router (3-phase flow)\n * - UI interactions\n * - PWA service worker\n */\n\nimport { initDB, getDBStats } from '@data/db.js';\nimport { Router } from '@ui/router.js';\nimport { notify } from '@utils/notifications.js';\nimport { logger } from '@utils/logger.js';\nimport { initErrorBoundary } from '@utils/errorBoundary.js';\nimport {\n  applyViewLevel,\n  setViewLevel,\n  getViewLevel,\n  type ViewLevel,\n} from '@utils/viewLevelSettings.js';\n\n/**\n * Global type declarations for theme-bootstrap.js API\n */\ndeclare global {\n  interface Window {\n    ZanobotTheme?: {\n      setTheme: (theme: string) => void;\n      getTheme: () => string;\n      toggleTheme: () => string;\n      getAvailableThemes: () => string[];\n      getThemeDisplayName: (theme: string) => string;\n      getThemeDescription: (theme: string) => string;\n      applyCustomColors: (colors: Record<string, string>) => void;\n      reset: () => void;\n    };\n    ZANOBOT_CONFIG?: Record<string, unknown>;\n  }\n}\n\nclass ZanobotApp {\n  private router: Router | null = null;\n\n  constructor() {\n    this.init();\n  }\n\n  /**\n   * Initialize application\n   */\n  private async init(): Promise<void> {\n    // Initialize error boundary first to catch any errors during initialization\n    initErrorBoundary({\n      showDetails: import.meta.env.DEV || import.meta.env.MODE === 'development',\n    });\n\n    logger.info(' Zanobo AI Assistant starting...');\n    logger.info('   Version: 2.0.0 (GMIA Algorithm)');\n\n    // CRITICAL FIX: Wait for DOM with enhanced race condition protection\n    // Double-check pattern prevents edge case where event fires between check and listener registration\n    if (document.readyState === 'loading') {\n      await new Promise<void>((resolve) => {\n        let resolved = false;\n\n        // Handler to resolve promise (with guard against multiple calls)\n        const handler = () => {\n          if (!resolved) {\n            resolved = true;\n            resolve();\n          }\n        };\n\n        // Set up listener with once: true to ensure it only fires once\n        document.addEventListener('DOMContentLoaded', handler, { once: true });\n\n        // RACE CONDITION FIX: Re-check state after adding listener\n        // If DOM loaded between initial check and listener registration, manually resolve\n        if (document.readyState !== 'loading') {\n          document.removeEventListener('DOMContentLoaded', handler);\n          handler();\n        }\n\n        // SAFETY NET: Timeout to ensure promise resolves even in edge cases\n        // If DOM is ready but event somehow didn't fire, resolve after 100ms\n        setTimeout(() => {\n          if (!resolved && document.readyState !== 'loading') {\n            logger.warn(' DOM ready but DOMContentLoaded did not fire, proceeding anyway');\n            handler();\n          }\n        }, 100);\n      });\n    }\n\n    // Always call setup after DOM is ready\n    await this.setup();\n  }\n\n  /**\n   * Check browser compatibility before app initialization\n   *\n   * CRITICAL FIX: Check all required features upfront instead of discovering\n   * incompatibility when user tries to use them\n   *\n   * @returns Compatibility check result with missing features list\n   */\n  private checkBrowserCompatibility(): { isCompatible: boolean; missing: string[] } {\n    const missing: string[] = [];\n\n    // Check Web Audio API\n    const hasAudioContext = typeof AudioContext !== 'undefined' ||\n      typeof (window as typeof window & { webkitAudioContext?: typeof AudioContext }).webkitAudioContext !== 'undefined';\n    if (!hasAudioContext) {\n      missing.push('- Web Audio API (required for audio processing)');\n    }\n\n    // Check MediaRecorder API\n    if (typeof MediaRecorder === 'undefined') {\n      missing.push('- MediaRecorder API (required for audio recording)');\n    }\n\n    // Check IndexedDB\n    if (typeof indexedDB === 'undefined') {\n      missing.push('- IndexedDB (required for data storage)');\n    }\n\n    // Check AudioWorklet support (needed for real-time diagnosis)\n    try {\n      if (typeof AudioContext !== 'undefined' && !('audioWorklet' in AudioContext.prototype)) {\n        missing.push('- AudioWorklet (required for real-time diagnosis)');\n      }\n    } catch (e) {\n      // AudioContext might not be available, already caught above\n    }\n\n    return {\n      isCompatible: missing.length === 0,\n      missing\n    };\n  }\n\n  /**\n   * Setup application after DOM is ready\n   *\n   * CRITICAL FIX: Graceful degradation - UI initializes even if database fails\n   * This ensures buttons and event listeners are set up regardless of DB status\n   */\n  private async setup(): Promise<void> {\n    // CRITICAL FIX: Check browser compatibility FIRST before any initialization\n    const compatibility = this.checkBrowserCompatibility();\n\n    if (!compatibility.isCompatible) {\n      logger.error(' Browser compatibility check failed');\n      logger.error('   Missing features:');\n      compatibility.missing.forEach(feature => logger.error(`   ${feature}`));\n\n      notify.error(\n        'Ihr Browser ist nicht kompatibel mit Zanobo.\\n\\n' +\n        'Fehlende Features:\\n' +\n        compatibility.missing.join('\\n') +\n        '\\n\\nBitte verwenden Sie einen modernen Browser wie Chrome, Edge, Firefox oder Safari.',\n        new Error('Browser incompatible'),\n        { title: 'Browser nicht untersttzt', duration: 0 }\n      );\n\n      // Don't initialize app if incompatible\n      return;\n    }\n\n    logger.info(' Browser compatibility check passed');\n\n    let dbAvailable = false;\n\n    // Initialize database (with graceful degradation)\n    try {\n      logger.info(' Initializing database...');\n      await initDB();\n\n      const stats = await getDBStats();\n      logger.info(`   Machines: ${stats.machines}`);\n      logger.info(`   Recordings: ${stats.recordings}`);\n      logger.info(`   Diagnoses: ${stats.diagnoses}`);\n      dbAvailable = true;\n    } catch (error) {\n      logger.error(' Database initialization failed:', error);\n      logger.warn(' Continuing without database - functionality will be limited');\n      notify.error(\n        'Datenbank nicht verfgbar. Bitte erlauben Sie IndexedDB in Ihren Browser-Einstellungen oder deaktivieren Sie den strikten Privacy-Modus.',\n        error as Error,\n        {\n          title: 'Datenbank-Fehler',\n          duration: 0,\n        }\n      );\n    }\n\n    // CRITICAL FIX: Always initialize UI components (even without database)\n    // This ensures buttons have event listeners and the app is interactive\n    try {\n      // Initialize router (3-phase flow)\n      logger.info(' Initializing router...');\n      this.router = new Router();\n\n      // Setup UI interactions\n      this.setupCollapsibleSections();\n      this.setupThemeSwitcher();\n      this.setupQuickThemeToggle();\n      this.setupViewLevelSelector();\n      this.setupFooterLinks();\n\n      // Note: Service Worker is automatically registered by VitePWA plugin\n      // See vite.config.ts and the auto-generated registerSW.js script\n\n      if (dbAvailable) {\n        logger.info(' Zanobo initialized successfully!');\n      } else {\n        logger.warn(' Zanobo initialized with limited functionality (no database)');\n        logger.warn('   Some features may not work correctly without database access');\n      }\n    } catch (error) {\n      logger.error(' UI initialization failed:', error);\n      notify.error('Benutzeroberflche konnte nicht geladen werden', error as Error, {\n        title: 'Schwerwiegender Fehler',\n        duration: 0,\n      });\n    }\n  }\n\n  /**\n   * Setup collapsible sections\n   *\n   * CRITICAL FIX: Preserve original display mode (flex, grid, etc.)\n   * instead of hardcoding 'block'. Also check computed style instead\n   * of only inline style to handle CSS-defined visibility.\n   *\n   * CRITICAL FIX: Added debouncing to prevent issues from rapid clicks\n   */\n  private setupCollapsibleSections(): void {\n    const headers = document.querySelectorAll('.section-header');\n    let isAnimating = false;\n    const updateCompactExpandedState = () => {\n      const contents = Array.from(\n        document.querySelectorAll<HTMLElement>('.collapsible-content')\n      );\n      const hasOpenSection = contents.some(\n        (content) => window.getComputedStyle(content).display !== 'none'\n      );\n      document.body.classList.toggle('compact-expanded', hasOpenSection);\n    };\n\n    headers.forEach((header) => {\n      header.addEventListener('click', () => {\n        // CRITICAL FIX: Debounce to prevent double-clicks causing UI issues\n        if (isAnimating) {\n          return;\n        }\n        isAnimating = true;\n\n        const target = header.getAttribute('data-target');\n        if (!target) {\n          isAnimating = false;\n          return;\n        }\n\n        const content = document.getElementById(target);\n        if (!content) {\n          isAnimating = false;\n          return;\n        }\n\n        // CRITICAL FIX: Store original display mode on first interaction\n        // This preserves flex, grid, or any other display value\n        if (!content.dataset.originalDisplay) {\n          const computedStyle = window.getComputedStyle(content);\n          content.dataset.originalDisplay = computedStyle.display;\n        }\n\n        // CRITICAL FIX: Check computed style instead of inline style\n        // This correctly handles CSS-defined visibility\n        const computedDisplay = window.getComputedStyle(content).display;\n        const isVisible = computedDisplay !== 'none';\n\n        // Toggle visibility while preserving original display mode\n        if (isVisible) {\n          content.style.display = 'none';\n        } else {\n          headers.forEach((otherHeader) => {\n            if (otherHeader === header) {\n              return;\n            }\n\n            const otherTarget = otherHeader.getAttribute('data-target');\n            if (!otherTarget) {\n              return;\n            }\n\n            const otherContent = document.getElementById(otherTarget);\n            if (!otherContent) {\n              return;\n            }\n\n            if (window.getComputedStyle(otherContent).display !== 'none') {\n              otherContent.style.display = 'none';\n            }\n\n            const otherIcon = otherHeader.querySelector('.collapse-icon');\n            if (otherIcon) {\n              otherIcon.classList.remove('rotated');\n            }\n          });\n\n          // CRITICAL FIX: Restore original display mode instead of hardcoding 'block'\n          const originalDisplay = content.dataset.originalDisplay;\n          content.style.display =\n            originalDisplay && originalDisplay !== 'none' ? originalDisplay : '';\n        }\n\n        // Rotate icon\n        const icon = header.querySelector('.collapse-icon');\n        if (icon) {\n          icon.classList.toggle('rotated');\n        }\n\n        updateCompactExpandedState();\n\n        // Reset debounce flag after animation completes (300ms matches CSS transition)\n        setTimeout(() => {\n          isAnimating = false;\n        }, 300);\n      });\n    });\n\n    updateCompactExpandedState();\n  }\n\n  /**\n   * Setup theme switcher\n   */\n  private setupThemeSwitcher(): void {\n    const themeBtns = document.querySelectorAll('.theme-card');\n\n    themeBtns.forEach((btn) => {\n      btn.addEventListener('click', () => {\n        const theme = btn.getAttribute('data-theme');\n        if (!theme) return;\n\n        // Apply theme\n        document.documentElement.setAttribute('data-theme', theme);\n\n        // Save to localStorage\n        localStorage.setItem('zanobot-theme', theme);\n\n        // Update active state\n        themeBtns.forEach((b) => b.classList.remove('active'));\n        btn.classList.add('active');\n      });\n    });\n\n    // Load saved theme\n    const savedTheme = localStorage.getItem('zanobot-theme') || 'brand';\n    document.documentElement.setAttribute('data-theme', savedTheme);\n\n    themeBtns.forEach((btn) => {\n      if (btn.getAttribute('data-theme') === savedTheme) {\n        btn.classList.add('active');\n      }\n    });\n  }\n\n  /**\n   * Setup quick theme toggle button (header)\n   */\n  private setupQuickThemeToggle(): void {\n    const quickToggleBtns = Array.from(\n      document.querySelectorAll<HTMLElement>('.quick-theme-toggle')\n    );\n    const legacyToggleBtn = document.getElementById('quick-theme-toggle');\n    if (legacyToggleBtn && !quickToggleBtns.includes(legacyToggleBtn)) {\n      quickToggleBtns.push(legacyToggleBtn);\n    }\n\n    quickToggleBtns.forEach((btn) => {\n      btn.addEventListener('click', () => {\n        // Use the global ZanobotTheme API from theme-bootstrap.js\n        if (window.ZanobotTheme?.toggleTheme) {\n          window.ZanobotTheme.toggleTheme();\n          logger.debug(' Theme toggled via quick toggle button');\n        }\n      });\n    });\n  }\n\n  /**\n   * Setup view level selector (Basic / Advanced / Expert)\n   *\n   * This controls the UI complexity based on user preference.\n   * The view level is persisted in localStorage.\n   */\n  private setupViewLevelSelector(): void {\n    // Apply saved view level on startup\n    const savedLevel = applyViewLevel();\n    logger.info(` View level set to: ${savedLevel}`);\n\n    // Get all view level buttons\n    const viewLevelBtns = document.querySelectorAll<HTMLButtonElement>(\n      '.view-level-btn[data-level]'\n    );\n\n    // Set initial active state\n    viewLevelBtns.forEach((btn) => {\n      const level = btn.getAttribute('data-level') as ViewLevel;\n      if (level === savedLevel) {\n        btn.classList.add('active');\n      } else {\n        btn.classList.remove('active');\n      }\n    });\n\n    // Add click handlers\n    viewLevelBtns.forEach((btn) => {\n      btn.addEventListener('click', () => {\n        const level = btn.getAttribute('data-level') as ViewLevel;\n        if (!level) return;\n\n        // Apply the new view level\n        setViewLevel(level);\n        logger.debug(` View level changed to: ${level}`);\n\n        // Update active state on all buttons\n        viewLevelBtns.forEach((b) => {\n          if (b.getAttribute('data-level') === level) {\n            b.classList.add('active');\n          } else {\n            b.classList.remove('active');\n          }\n        });\n      });\n    });\n  }\n\n  /**\n   * Setup footer links (Impressum, Datenschutz, ber Zanobot)\n   */\n  private setupFooterLinks(): void {\n    // Helper function to close a modal\n    const closeModal = (modal: HTMLElement) => {\n      modal.style.display = 'none';\n    };\n\n    // Helper function to open a modal\n    const openModal = (modal: HTMLElement) => {\n      modal.style.display = 'flex';\n    };\n\n    // Impressum modal\n    const impressumBtn = document.getElementById('impressum-btn');\n    const impressumModal = document.getElementById('impressum-modal');\n    const closeImpressumModal = document.getElementById('close-impressum-modal');\n    const closeImpressumBtn = document.getElementById('close-impressum-btn');\n\n    if (impressumBtn && impressumModal) {\n      impressumBtn.addEventListener('click', () => openModal(impressumModal));\n    }\n\n    if (closeImpressumModal && impressumModal) {\n      closeImpressumModal.addEventListener('click', () => closeModal(impressumModal));\n    }\n\n    if (closeImpressumBtn && impressumModal) {\n      closeImpressumBtn.addEventListener('click', () => closeModal(impressumModal));\n    }\n\n    // Datenschutz modal\n    const datenschutzBtn = document.getElementById('datenschutz-btn');\n    const datenschutzModal = document.getElementById('datenschutz-modal');\n    const closeDatenschutzModal = document.getElementById('close-datenschutz-modal');\n    const closeDatenschutzBtn = document.getElementById('close-datenschutz-btn');\n\n    if (datenschutzBtn && datenschutzModal) {\n      datenschutzBtn.addEventListener('click', () => openModal(datenschutzModal));\n    }\n\n    if (closeDatenschutzModal && datenschutzModal) {\n      closeDatenschutzModal.addEventListener('click', () => closeModal(datenschutzModal));\n    }\n\n    if (closeDatenschutzBtn && datenschutzModal) {\n      closeDatenschutzBtn.addEventListener('click', () => closeModal(datenschutzModal));\n    }\n\n    // ber Zanobot modal\n    const aboutBtn = document.getElementById('about-btn');\n    const aboutModal = document.getElementById('about-modal');\n    const closeAboutModal = document.getElementById('close-about-modal');\n    const closeAboutBtn = document.getElementById('close-about-btn');\n\n    if (aboutBtn && aboutModal) {\n      aboutBtn.addEventListener('click', () => openModal(aboutModal));\n    }\n\n    if (closeAboutModal && aboutModal) {\n      closeAboutModal.addEventListener('click', () => closeModal(aboutModal));\n    }\n\n    if (closeAboutBtn && aboutModal) {\n      closeAboutBtn.addEventListener('click', () => closeModal(aboutModal));\n    }\n\n    // Close modals on background click\n    [impressumModal, datenschutzModal, aboutModal].forEach((modal) => {\n      if (modal) {\n        modal.addEventListener('click', (e) => {\n          if (e.target === modal) {\n            closeModal(modal);\n          }\n        });\n      }\n    });\n\n    // Close modals with Escape key\n    document.addEventListener('keydown', (e) => {\n      if (e.key === 'Escape') {\n        [impressumModal, datenschutzModal, aboutModal].forEach((modal) => {\n          if (modal && window.getComputedStyle(modal).display !== 'none') {\n            closeModal(modal);\n          }\n        });\n      }\n    });\n  }\n\n  /**\n   * Note: Service Worker registration is handled automatically by VitePWA plugin\n   *\n   * The VitePWA plugin (vite.config.ts) automatically:\n   * - Generates service-worker.js with Workbox\n   * - Creates registerSW.js registration script\n   * - Injects the script tag into index.html\n   * - Handles correct base path (/Zanobot/) and scope\n   *\n   * No manual registration needed here to avoid conflicts.\n   */\n}\n\n// Start the app\nnew ZanobotApp();\n"],"file":"assets/index-B89Mh_RT.js"}