var u=Object.defineProperty;var p=(e,t,a)=>t in e?u(e,t,{enumerable:!0,configurable:!0,writable:!0,value:a}):e[t]=a;var l=(e,t,a)=>p(e,typeof t!="symbol"?t+"":t,a);import{o as w}from"./vendor-idb-DQ2Q1noU.js";const b=()=>({level:2,enableTimestamp:!0,enableStackTrace:!1});class y{constructor(t){l(this,"config");this.config={...b(),...t}}configure(t){this.config={...this.config,...t}}debug(t,...a){this.config.level<=0&&this.log("DEBUG",t,a,console.debug)}info(t,...a){this.config.level<=1&&this.log("INFO",t,a,console.log)}warn(t,...a){this.config.level<=2&&this.log("WARN",t,a,console.warn)}error(t,a,...i){if(this.config.level<=3){const n=a instanceof Error?a.message:String(a),o=a instanceof Error&&this.config.enableStackTrace?a.stack:void 0;this.log("ERROR",t,[n,...i],console.error),o&&console.error("Stack trace:",o)}}log(t,a,i,n){const o=this.config.enableTimestamp?new Date().toISOString():"",r=o?`[${o}] [${t}]`:`[${t}]`;i.length>0?n(r,a,...i):n(r,a)}}const s=new y,S="zanobot-db",I=5;let m=null;async function c(){return m||(m=await w(S,I,{upgrade(e,t,a,i){if(!e.objectStoreNames.contains("machines")){const n=e.createObjectStore("machines",{keyPath:"id"});n.createIndex("by-name","name"),n.createIndex("by-created","createdAt")}if(!e.objectStoreNames.contains("recordings")){const n=e.createObjectStore("recordings",{keyPath:"id"});n.createIndex("by-machine","machineId"),n.createIndex("by-timestamp","timestamp")}if(!e.objectStoreNames.contains("diagnoses")){const n=e.createObjectStore("diagnoses",{keyPath:"id"});n.createIndex("by-machine","machineId"),n.createIndex("by-timestamp","timestamp"),n.createIndex("by-machine-timestamp",["machineId","timestamp"]),n.createIndex("by-status","status")}if(e.objectStoreNames.contains("diagnoses")&&t<2){s.warn("ðŸ”„ Migrating diagnoses store from v1 to v2"),s.warn("   âš ï¸ Old diagnosis data will be lost due to schema change (keyPath: timestamp â†’ id)");try{e.deleteObjectStore("diagnoses");const n=e.createObjectStore("diagnoses",{keyPath:"id"});n.createIndex("by-machine","machineId"),n.createIndex("by-timestamp","timestamp"),n.createIndex("by-machine-timestamp",["machineId","timestamp"]),n.createIndex("by-status","status"),s.info("   âœ… Diagnoses store recreated with correct schema")}catch(n){if(s.error("   âŒ Migration error:",n),!e.objectStoreNames.contains("diagnoses")){const o=e.createObjectStore("diagnoses",{keyPath:"id"});o.createIndex("by-machine","machineId"),o.createIndex("by-timestamp","timestamp"),o.createIndex("by-machine-timestamp",["machineId","timestamp"]),o.createIndex("by-status","status")}}}if(t<3){s.warn("ðŸ”„ Migrating database from v2 to v3 (Multiclass Diagnosis)"),s.warn("   âš ï¸ BREAKING CHANGE: referenceModel â†’ referenceModels[]"),s.warn("   âš ï¸ All existing data will be cleared (machines, recordings, diagnoses)");try{localStorage.setItem("zanobot-migration-v3-occurred",JSON.stringify({timestamp:Date.now(),oldVersion:t,newVersion:3,dataCleared:!0}))}catch(n){s.error("   âŒ Could not save migration info to localStorage:",n)}try{const n=i.objectStore("machines"),o=i.objectStore("recordings"),r=i.objectStore("diagnoses");n.clear(),o.clear(),r.clear(),s.info("   âœ… Database reset complete - ready for multiclass diagnosis"),s.warn("   âš ï¸ IMPORTANT: All previous data has been deleted due to schema incompatibility"),s.warn("   â„¹ï¸ You will need to re-record reference audio for all machines")}catch(n){s.error("   âŒ Migration error:",n)}}if(t<4&&e.objectStoreNames.contains("diagnoses")){const n=i.objectStore("diagnoses");n.indexNames.contains("by-machine-timestamp")||(n.createIndex("by-machine-timestamp",["machineId","timestamp"]),s.info("   âœ… Added compound index: by-machine-timestamp"))}t<5&&(s.info("ðŸ”„ Migrating database from v4 to v5 (Visual Positioning Assistant)"),s.info("   âœ… Added optional referenceImage field to Machine schema"),s.info("   â„¹ï¸ Existing machines will work without changes (non-breaking)"))}}),s.info("âœ… Database initialized"),m)}async function M(e){await(await c()).put("machines",e),s.info(`ðŸ’¾ Machine saved: ${e.id}`)}async function D(e){return await(await c()).get("machines",e)}async function A(){return await(await c()).getAll("machines")}async function x(e,t){const a=await c(),i=await a.get("machines",e);if(!i)throw new Error(`Machine not found: ${e}`);i.referenceModels||(s.warn(`âš ï¸ Machine ${e} has no referenceModels array - initializing empty array`),i.referenceModels=[]),i.referenceModels.push(t),await a.put("machines",i),s.info(`ðŸ§  Model '${t.label}' added to machine: ${e}`)}async function v(e){const t=await c();await t.put("diagnoses",e);const a=await t.get("machines",e.machineId);a&&(a.lastDiagnosisAt=e.timestamp,await t.put("machines",a)),s.info(`ðŸ“Š Diagnosis saved for machine: ${e.machineId}`)}async function f(){const e=await c();await e.clear("machines"),await e.clear("recordings"),await e.clear("diagnoses"),s.info("ðŸ—‘ï¸ All data cleared")}async function O(){const e=await c(),t=await e.count("machines"),a=await e.count("recordings"),i=await e.count("diagnoses");return{machines:t,recordings:a,diagnoses:i}}function g(e){const t=[];for(let a=0;a<e.numberOfChannels;a++){const i=e.getChannelData(a);t.push(Array.from(i))}return{_serialized:!0,numberOfChannels:e.numberOfChannels,sampleRate:e.sampleRate,length:e.length,duration:e.duration,channelData:t}}async function N(){const e=await c(),a=(await e.getAll("machines")).map(r=>({...r,referenceModels:(r.referenceModels||[]).map(d=>({...d,weightVector:Array.from(d.weightVector)}))})),i=await e.getAll("recordings"),n=await e.getAll("diagnoses"),o=i.map(r=>h(r.audioBuffer)?r:{...r,audioBuffer:g(r.audioBuffer)});return s.info("ðŸ“¦ Data exported successfully"),{machines:a,recordings:o,diagnoses:n}}function h(e){return e!=null&&typeof e=="object"&&"_serialized"in e&&e._serialized===!0&&"numberOfChannels"in e&&typeof e.numberOfChannels=="number"&&"sampleRate"in e&&typeof e.sampleRate=="number"&&"length"in e&&typeof e.length=="number"&&"channelData"in e&&Array.isArray(e.channelData)}async function z(e,t=!1){const a=await c();if(t||(await f(),s.info("ðŸ—‘ï¸ Existing data cleared for import")),e.machines){for(const i of e.machines){const n={...i,referenceModels:(i.referenceModels||[]).map(o=>({...o,weightVector:o.weightVector instanceof Float64Array?o.weightVector:new Float64Array(o.weightVector)}))};await a.put("machines",n)}s.info(`ðŸ“¥ Imported ${e.machines.length} machines`)}if(e.recordings){for(const i of e.recordings){let n;h(i.audioBuffer)?n=i:n={...i,audioBuffer:g(i.audioBuffer)},await a.put("recordings",n)}s.info(`ðŸ“¥ Imported ${e.recordings.length} recordings`)}if(e.diagnoses){for(const i of e.diagnoses)await a.put("diagnoses",i);s.info(`ðŸ“¥ Imported ${e.diagnoses.length} diagnoses`)}s.info("âœ… Data import complete")}const $=Object.freeze(Object.defineProperty({__proto__:null,clearAllData:f,exportData:N,getAllMachines:A,getDBStats:O,getMachine:D,importData:z,initDB:c,saveDiagnosis:v,saveMachine:M,updateMachineModel:x},Symbol.toStringTag,{value:"Module"}));export{A as a,v as b,f as c,O as d,N as e,c as f,D as g,$ as h,z as i,s as l,M as s,x as u};
//# sourceMappingURL=data-CHglu3FA.js.map
